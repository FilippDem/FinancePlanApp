import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
import plotly.express as px
from plotly.subplots import make_subplots
import json
from datetime import datetime
import io
from dataclasses import dataclass, asdict
from typing import List, Dict, Optional, Any

# Set page configuration
st.set_page_config(
    page_title="Financial Planning Application V16",
    page_icon="ðŸ’°",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Base year for expense templates (all templates inflation-adjusted to this year)
EXPENSE_TEMPLATE_BASE_YEAR = 2024

# Historical S&P 500 Annual Returns (approximately 1924-2023, 100 years)
HISTORICAL_STOCK_RETURNS = [
    # 1924-1929 (Pre-Depression)
    0.26, 0.10, 0.11, 0.37, 0.48, 0.12,
    # 1930-1939 (Great Depression & Recovery)
    -0.25, -0.43, -0.08, 0.54, -0.01, 0.47, 0.34, -0.35, 0.31, -0.01,
    # 1940-1949 (WWII & Post-war)
    -0.10, -0.12, 0.20, 0.26, 0.19, 0.36, -0.08, 0.05, 0.05, 0.18,
    # 1950-1959 (Post-war Boom)
    0.31, 0.24, 0.18, -0.01, 0.52, 0.31, 0.06, -0.11, 0.43, 0.12,
    # 1960-1969 (Go-Go Years)
    0.00, 0.27, -0.09, 0.23, 0.16, 0.12, -0.10, 0.24, 0.11, -0.08,
    # 1970-1979 (Stagflation)
    0.04, 0.14, 0.19, -0.15, -0.26, 0.37, 0.24, -0.07, 0.07, 0.18,
    # 1980-1989 (Reagan Bull Market)
    0.32, -0.05, 0.21, 0.22, 0.06, 0.31, 0.18, 0.05, 0.16, 0.32,
    # 1990-1999 (Tech Boom)
    -0.03, 0.30, 0.08, 0.10, 0.01, 0.38, 0.23, 0.33, 0.29, 0.21,
    # 2000-2009 (Dot-com Crash & Financial Crisis)
    -0.09, -0.12, -0.22, 0.29, 0.11, 0.05, 0.16, 0.05, -0.37, 0.26,
    # 2010-2019 (Recovery & Bull Market)
    0.15, 0.02, 0.16, 0.32, 0.14, 0.01, 0.12, 0.22, -0.04, 0.32,
    # 2020-2023 (Recent years with COVID impact)
    0.18, 0.29, -0.18, 0.26
]

# Available locations for expense templates
# Note: CHILDREN_EXPENSE_TEMPLATES currently only includes US locations and original 3 states
# FAMILY_EXPENSE_TEMPLATES includes all locations below
AVAILABLE_LOCATIONS_CHILDREN = [
    # Major US Cities (with detailed children templates)
    "Seattle", "Sacramento", "Houston",
    "New York", "San Francisco", "Los Angeles", "Portland"
]

AVAILABLE_LOCATIONS_FAMILY = [
    # Major US Cities
    "Seattle", "Sacramento", "Houston",
    "New York", "San Francisco", "Los Angeles", "Portland",
    # Canada
    "Toronto", "Vancouver",
    # France
    "Paris", "Toulouse",
    # Germany
    "Berlin", "Munich",
    # Australia
    "Sydney", "Melbourne", "Brisbane"
]

# Display names for locations (includes country and state for USA cities)
LOCATION_DISPLAY_NAMES = {
    # USA
    "Seattle": "Seattle, WA, USA",
    "Sacramento": "Sacramento, CA, USA",
    "California": "California, USA",
    "Houston": "Houston, TX, USA",
    "New York": "New York, NY, USA",
    "San Francisco": "San Francisco, CA, USA",
    "Los Angeles": "Los Angeles, CA, USA",
    "Portland": "Portland, OR, USA",
    # Canada
    "Toronto": "Toronto, ON, Canada",
    "Vancouver": "Vancouver, BC, Canada",
    # France
    "Paris": "Paris, France",
    "Toulouse": "Toulouse, France",
    # Germany
    "Berlin": "Berlin, Germany",
    "Munich": "Munich, Germany",
    # Australia
    "Sydney": "Sydney, NSW, Australia",
    "Melbourne": "Melbourne, VIC, Australia",
    "Brisbane": "Brisbane, QLD, Australia"
}

# Geographic coordinates for world map visualization
LOCATION_COORDINATES = {
    # USA
    "Seattle": {"lat": 47.6062, "lon": -122.3321},
    "Sacramento": {"lat": 38.5816, "lon": -121.4944},
    "California": {"lat": 36.7783, "lon": -119.4179},  # Center of CA
    "Houston": {"lat": 29.7604, "lon": -95.3698},
    "New York": {"lat": 40.7128, "lon": -74.0060},
    "San Francisco": {"lat": 37.7749, "lon": -122.4194},
    "Los Angeles": {"lat": 34.0522, "lon": -118.2437},
    "Portland": {"lat": 45.5152, "lon": -122.6784},
    # Canada
    "Toronto": {"lat": 43.6532, "lon": -79.3832},
    "Vancouver": {"lat": 49.2827, "lon": -123.1207},
    # France
    "Paris": {"lat": 48.8566, "lon": 2.3522},
    "Toulouse": {"lat": 43.6047, "lon": 1.4442},
    # Germany
    "Berlin": {"lat": 52.5200, "lon": 13.4050},
    "Munich": {"lat": 48.1351, "lon": 11.5820},
    # Australia
    "Sydney": {"lat": -33.8688, "lon": 151.2093},
    "Melbourne": {"lat": -37.8136, "lon": 144.9631},
    "Brisbane": {"lat": -27.4698, "lon": 153.0251}
}

# [Keep all the CHILDREN_EXPENSE_TEMPLATES and FAMILY_EXPENSE_TEMPLATES from V14]
# [I'll include the full templates but truncate here for readability]

CHILDREN_EXPENSE_TEMPLATES = {
    "Sacramento": {
        "Conservative": {
            'Food': [1200, 1400, 1600, 1800, 2000, 2200, 2400, 2600, 2800, 3000, 3200, 3400, 3600, 3800, 4000, 4200,
                     4400, 4600, 2000, 1800, 1600, 1400, 1200, 1000, 800, 600, 400, 200, 100, 50, 0],
            'Clothing': [400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000, 1200, 1400, 1600, 1800, 2000,
                         800, 600, 400, 300, 250, 200, 150, 100, 50, 25, 0, 0, 0],
            'Healthcare': [800, 600, 500, 450, 400, 400, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950,
                           500, 400, 300, 250, 200, 150, 100, 75, 50, 25, 0, 0, 0],
            'Activities/Sports': [50, 100, 200, 400, 600, 800, 1000, 1200, 1400, 1600, 1800, 2000, 2200, 2400, 2600,
                                  2800, 3000, 3200, 600, 400, 300, 200, 150, 100, 50, 25, 0, 0, 0, 0, 0],
            'Entertainment': [100, 150, 200, 250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950,
                              400, 300, 200, 150, 100, 75, 50, 25, 0, 0, 0, 0, 0],
            'Transportation': [100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300, 320, 340, 500, 800, 1200, 1600,
                               2000, 600, 400, 300, 200, 150, 100, 50, 25, 0, 0, 0, 0, 0],
            'School Supplies': [25, 50, 100, 150, 200, 250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850,
                                200, 150, 100, 75, 50, 25, 0, 0, 0, 0, 0, 0, 0],
            'Gifts/Celebrations': [200, 250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000,
                                   1050, 600, 500, 400, 350, 300, 250, 200, 150, 100, 75, 50, 25, 0],
            'Miscellaneous': [150, 175, 200, 225, 250, 275, 300, 325, 350, 375, 400, 425, 450, 475, 500, 525, 550, 575,
                              400, 350, 300, 250, 200, 150, 100, 75, 50, 25, 0, 0, 0],
            'Daycare': [22000, 22000, 22000, 22000, 22000, 8000, 6000, 4000, 2000, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 28000, 28000, 28000, 28000, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        },
        "Average": {
            'Food': [1600, 1800, 2000, 2200, 2400, 2600, 2800, 3000, 3200, 3400, 3600, 3800, 4000, 4200, 4400, 4600,
                     4800, 5000, 2400, 2200, 2000, 1800, 1600, 1400, 1200, 1000, 800, 600, 400, 200, 0],
            'Clothing': [600, 650, 700, 750, 800, 850, 900, 950, 1000, 1050, 1100, 1150, 1200, 1400, 1600, 1800, 2000,
                         2200, 1200, 900, 700, 500, 400, 350, 300, 250, 200, 150, 100, 50, 0],
            'Healthcare': [1000, 800, 650, 600, 550, 550, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000, 1050, 1100,
                           700, 600, 500, 400, 350, 300, 250, 200, 150, 100, 50, 25, 0],
            'Activities/Sports': [100, 200, 400, 600, 800, 1000, 1200, 1400, 1600, 1800, 2000, 2200, 2400, 2600, 2800,
                                  3000, 3200, 3400, 1000, 700, 500, 400, 300, 250, 200, 150, 100, 50, 25, 0, 0],
            'Entertainment': [200, 250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000,
                              1050, 600, 500, 400, 300, 250, 200, 150, 100, 75, 50, 25, 0, 0],
            'Transportation': [150, 180, 210, 240, 270, 300, 330, 360, 390, 420, 450, 480, 510, 750, 1200, 1800, 2400,
                               3000, 900, 600, 450, 350, 300, 250, 200, 150, 100, 50, 25, 0, 0],
            'School Supplies': [50, 75, 150, 225, 300, 375, 450, 525, 600, 675, 750, 825, 900, 975, 1050, 1125, 1200,
                                1275, 300, 225, 150, 100, 75, 50, 25, 0, 0, 0, 0, 0, 0],
            'Gifts/Celebrations': [300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000, 1050,
                                   1100, 1150, 800, 700, 600, 500, 450, 400, 350, 300, 250, 200, 150, 100, 50],
            'Miscellaneous': [250, 275, 300, 325, 350, 375, 400, 425, 450, 475, 500, 525, 550, 575, 600, 625, 650, 675,
                              600, 500, 450, 400, 350, 300, 250, 200, 150, 100, 75, 50, 25],
            'Daycare': [26000, 26000, 26000, 26000, 26000, 12000, 9000, 6000, 3000, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 35000, 35000, 35000, 35000, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        },
        "High-end": {
            'Food': [2200, 2400, 2600, 2800, 3000, 3200, 3400, 3600, 3800, 4000, 4200, 4400, 4600, 4800, 5000, 5200,
                     5400, 5600, 3200, 3000, 2800, 2600, 2400, 2200, 2000, 1800, 1600, 1400, 1200, 1000, 500],
            'Clothing': [1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000, 2100, 2200, 2500, 2800, 3100,
                         3400, 3700, 2000, 1500, 1200, 1000, 800, 700, 600, 500, 400, 300, 200, 100, 50],
            'Healthcare': [1500, 1200, 1000, 900, 800, 800, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700,
                           1800, 1900, 1200, 1000, 800, 700, 600, 500, 400, 350, 300, 250, 200, 150, 100],
            'Activities/Sports': [200, 400, 800, 1200, 1600, 2000, 2400, 2800, 3200, 3600, 4000, 4400, 4800, 5200, 5600,
                                  6000, 6400, 6800, 2000, 1500, 1200, 1000, 800, 600, 500, 400, 300, 200, 100, 50, 0],
            'Entertainment': [400, 500, 600, 700, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900,
                              2000, 2100, 1200, 1000, 800, 600, 500, 400, 350, 300, 250, 200, 150, 100, 50],
            'Transportation': [250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 1200, 2000, 3000, 4000,
                               5000, 1500, 1000, 750, 600, 500, 400, 350, 300, 250, 200, 150, 100, 50],
            'School Supplies': [100, 150, 300, 450, 600, 750, 900, 1050, 1200, 1350, 1500, 1650, 1800, 1950, 2100, 2250,
                                2400, 2550, 500, 375, 300, 250, 200, 150, 100, 75, 50, 25, 0, 0, 0],
            'Gifts/Celebrations': [500, 600, 700, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900,
                                   2000, 2100, 2200, 1500, 1200, 1000, 800, 700, 600, 500, 450, 400, 350, 300, 250,
                                   200],
            'Miscellaneous': [400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000, 1050, 1100, 1150, 1200,
                              1250, 1000, 850, 750, 650, 600, 550, 500, 450, 400, 350, 300, 250, 200],
            'Daycare': [35000, 35000, 35000, 35000, 35000, 18000, 15000, 12000, 6000, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 55000, 55000, 55000, 55000, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        }
    },
    "Seattle": {
        "Conservative": {
            'Food': [1100, 1300, 1500, 1700, 1900, 2100, 2300, 2500, 2700, 2900, 3100, 3300, 3500, 3700, 3900, 4100,
                     4300, 4500, 1900, 1700, 1500, 1300, 1100, 900, 700, 500, 300, 100, 50, 25, 0],
            'Clothing': [350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1100, 1300, 1500, 1700, 1900,
                         750, 550, 350, 250, 200, 150, 100, 75, 50, 25, 0, 0, 0],
            'Healthcare': [700, 500, 400, 350, 300, 300, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850,
                           400, 300, 200, 150, 100, 75, 50, 25, 0, 0, 0, 0, 0],
            'Activities/Sports': [40, 80, 160, 320, 480, 640, 800, 960, 1120, 1280, 1440, 1600, 1760, 1920, 2080, 2240,
                                  2400, 2560, 480, 320, 240, 160, 120, 80, 40, 20, 0, 0, 0, 0, 0],
            'Entertainment': [80, 120, 160, 200, 240, 280, 320, 360, 400, 440, 480, 520, 560, 600, 640, 680, 720, 760,
                              320, 240, 160, 120, 80, 60, 40, 20, 0, 0, 0, 0, 0],
            'Transportation': [80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300, 320, 450, 700, 1000, 1300,
                               1600, 500, 300, 200, 150, 100, 75, 50, 25, 0, 0, 0, 0, 0],
            'School Supplies': [20, 40, 80, 120, 160, 200, 240, 280, 320, 360, 400, 440, 480, 520, 560, 600, 640, 680,
                                160, 120, 80, 60, 40, 20, 0, 0, 0, 0, 0, 0, 0],
            'Gifts/Celebrations': [160, 200, 240, 280, 320, 360, 400, 440, 480, 520, 560, 600, 640, 680, 720, 760, 800,
                                   840, 480, 400, 320, 280, 240, 200, 160, 120, 80, 60, 40, 20, 0],
            'Miscellaneous': [120, 140, 160, 180, 200, 220, 240, 260, 280, 300, 320, 340, 360, 380, 400, 420, 440, 460,
                              320, 280, 240, 200, 160, 120, 80, 60, 40, 20, 0, 0, 0],
            'Daycare': [18000, 18000, 18000, 18000, 18000, 6000, 4000, 2000, 1000, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 22000, 22000, 22000, 22000, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        },
        "Average": {
            'Food': [1400, 1600, 1800, 2000, 2200, 2400, 2600, 2800, 3000, 3200, 3400, 3600, 3800, 4000, 4200, 4400,
                     4600, 4800, 2200, 2000, 1800, 1600, 1400, 1200, 1000, 800, 600, 400, 200, 100, 0],
            'Clothing': [500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000, 1050, 1100, 1300, 1500, 1700, 1900,
                         2100, 1000, 750, 600, 450, 350, 300, 250, 200, 150, 100, 50, 25, 0],
            'Healthcare': [900, 700, 550, 500, 450, 450, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000,
                           600, 500, 400, 300, 250, 200, 150, 100, 75, 50, 25, 0, 0],
            'Activities/Sports': [80, 160, 320, 480, 640, 800, 960, 1120, 1280, 1440, 1600, 1760, 1920, 2080, 2240,
                                  2400, 2560, 2720, 800, 560, 400, 320, 240, 200, 160, 120, 80, 40, 20, 0, 0],
            'Entertainment': [160, 200, 240, 280, 320, 360, 400, 440, 480, 520, 560, 600, 640, 680, 720, 760, 800, 840,
                              480, 400, 320, 240, 200, 160, 120, 80, 60, 40, 20, 0, 0],
            'Transportation': [120, 150, 180, 210, 240, 270, 300, 330, 360, 390, 420, 450, 480, 650, 1000, 1500, 2000,
                               2500, 750, 500, 375, 300, 250, 200, 150, 100, 75, 50, 25, 0, 0],
            'School Supplies': [40, 60, 120, 180, 240, 300, 360, 420, 480, 540, 600, 660, 720, 780, 840, 900, 960, 1020,
                                240, 180, 120, 80, 60, 40, 20, 0, 0, 0, 0, 0, 0],
            'Gifts/Celebrations': [240, 280, 320, 360, 400, 440, 480, 520, 560, 600, 640, 680, 720, 760, 800, 840, 880,
                                   920, 640, 560, 480, 400, 360, 320, 280, 240, 200, 160, 120, 80, 40],
            'Miscellaneous': [200, 220, 240, 260, 280, 300, 320, 340, 360, 380, 400, 420, 440, 460, 480, 500, 520, 540,
                              480, 400, 360, 320, 280, 240, 200, 160, 120, 80, 60, 40, 20],
            'Daycare': [22000, 22000, 22000, 22000, 22000, 9000, 6000, 3000, 1500, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 28000, 28000, 28000, 28000, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        },
        "High-end": {
            'Food': [2000, 2200, 2400, 2600, 2800, 3000, 3200, 3400, 3600, 3800, 4000, 4200, 4400, 4600, 4800, 5000,
                     5200, 5400, 2800, 2600, 2400, 2200, 2000, 1800, 1600, 1400, 1200, 1000, 800, 600, 300],
            'Clothing': [800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000, 2200, 2400, 2600,
                         2800, 3000, 1800, 1300, 1000, 800, 600, 500, 400, 300, 200, 150, 100, 50, 25],
            'Healthcare': [1300, 1000, 800, 700, 600, 600, 600, 700, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600,
                           1700, 1000, 800, 600, 500, 400, 300, 250, 200, 150, 100, 75, 50, 25],
            'Activities/Sports': [160, 320, 640, 960, 1280, 1600, 1920, 2240, 2560, 2880, 3200, 3520, 3840, 4160, 4480,
                                  4800, 5120, 5440, 1600, 1120, 800, 640, 480, 400, 320, 240, 160, 80, 40, 20, 0],
            'Entertainment': [320, 400, 480, 560, 640, 720, 800, 880, 960, 1040, 1120, 1200, 1280, 1360, 1440, 1520,
                              1600, 1680, 960, 800, 640, 480, 400, 320, 280, 240, 200, 160, 120, 80, 40],
            'Transportation': [200, 250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 1000, 1600, 2400, 3200,
                               4000, 1200, 800, 600, 500, 400, 300, 250, 200, 150, 100, 75, 50, 25],
            'School Supplies': [80, 120, 240, 360, 480, 600, 720, 840, 960, 1080, 1200, 1320, 1440, 1560, 1680, 1800,
                                1920, 2040, 400, 300, 240, 200, 160, 120, 80, 60, 40, 20, 0, 0, 0],
            'Gifts/Celebrations': [400, 480, 560, 640, 720, 800, 880, 960, 1040, 1120, 1200, 1280, 1360, 1440, 1520,
                                   1600, 1680, 1760, 1200, 960, 800, 640, 560, 480, 400, 360, 320, 280, 240, 200, 160],
            'Miscellaneous': [320, 360, 400, 440, 480, 520, 560, 600, 640, 680, 720, 760, 800, 840, 880, 920, 960, 1000,
                              800, 680, 600, 520, 480, 440, 400, 360, 320, 280, 240, 200, 160],
            'Daycare': [30000, 30000, 30000, 30000, 30000, 15000, 12000, 9000, 4500, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 45000, 45000, 45000, 45000, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        }
    },
    "Houston": {
        "Conservative": {
            'Food': [1000, 1200, 1400, 1600, 1800, 2000, 2200, 2400, 2600, 2800, 3000, 3200, 3400, 3600, 3800, 4000,
                     4200, 4400, 1800, 1600, 1400, 1200, 1000, 800, 600, 400, 200, 100, 50, 25, 0],
            'Clothing': [300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 1000, 1200, 1400, 1600, 1800,
                         700, 500, 300, 200, 150, 100, 75, 50, 25, 0, 0, 0, 0],
            'Healthcare': [600, 400, 300, 250, 200, 200, 200, 250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750,
                           300, 200, 150, 100, 75, 50, 25, 0, 0, 0, 0, 0, 0],
            'Activities/Sports': [30, 60, 120, 240, 360, 480, 600, 720, 840, 960, 1080, 1200, 1320, 1440, 1560, 1680,
                                  1800, 1920, 360, 240, 180, 120, 90, 60, 30, 15, 0, 0, 0, 0, 0],
            'Entertainment': [60, 90, 120, 150, 180, 210, 240, 270, 300, 330, 360, 390, 420, 450, 480, 510, 540, 570,
                              240, 180, 120, 90, 60, 45, 30, 15, 0, 0, 0, 0, 0],
            'Transportation': [60, 75, 90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 350, 550, 800, 1050,
                               1300, 400, 250, 150, 100, 75, 50, 25, 0, 0, 0, 0, 0, 0],
            'School Supplies': [15, 30, 60, 90, 120, 150, 180, 210, 240, 270, 300, 330, 360, 390, 420, 450, 480, 510,
                                120, 90, 60, 45, 30, 15, 0, 0, 0, 0, 0, 0, 0],
            'Gifts/Celebrations': [120, 150, 180, 210, 240, 270, 300, 330, 360, 390, 420, 450, 480, 510, 540, 570, 600,
                                   630, 360, 300, 240, 210, 180, 150, 120, 90, 60, 45, 30, 15, 0],
            'Miscellaneous': [90, 105, 120, 135, 150, 165, 180, 195, 210, 225, 240, 255, 270, 285, 300, 315, 330, 345,
                              240, 210, 180, 150, 120, 90, 60, 45, 30, 15, 0, 0, 0],
            'Daycare': [15000, 15000, 15000, 15000, 15000, 5000, 3000, 1500, 750, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18000, 18000, 18000, 18000, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        },
        "Average": {
            'Food': [1300, 1500, 1700, 1900, 2100, 2300, 2500, 2700, 2900, 3100, 3300, 3500, 3700, 3900, 4100, 4300,
                     4500, 4700, 2100, 1900, 1700, 1500, 1300, 1100, 900, 700, 500, 300, 200, 100, 0],
            'Clothing': [450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000, 1050, 1200, 1400, 1600, 1800,
                         2000, 900, 650, 500, 350, 250, 200, 150, 100, 75, 50, 25, 0, 0],
            'Healthcare': [750, 550, 450, 400, 350, 350, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900,
                           450, 350, 250, 200, 150, 100, 75, 50, 25, 0, 0, 0, 0],
            'Activities/Sports': [60, 120, 240, 360, 480, 600, 720, 840, 960, 1080, 1200, 1320, 1440, 1560, 1680, 1800,
                                  1920, 2040, 600, 420, 300, 240, 180, 150, 120, 90, 60, 30, 15, 0, 0],
            'Entertainment': [120, 150, 180, 210, 240, 270, 300, 330, 360, 390, 420, 450, 480, 510, 540, 570, 600, 630,
                              360, 300, 240, 180, 150, 120, 90, 60, 45, 30, 15, 0, 0],
            'Transportation': [90, 112, 135, 157, 180, 202, 225, 247, 270, 292, 315, 337, 360, 500, 800, 1200, 1600,
                               2000, 600, 400, 300, 240, 200, 150, 100, 75, 50, 25, 0, 0, 0],
            'School Supplies': [30, 45, 90, 135, 180, 225, 270, 315, 360, 405, 450, 495, 540, 585, 630, 675, 720, 765,
                                180, 135, 90, 67, 45, 30, 15, 0, 0, 0, 0, 0, 0],
            'Gifts/Celebrations': [180, 210, 240, 270, 300, 330, 360, 390, 420, 450, 480, 510, 540, 570, 600, 630, 660,
                                   690, 480, 420, 360, 315, 270, 225, 180, 135, 90, 67, 45, 30, 15],
            'Miscellaneous': [150, 165, 180, 195, 210, 225, 240, 255, 270, 285, 300, 315, 330, 345, 360, 375, 390, 405,
                              360, 300, 270, 240, 210, 180, 150, 120, 90, 67, 45, 30, 15],
            'Daycare': [18000, 18000, 18000, 18000, 18000, 7500, 5000, 2500, 1250, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 25000, 25000, 25000, 25000, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        },
        "High-end": {
            'Food': [1800, 2000, 2200, 2400, 2600, 2800, 3000, 3200, 3400, 3600, 3800, 4000, 4200, 4400, 4600, 4800,
                     5000, 5200, 2600, 2400, 2200, 2000, 1800, 1600, 1400, 1200, 1000, 800, 600, 400, 200],
            'Clothing': [750, 825, 900, 975, 1050, 1125, 1200, 1275, 1350, 1425, 1500, 1575, 1650, 1875, 2100, 2325,
                         2550, 2775, 1500, 1125, 900, 675, 525, 450, 375, 300, 225, 150, 75, 37, 0],
            'Healthcare': [1125, 900, 750, 675, 600, 600, 600, 675, 750, 825, 900, 975, 1050, 1125, 1200, 1275, 1350,
                           1425, 900, 675, 525, 450, 375, 300, 225, 150, 112, 75, 37, 0, 0],
            'Activities/Sports': [120, 240, 480, 720, 960, 1200, 1440, 1680, 1920, 2160, 2400, 2640, 2880, 3120, 3360,
                                  3600, 3840, 4080, 1200, 840, 600, 480, 360, 300, 240, 180, 120, 60, 30, 15, 0],
            'Entertainment': [240, 300, 360, 420, 480, 540, 600, 660, 720, 780, 840, 900, 960, 1020, 1080, 1140, 1200,
                              1260, 720, 600, 480, 360, 300, 240, 210, 180, 150, 120, 90, 60, 30],
            'Transportation': [150, 187, 225, 262, 300, 337, 375, 412, 450, 487, 525, 562, 600, 800, 1280, 1920, 2560,
                               3200, 960, 640, 480, 400, 320, 240, 200, 160, 120, 80, 60, 40, 20],
            'School Supplies': [60, 90, 180, 270, 360, 450, 540, 630, 720, 810, 900, 990, 1080, 1170, 1260, 1350, 1440,
                                1530, 360, 270, 180, 135, 90, 60, 30, 15, 0, 0, 0, 0, 0],
            'Gifts/Celebrations': [300, 360, 420, 480, 540, 600, 660, 720, 780, 840, 900, 960, 1020, 1080, 1140, 1200,
                                   1260, 1320, 900, 720, 600, 480, 420, 360, 300, 270, 240, 210, 180, 150, 120],
            'Miscellaneous': [240, 270, 300, 330, 360, 390, 420, 450, 480, 510, 540, 570, 600, 630, 660, 690, 720, 750,
                              600, 510, 450, 390, 360, 330, 300, 270, 240, 210, 180, 150, 120],
            'Daycare': [25000, 25000, 25000, 25000, 25000, 12500, 10000, 7500, 3750, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 40000, 40000, 40000, 40000, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        }
    },
    # US Cities
    "New York": {
        "Conservative": {
            'Food': [1560, 1820, 2080, 2340, 2600, 2860, 3120, 3380, 3640, 3900, 4160, 4420, 4680, 4940, 5200, 5460,
                     5720, 5980, 2600, 2340, 2080, 1820, 1560, 1300, 1040, 780, 520, 260, 130, 65, 0],
            'Clothing': [520, 585, 650, 715, 780, 845, 910, 975, 1040, 1105, 1170, 1235, 1300, 1560, 1820, 2080, 2340, 2600,
                         1040, 780, 520, 390, 325, 260, 195, 130, 65, 32, 0, 0, 0],
            'Healthcare': [1040, 780, 650, 585, 520, 520, 520, 585, 650, 715, 780, 845, 910, 975, 1040, 1105, 1170, 1235,
                           650, 520, 390, 325, 260, 195, 130, 97, 65, 32, 0, 0, 0],
            'Activities/Sports': [65, 130, 260, 520, 780, 1040, 1300, 1560, 1820, 2080, 2340, 2600, 2860, 3120, 3380, 3640,
                                  3900, 4160, 780, 520, 390, 260, 195, 130, 65, 32, 0, 0, 0, 0, 0],
            'Entertainment': [130, 195, 260, 325, 390, 455, 520, 585, 650, 715, 780, 845, 910, 975, 1040, 1105, 1170, 1235,
                              520, 390, 260, 195, 130, 97, 65, 32, 0, 0, 0, 0, 0],
            'Transportation': [130, 156, 182, 208, 234, 260, 286, 312, 338, 364, 390, 416, 442, 650, 1040, 1560, 2080,
                               2600, 780, 520, 390, 260, 195, 130, 65, 32, 0, 0, 0, 0, 0],
            'School Supplies': [32, 65, 130, 195, 260, 325, 390, 455, 520, 585, 650, 715, 780, 845, 910, 975, 1040, 1105,
                                260, 195, 130, 97, 65, 32, 0, 0, 0, 0, 0, 0, 0],
            'Gifts/Celebrations': [260, 325, 390, 455, 520, 585, 650, 715, 780, 845, 910, 975, 1040, 1105, 1170, 1235, 1300,
                                   1365, 780, 650, 520, 455, 390, 325, 260, 195, 130, 97, 65, 32, 0],
            'Miscellaneous': [195, 227, 260, 292, 325, 357, 390, 422, 455, 487, 520, 552, 585, 617, 650, 682, 715, 747,
                              520, 455, 390, 325, 260, 195, 130, 97, 65, 32, 0, 0, 0],
            'Daycare': [28600, 28600, 28600, 28600, 28600, 10400, 7800, 5200, 2600, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 36400, 36400, 36400, 36400, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        },
        "Average": {
            'Food': [2080, 2340, 2600, 2860, 3120, 3380, 3640, 3900, 4160, 4420, 4680, 4940, 5200, 5460, 5720, 5980,
                     6240, 6500, 3120, 2860, 2600, 2340, 2080, 1820, 1560, 1300, 1040, 780, 520, 260, 0],
            'Clothing': [780, 845, 910, 975, 1040, 1105, 1170, 1235, 1300, 1365, 1430, 1495, 1560, 1820, 2080, 2340, 2600,
                         2860, 1560, 1170, 910, 650, 520, 455, 390, 325, 260, 195, 130, 65, 0],
            'Healthcare': [1300, 1040, 845, 780, 715, 715, 715, 780, 845, 910, 975, 1040, 1105, 1170, 1235, 1300, 1365, 1430,
                           910, 780, 650, 520, 455, 390, 325, 260, 195, 130, 65, 32, 0],
            'Activities/Sports': [130, 260, 520, 780, 1040, 1300, 1560, 1820, 2080, 2340, 2600, 2860, 3120, 3380, 3640, 3900,
                                  4160, 4420, 1300, 910, 650, 520, 390, 325, 260, 195, 130, 65, 32, 0, 0],
            'Entertainment': [260, 325, 390, 455, 520, 585, 650, 715, 780, 845, 910, 975, 1040, 1105, 1170, 1235, 1300,
                              1365, 780, 650, 520, 390, 325, 260, 195, 130, 97, 65, 32, 0, 0],
            'Transportation': [195, 234, 273, 312, 351, 390, 429, 468, 507, 546, 585, 624, 663, 975, 1560, 2340, 3120,
                               3900, 1170, 780, 585, 455, 390, 325, 260, 195, 130, 65, 32, 0, 0],
            'School Supplies': [65, 97, 195, 292, 390, 487, 585, 682, 780, 877, 975, 1072, 1170, 1267, 1365, 1462, 1560,
                                1657, 390, 292, 195, 130, 97, 65, 32, 0, 0, 0, 0, 0, 0],
            'Gifts/Celebrations': [390, 455, 520, 585, 650, 715, 780, 845, 910, 975, 1040, 1105, 1170, 1235, 1300, 1365,
                                   1430, 1495, 1040, 910, 780, 650, 585, 520, 455, 390, 325, 260, 195, 130, 65],
            'Miscellaneous': [325, 357, 390, 422, 455, 487, 520, 552, 585, 617, 650, 682, 715, 747, 780, 812, 845, 877,
                              780, 650, 585, 520, 455, 390, 325, 260, 195, 130, 97, 65, 32],
            'Daycare': [33800, 33800, 33800, 33800, 33800, 15600, 11700, 7800, 3900, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 45500, 45500, 45500, 45500, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        },
        "High-end": {
            'Food': [2860, 3120, 3380, 3640, 3900, 4160, 4420, 4680, 4940, 5200, 5460, 5720, 5980, 6240, 6500, 6760,
                     7020, 7280, 4160, 3900, 3640, 3380, 3120, 2860, 2600, 2340, 2080, 1820, 1560, 1300, 650],
            'Clothing': [1300, 1430, 1560, 1690, 1820, 1950, 2080, 2210, 2340, 2470, 2600, 2730, 2860, 3250, 3640, 4030,
                         4420, 4810, 2600, 1950, 1560, 1300, 1040, 910, 780, 650, 520, 390, 260, 130, 65],
            'Healthcare': [1950, 1560, 1300, 1170, 1040, 1040, 1040, 1170, 1300, 1430, 1560, 1690, 1820, 1950, 2080, 2210,
                           2340, 2470, 1560, 1300, 1040, 910, 780, 650, 520, 455, 390, 325, 260, 195, 130],
            'Activities/Sports': [260, 520, 1040, 1560, 2080, 2600, 3120, 3640, 4160, 4680, 5200, 5720, 6240, 6760, 7280, 7800,
                                  8320, 8840, 2600, 1950, 1560, 1300, 1040, 780, 650, 520, 390, 260, 130, 65, 0],
            'Entertainment': [520, 650, 780, 910, 1040, 1170, 1300, 1430, 1560, 1690, 1820, 1950, 2080, 2210, 2340, 2470,
                              2600, 2730, 1560, 1300, 1040, 780, 650, 520, 455, 390, 325, 260, 195, 130, 65],
            'Transportation': [325, 390, 455, 520, 585, 650, 715, 780, 845, 910, 975, 1040, 1105, 1560, 2600, 3900, 5200,
                               6500, 1950, 1300, 975, 780, 650, 520, 455, 390, 325, 260, 195, 130, 65],
            'School Supplies': [130, 195, 390, 585, 780, 975, 1170, 1365, 1560, 1755, 1950, 2145, 2340, 2535, 2730, 2925,
                                3120, 3315, 650, 487, 390, 325, 260, 195, 130, 97, 65, 32, 0, 0, 0],
            'Gifts/Celebrations': [650, 780, 910, 1040, 1170, 1300, 1430, 1560, 1690, 1820, 1950, 2080, 2210, 2340, 2470,
                                   2600, 2730, 2860, 1950, 1560, 1300, 1040, 910, 780, 650, 585, 520, 455, 390, 325, 260],
            'Miscellaneous': [520, 585, 650, 715, 780, 845, 910, 975, 1040, 1105, 1170, 1235, 1300, 1365, 1430, 1495, 1560,
                              1625, 1300, 1105, 975, 845, 780, 715, 650, 585, 520, 455, 390, 325, 260],
            'Daycare': [45500, 45500, 45500, 45500, 45500, 23400, 19500, 15600, 7800, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 71500, 71500, 71500, 71500, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        }
    },
    "San Francisco": {
        "Conservative": {
            'Food': [1380, 1610, 1840, 2070, 2300, 2530, 2760, 2990, 3220, 3450, 3680, 3910, 4140, 4370, 4600, 4830,
                     5060, 5290, 2300, 2070, 1840, 1610, 1380, 1150, 920, 690, 460, 230, 115, 57, 0],
            'Clothing': [460, 517, 575, 632, 690, 747, 805, 862, 920, 977, 1035, 1092, 1150, 1380, 1610, 1840, 2070, 2300,
                         920, 690, 460, 345, 287, 230, 172, 115, 57, 28, 0, 0, 0],
            'Healthcare': [920, 690, 575, 517, 460, 460, 460, 517, 575, 632, 690, 747, 805, 862, 920, 977, 1035, 1092,
                           575, 460, 345, 287, 230, 172, 115, 86, 57, 28, 0, 0, 0],
            'Activities/Sports': [57, 115, 230, 460, 690, 920, 1150, 1380, 1610, 1840, 2070, 2300, 2530, 2760, 2990, 3220,
                                  3450, 3680, 690, 460, 345, 230, 172, 115, 57, 28, 0, 0, 0, 0, 0],
            'Entertainment': [115, 172, 230, 287, 345, 402, 460, 517, 575, 632, 690, 747, 805, 862, 920, 977, 1035, 1092,
                              460, 345, 230, 172, 115, 86, 57, 28, 0, 0, 0, 0, 0],
            'Transportation': [115, 138, 161, 184, 207, 230, 253, 276, 299, 322, 345, 368, 391, 575, 920, 1380, 1840,
                               2300, 690, 460, 345, 230, 172, 115, 57, 28, 0, 0, 0, 0, 0],
            'School Supplies': [28, 57, 115, 172, 230, 287, 345, 402, 460, 517, 575, 632, 690, 747, 805, 862, 920, 977,
                                230, 172, 115, 86, 57, 28, 0, 0, 0, 0, 0, 0, 0],
            'Gifts/Celebrations': [230, 287, 345, 402, 460, 517, 575, 632, 690, 747, 805, 862, 920, 977, 1035, 1092, 1150,
                                   1207, 690, 575, 460, 402, 345, 287, 230, 172, 115, 86, 57, 28, 0],
            'Miscellaneous': [172, 201, 230, 258, 287, 316, 345, 373, 402, 431, 460, 488, 517, 546, 575, 603, 632, 661,
                              460, 402, 345, 287, 230, 172, 115, 86, 57, 28, 0, 0, 0],
            'Daycare': [25300, 25300, 25300, 25300, 25300, 9200, 6900, 4600, 2300, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32200, 32200, 32200, 32200, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        },
        "Average": {
            'Food': [1840, 2070, 2300, 2530, 2760, 2990, 3220, 3450, 3680, 3910, 4140, 4370, 4600, 4830, 5060, 5290,
                     5520, 5750, 2760, 2530, 2300, 2070, 1840, 1610, 1380, 1150, 920, 690, 460, 230, 0],
            'Clothing': [690, 747, 805, 862, 920, 977, 1035, 1092, 1150, 1207, 1265, 1322, 1380, 1610, 1840, 2070, 2300,
                         2530, 1380, 1035, 805, 575, 460, 402, 345, 287, 230, 172, 115, 57, 0],
            'Healthcare': [1150, 920, 747, 690, 632, 632, 632, 690, 747, 805, 862, 920, 977, 1035, 1092, 1150, 1207, 1265,
                           805, 690, 575, 460, 402, 345, 287, 230, 172, 115, 57, 28, 0],
            'Activities/Sports': [115, 230, 460, 690, 920, 1150, 1380, 1610, 1840, 2070, 2300, 2530, 2760, 2990, 3220, 3450,
                                  3680, 3910, 1150, 805, 575, 460, 345, 287, 230, 172, 115, 57, 28, 0, 0],
            'Entertainment': [230, 287, 345, 402, 460, 517, 575, 632, 690, 747, 805, 862, 920, 977, 1035, 1092, 1150,
                              1207, 690, 575, 460, 345, 287, 230, 172, 115, 86, 57, 28, 0, 0],
            'Transportation': [172, 207, 241, 276, 310, 345, 379, 414, 448, 483, 517, 552, 586, 862, 1380, 2070, 2760,
                               3450, 1035, 690, 517, 402, 345, 287, 230, 172, 115, 57, 28, 0, 0],
            'School Supplies': [57, 86, 172, 258, 345, 431, 517, 603, 690, 776, 862, 948, 1035, 1121, 1207, 1293, 1380,
                                1466, 345, 258, 172, 115, 86, 57, 28, 0, 0, 0, 0, 0, 0],
            'Gifts/Celebrations': [345, 402, 460, 517, 575, 632, 690, 747, 805, 862, 920, 977, 1035, 1092, 1150, 1207,
                                   1265, 1322, 920, 805, 690, 575, 517, 460, 402, 345, 287, 230, 172, 115, 57],
            'Miscellaneous': [287, 316, 345, 373, 402, 431, 460, 488, 517, 546, 575, 603, 632, 661, 690, 718, 747, 776,
                              690, 575, 517, 460, 402, 345, 287, 230, 172, 115, 86, 57, 28],
            'Daycare': [29900, 29900, 29900, 29900, 29900, 13800, 10350, 6900, 3450, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 40250, 40250, 40250, 40250, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        },
        "High-end": {
            'Food': [2530, 2760, 2990, 3220, 3450, 3680, 3910, 4140, 4370, 4600, 4830, 5060, 5290, 5520, 5750, 5980,
                     6210, 6440, 3680, 3450, 3220, 2990, 2760, 2530, 2300, 2070, 1840, 1610, 1380, 1150, 575],
            'Clothing': [1150, 1265, 1380, 1495, 1610, 1725, 1840, 1955, 2070, 2185, 2300, 2415, 2530, 2875, 3220, 3565,
                         3910, 4255, 2300, 1725, 1380, 1150, 920, 805, 690, 575, 460, 345, 230, 115, 57],
            'Healthcare': [1725, 1380, 1150, 1035, 920, 920, 920, 1035, 1150, 1265, 1380, 1495, 1610, 1725, 1840, 1955,
                           2070, 2185, 1380, 1150, 920, 805, 690, 575, 460, 402, 345, 287, 230, 172, 115],
            'Activities/Sports': [230, 460, 920, 1380, 1840, 2300, 2760, 3220, 3680, 4140, 4600, 5060, 5520, 5980, 6440, 6900,
                                  7360, 7820, 2300, 1725, 1380, 1150, 920, 690, 575, 460, 345, 230, 115, 57, 0],
            'Entertainment': [460, 575, 690, 805, 920, 1035, 1150, 1265, 1380, 1495, 1610, 1725, 1840, 1955, 2070, 2185,
                              2300, 2415, 1380, 1150, 920, 690, 575, 460, 402, 345, 287, 230, 172, 115, 57],
            'Transportation': [287, 345, 402, 460, 517, 575, 632, 690, 747, 805, 862, 920, 977, 1380, 2300, 3450, 4600,
                               5750, 1725, 1150, 862, 690, 575, 460, 402, 345, 287, 230, 172, 115, 57],
            'School Supplies': [115, 172, 345, 517, 690, 862, 1035, 1207, 1380, 1552, 1725, 1897, 2070, 2242, 2415, 2587,
                                2760, 2932, 575, 431, 345, 287, 230, 172, 115, 86, 57, 28, 0, 0, 0],
            'Gifts/Celebrations': [575, 690, 805, 920, 1035, 1150, 1265, 1380, 1495, 1610, 1725, 1840, 1955, 2070, 2185,
                                   2300, 2415, 2530, 1725, 1380, 1150, 920, 805, 690, 575, 517, 460, 402, 345, 287, 230],
            'Miscellaneous': [460, 517, 575, 632, 690, 747, 805, 862, 920, 977, 1035, 1092, 1150, 1207, 1265, 1322, 1380,
                              1437, 1150, 977, 862, 747, 690, 632, 575, 517, 460, 402, 345, 287, 230],
            'Daycare': [40250, 40250, 40250, 40250, 40250, 20700, 17250, 13800, 6900, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 63250, 63250, 63250, 63250, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        }
    },
    "Los Angeles": {  # Similar to California but slightly less expensive
        "Conservative": {
            'Food': [1140, 1330, 1520, 1710, 1900, 2090, 2280, 2470, 2660, 2850, 3040, 3230, 3420, 3610, 3800, 3990,
                     4180, 4370, 1900, 1710, 1520, 1330, 1140, 950, 760, 570, 380, 190, 95, 47, 0],
            'Clothing': [380, 427, 475, 522, 570, 617, 665, 712, 760, 807, 855, 902, 950, 1140, 1330, 1520, 1710, 1900,
                         760, 570, 380, 285, 237, 190, 142, 95, 47, 23, 0, 0, 0],
            'Healthcare': [760, 570, 475, 427, 380, 380, 380, 427, 475, 522, 570, 617, 665, 712, 760, 807, 855, 902,
                           475, 380, 285, 237, 190, 142, 95, 71, 47, 23, 0, 0, 0],
            'Activities/Sports': [47, 95, 190, 380, 570, 760, 950, 1140, 1330, 1520, 1710, 1900, 2090, 2280, 2470, 2660,
                                  2850, 3040, 570, 380, 285, 190, 142, 95, 47, 23, 0, 0, 0, 0, 0],
            'Entertainment': [95, 142, 190, 237, 285, 332, 380, 427, 475, 522, 570, 617, 665, 712, 760, 807, 855, 902,
                              380, 285, 190, 142, 95, 71, 47, 23, 0, 0, 0, 0, 0],
            'Transportation': [95, 114, 133, 152, 171, 190, 209, 228, 247, 266, 285, 304, 323, 475, 760, 1140, 1520,
                               1900, 570, 380, 285, 190, 142, 95, 47, 23, 0, 0, 0, 0, 0],
            'School Supplies': [23, 47, 95, 142, 190, 237, 285, 332, 380, 427, 475, 522, 570, 617, 665, 712, 760, 807,
                                190, 142, 95, 71, 47, 23, 0, 0, 0, 0, 0, 0, 0],
            'Gifts/Celebrations': [190, 237, 285, 332, 380, 427, 475, 522, 570, 617, 665, 712, 760, 807, 855, 902, 950,
                                   997, 570, 475, 380, 332, 285, 237, 190, 142, 95, 71, 47, 23, 0],
            'Miscellaneous': [142, 166, 190, 213, 237, 261, 285, 308, 332, 356, 380, 403, 427, 451, 475, 498, 522, 546,
                              380, 332, 285, 237, 190, 142, 95, 71, 47, 23, 0, 0, 0],
            'Daycare': [20900, 20900, 20900, 20900, 20900, 7600, 5700, 3800, 1900, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 26600, 26600, 26600, 26600, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        },
        "Average": {
            'Food': [1520, 1710, 1900, 2090, 2280, 2470, 2660, 2850, 3040, 3230, 3420, 3610, 3800, 3990, 4180, 4370,
                     4560, 4750, 2280, 2090, 1900, 1710, 1520, 1330, 1140, 950, 760, 570, 380, 190, 0],
            'Clothing': [570, 617, 665, 712, 760, 807, 855, 902, 950, 997, 1045, 1092, 1140, 1330, 1520, 1710, 1900,
                         2090, 1140, 855, 665, 475, 380, 332, 285, 237, 190, 142, 95, 47, 0],
            'Healthcare': [950, 760, 617, 570, 522, 522, 522, 570, 617, 665, 712, 760, 807, 855, 902, 950, 997, 1045,
                           665, 570, 475, 380, 332, 285, 237, 190, 142, 95, 47, 23, 0],
            'Activities/Sports': [95, 190, 380, 570, 760, 950, 1140, 1330, 1520, 1710, 1900, 2090, 2280, 2470, 2660, 2850,
                                  3040, 3230, 950, 665, 475, 380, 285, 237, 190, 142, 95, 47, 23, 0, 0],
            'Entertainment': [190, 237, 285, 332, 380, 427, 475, 522, 570, 617, 665, 712, 760, 807, 855, 902, 950,
                              997, 570, 475, 380, 285, 237, 190, 142, 95, 71, 47, 23, 0, 0],
            'Transportation': [142, 171, 199, 228, 256, 285, 313, 342, 370, 399, 427, 456, 484, 712, 1140, 1710, 2280,
                               2850, 855, 570, 427, 332, 285, 237, 190, 142, 95, 47, 23, 0, 0],
            'School Supplies': [47, 71, 142, 213, 285, 356, 427, 498, 570, 641, 712, 783, 855, 926, 997, 1068, 1140,
                                1211, 285, 213, 142, 95, 71, 47, 23, 0, 0, 0, 0, 0, 0],
            'Gifts/Celebrations': [285, 332, 380, 427, 475, 522, 570, 617, 665, 712, 760, 807, 855, 902, 950, 997,
                                   1045, 1092, 760, 665, 570, 475, 427, 380, 332, 285, 237, 190, 142, 95, 47],
            'Miscellaneous': [237, 261, 285, 308, 332, 356, 380, 403, 427, 451, 475, 498, 522, 546, 570, 593, 617, 641,
                              570, 475, 427, 380, 332, 285, 237, 190, 142, 95, 71, 47, 23],
            'Daycare': [24700, 24700, 24700, 24700, 24700, 11400, 8550, 5700, 2850, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 33250, 33250, 33250, 33250, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        },
        "High-end": {
            'Food': [2090, 2280, 2470, 2660, 2850, 3040, 3230, 3420, 3610, 3800, 3990, 4180, 4370, 4560, 4750, 4940,
                     5130, 5320, 3040, 2850, 2660, 2470, 2280, 2090, 1900, 1710, 1520, 1330, 1140, 950, 475],
            'Clothing': [950, 1045, 1140, 1235, 1330, 1425, 1520, 1615, 1710, 1805, 1900, 1995, 2090, 2375, 2660, 2945,
                         3230, 3515, 1900, 1425, 1140, 950, 760, 665, 570, 475, 380, 285, 190, 95, 47],
            'Healthcare': [1425, 1140, 950, 855, 760, 760, 760, 855, 950, 1045, 1140, 1235, 1330, 1425, 1520, 1615,
                           1710, 1805, 1140, 950, 760, 665, 570, 475, 380, 332, 285, 237, 190, 142, 95],
            'Activities/Sports': [190, 380, 760, 1140, 1520, 1900, 2280, 2660, 3040, 3420, 3800, 4180, 4560, 4940, 5320, 5700,
                                  6080, 6460, 1900, 1425, 1140, 950, 760, 570, 475, 380, 285, 190, 95, 47, 0],
            'Entertainment': [380, 475, 570, 665, 760, 855, 950, 1045, 1140, 1235, 1330, 1425, 1520, 1615, 1710, 1805,
                              1900, 1995, 1140, 950, 760, 570, 475, 380, 332, 285, 237, 190, 142, 95, 47],
            'Transportation': [237, 285, 332, 380, 427, 475, 522, 570, 617, 665, 712, 760, 807, 1140, 1900, 2850, 3800,
                               4750, 1425, 950, 712, 570, 475, 380, 332, 285, 237, 190, 142, 95, 47],
            'School Supplies': [95, 142, 285, 427, 570, 712, 855, 997, 1140, 1282, 1425, 1567, 1710, 1852, 1995, 2137,
                                2280, 2422, 475, 356, 285, 237, 190, 142, 95, 71, 47, 23, 0, 0, 0],
            'Gifts/Celebrations': [475, 570, 665, 760, 855, 950, 1045, 1140, 1235, 1330, 1425, 1520, 1615, 1710, 1805,
                                   1900, 1995, 2090, 1425, 1140, 950, 760, 665, 570, 475, 427, 380, 332, 285, 237, 190],
            'Miscellaneous': [380, 427, 475, 522, 570, 617, 665, 712, 760, 807, 855, 902, 950, 997, 1045, 1092, 1140,
                              1187, 950, 807, 712, 617, 570, 522, 475, 427, 380, 332, 285, 237, 190],
            'Daycare': [33250, 33250, 33250, 33250, 33250, 17100, 14250, 11400, 5700, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52250, 52250, 52250, 52250, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        }
    },
    "Portland": {
        "Conservative": {
            'Food': [1020, 1190, 1360, 1530, 1700, 1870, 2040, 2210, 2380, 2550, 2720, 2890, 3060, 3230, 3400, 3570,
                     3740, 3910, 1700, 1530, 1360, 1190, 1020, 850, 680, 510, 340, 170, 85, 42, 0],
            'Clothing': [340, 382, 425, 467, 510, 552, 595, 637, 680, 722, 765, 807, 850, 1020, 1190, 1360, 1530, 1700,
                         680, 510, 340, 255, 212, 170, 127, 85, 42, 21, 0, 0, 0],
            'Healthcare': [680, 510, 425, 382, 340, 340, 340, 382, 425, 467, 510, 552, 595, 637, 680, 722, 765, 807,
                           425, 340, 255, 212, 170, 127, 85, 63, 42, 21, 0, 0, 0],
            'Activities/Sports': [42, 85, 170, 340, 510, 680, 850, 1020, 1190, 1360, 1530, 1700, 1870, 2040, 2210, 2380,
                                  2550, 2720, 510, 340, 255, 170, 127, 85, 42, 21, 0, 0, 0, 0, 0],
            'Entertainment': [85, 127, 170, 212, 255, 297, 340, 382, 425, 467, 510, 552, 595, 637, 680, 722, 765, 807,
                              340, 255, 170, 127, 85, 63, 42, 21, 0, 0, 0, 0, 0],
            'Transportation': [85, 102, 119, 136, 153, 170, 187, 204, 221, 238, 255, 272, 289, 425, 680, 1020, 1360,
                               1700, 510, 340, 255, 170, 127, 85, 42, 21, 0, 0, 0, 0, 0],
            'School Supplies': [21, 42, 85, 127, 170, 212, 255, 297, 340, 382, 425, 467, 510, 552, 595, 637, 680, 722,
                                170, 127, 85, 63, 42, 21, 0, 0, 0, 0, 0, 0, 0],
            'Gifts/Celebrations': [170, 212, 255, 297, 340, 382, 425, 467, 510, 552, 595, 637, 680, 722, 765, 807, 850,
                                   892, 510, 425, 340, 297, 255, 212, 170, 127, 85, 63, 42, 21, 0],
            'Miscellaneous': [127, 148, 170, 191, 212, 233, 255, 276, 297, 318, 340, 361, 382, 403, 425, 446, 467, 488,
                              340, 297, 255, 212, 170, 127, 85, 63, 42, 21, 0, 0, 0],
            'Daycare': [18700, 18700, 18700, 18700, 18700, 6800, 5100, 3400, 1700, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 23800, 23800, 23800, 23800, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        },
        "Average": {
            'Food': [1360, 1530, 1700, 1870, 2040, 2210, 2380, 2550, 2720, 2890, 3060, 3230, 3400, 3570, 3740, 3910,
                     4080, 4250, 2040, 1870, 1700, 1530, 1360, 1190, 1020, 850, 680, 510, 340, 170, 0],
            'Clothing': [510, 552, 595, 637, 680, 722, 765, 807, 850, 892, 935, 977, 1020, 1190, 1360, 1530, 1700,
                         1870, 1020, 765, 595, 425, 340, 297, 255, 212, 170, 127, 85, 42, 0],
            'Healthcare': [850, 680, 552, 510, 467, 467, 467, 510, 552, 595, 637, 680, 722, 765, 807, 850, 892, 935,
                           595, 510, 425, 340, 297, 255, 212, 170, 127, 85, 42, 21, 0],
            'Activities/Sports': [85, 170, 340, 510, 680, 850, 1020, 1190, 1360, 1530, 1700, 1870, 2040, 2210, 2380, 2550,
                                  2720, 2890, 850, 595, 425, 340, 255, 212, 170, 127, 85, 42, 21, 0, 0],
            'Entertainment': [170, 212, 255, 297, 340, 382, 425, 467, 510, 552, 595, 637, 680, 722, 765, 807, 850,
                              892, 510, 425, 340, 255, 212, 170, 127, 85, 63, 42, 21, 0, 0],
            'Transportation': [127, 153, 178, 204, 229, 255, 280, 306, 331, 357, 382, 408, 433, 637, 1020, 1530, 2040,
                               2550, 765, 510, 382, 297, 255, 212, 170, 127, 85, 42, 21, 0, 0],
            'School Supplies': [42, 63, 127, 191, 255, 318, 382, 446, 510, 573, 637, 701, 765, 828, 892, 956, 1020,
                                1083, 255, 191, 127, 85, 63, 42, 21, 0, 0, 0, 0, 0, 0],
            'Gifts/Celebrations': [255, 297, 340, 382, 425, 467, 510, 552, 595, 637, 680, 722, 765, 807, 850, 892,
                                   935, 977, 680, 595, 510, 425, 382, 340, 297, 255, 212, 170, 127, 85, 42],
            'Miscellaneous': [212, 233, 255, 276, 297, 318, 340, 361, 382, 403, 425, 446, 467, 488, 510, 531, 552, 573,
                              510, 425, 382, 340, 297, 255, 212, 170, 127, 85, 63, 42, 21],
            'Daycare': [22100, 22100, 22100, 22100, 22100, 10200, 7650, 5100, 2550, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 29750, 29750, 29750, 29750, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        },
        "High-end": {
            'Food': [1870, 2040, 2210, 2380, 2550, 2720, 2890, 3060, 3230, 3400, 3570, 3740, 3910, 4080, 4250, 4420,
                     4590, 4760, 2720, 2550, 2380, 2210, 2040, 1870, 1700, 1530, 1360, 1190, 1020, 850, 425],
            'Clothing': [850, 935, 1020, 1105, 1190, 1275, 1360, 1445, 1530, 1615, 1700, 1785, 1870, 2125, 2380, 2635,
                         2890, 3145, 1700, 1275, 1020, 850, 680, 595, 510, 425, 340, 255, 170, 85, 42],
            'Healthcare': [1275, 1020, 850, 765, 680, 680, 680, 765, 850, 935, 1020, 1105, 1190, 1275, 1360, 1445,
                           1530, 1615, 1020, 850, 680, 595, 510, 425, 340, 297, 255, 212, 170, 127, 85],
            'Activities/Sports': [170, 340, 680, 1020, 1360, 1700, 2040, 2380, 2720, 3060, 3400, 3740, 4080, 4420, 4760, 5100,
                                  5440, 5780, 1700, 1275, 1020, 850, 680, 510, 425, 340, 255, 170, 85, 42, 0],
            'Entertainment': [340, 425, 510, 595, 680, 765, 850, 935, 1020, 1105, 1190, 1275, 1360, 1445, 1530, 1615,
                              1700, 1785, 1020, 850, 680, 510, 425, 340, 297, 255, 212, 170, 127, 85, 42],
            'Transportation': [212, 255, 297, 340, 382, 425, 467, 510, 552, 595, 637, 680, 722, 1020, 1700, 2550, 3400,
                               4250, 1275, 850, 637, 510, 425, 340, 297, 255, 212, 170, 127, 85, 42],
            'School Supplies': [85, 127, 255, 382, 510, 637, 765, 892, 1020, 1147, 1275, 1402, 1530, 1657, 1785, 1912,
                                2040, 2167, 425, 318, 255, 212, 170, 127, 85, 63, 42, 21, 0, 0, 0],
            'Gifts/Celebrations': [425, 510, 595, 680, 765, 850, 935, 1020, 1105, 1190, 1275, 1360, 1445, 1530, 1615,
                                   1700, 1785, 1870, 1275, 1020, 850, 680, 595, 510, 425, 382, 340, 297, 255, 212, 170],
            'Miscellaneous': [340, 382, 425, 467, 510, 552, 595, 637, 680, 722, 765, 807, 850, 892, 935, 977, 1020,
                              1062, 850, 722, 637, 552, 510, 467, 425, 382, 340, 297, 255, 212, 170],
            'Daycare': [29750, 29750, 29750, 29750, 29750, 15300, 12750, 10200, 5100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            'Education': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 46750, 46750, 46750, 46750, 0, 0, 0, 0,
                          0, 0, 0, 0, 0]
        }
    }
}

FAMILY_EXPENSE_TEMPLATES = {
    "California": {
        "Conservative": {
            'Food & Groceries': 14400,
            'Clothing': 3600,
            'Transportation': 10000,
            'Entertainment & Activities': 4800,
            'Personal Care': 2400,
            'Parent Retirement Help': 12000,
            'Other Expenses': 6000
        },
        "Average": {
            'Food & Groceries': 18000,
            'Clothing': 4800,
            'Transportation': 13000,
            'Entertainment & Activities': 7200,
            'Personal Care': 3600,
            'Parent Retirement Help': 18000,
            'Other Expenses': 8400
        },
        "High-end": {
            'Food & Groceries': 24000,
            'Clothing': 7200,
            'Transportation': 18000,
            'Entertainment & Activities': 12000,
            'Personal Care': 6000,
            'Parent Retirement Help': 30000,
            'Other Expenses': 12000
        }
    },
    "Seattle": {
        "Conservative": {
            'Food & Groceries': 13200,
            'Clothing': 3000,
            'Transportation': 9000,
            'Entertainment & Activities': 4200,
            'Personal Care': 2100,
            'Parent Retirement Help': 10000,
            'Other Expenses': 5400
        },
        "Average": {
            'Food & Groceries': 16800,
            'Clothing': 4200,
            'Transportation': 12000,
            'Entertainment & Activities': 6600,
            'Personal Care': 3000,
            'Parent Retirement Help': 16000,
            'Other Expenses': 7800
        },
        "High-end": {
            'Food & Groceries': 22800,
            'Clothing': 6600,
            'Transportation': 16800,
            'Entertainment & Activities': 10800,
            'Personal Care': 5400,
            'Parent Retirement Help': 28000,
            'Other Expenses': 10800
        }
    },
    "Houston": {
        "Conservative": {
            'Food & Groceries': 12600,
            'Clothing': 2800,
            'Transportation': 8400,
            'Entertainment & Activities': 3900,
            'Personal Care': 1800,
            'Parent Retirement Help': 9000,
            'Other Expenses': 5100
        },
        "Average": {
            'Food & Groceries': 15600,
            'Clothing': 3900,
            'Transportation': 11400,
            'Entertainment & Activities': 6000,
            'Personal Care': 2700,
            'Parent Retirement Help': 15000,
            'Other Expenses': 7200
        },
        "High-end": {
            'Food & Groceries': 21000,
            'Clothing': 6000,
            'Transportation': 15600,
            'Entertainment & Activities': 9600,
            'Personal Care': 4800,
            'Parent Retirement Help': 25000,
            'Other Expenses': 10200
        }
    },
    # Major US Cities
    "New York": {
        "Conservative": {
            'Food & Groceries': 18720,  # 30% higher than CA
            'Clothing': 4680,
            'Transportation': 13000,
            'Entertainment & Activities': 6240,
            'Personal Care': 3120,
            'Parent Retirement Help': 15600,
            'Other Expenses': 7800
        },
        "Average": {
            'Food & Groceries': 23400,
            'Clothing': 6240,
            'Transportation': 16900,
            'Entertainment & Activities': 9360,
            'Personal Care': 4680,
            'Parent Retirement Help': 23400,
            'Other Expenses': 10920
        },
        "High-end": {
            'Food & Groceries': 31200,
            'Clothing': 9360,
            'Transportation': 23400,
            'Entertainment & Activities': 15600,
            'Personal Care': 7800,
            'Parent Retirement Help': 39000,
            'Other Expenses': 15600
        }
    },
    "San Francisco": {
        "Conservative": {
            'Food & Groceries': 16560,  # 15% higher than CA
            'Clothing': 4140,
            'Transportation': 11500,
            'Entertainment & Activities': 5520,
            'Personal Care': 2760,
            'Parent Retirement Help': 13800,
            'Other Expenses': 6900
        },
        "Average": {
            'Food & Groceries': 20700,
            'Clothing': 5520,
            'Transportation': 14950,
            'Entertainment & Activities': 8280,
            'Personal Care': 4140,
            'Parent Retirement Help': 20700,
            'Other Expenses': 9660
        },
        "High-end": {
            'Food & Groceries': 27600,
            'Clothing': 8280,
            'Transportation': 20700,
            'Entertainment & Activities': 13800,
            'Personal Care': 6900,
            'Parent Retirement Help': 34500,
            'Other Expenses': 13800
        }
    },
    "Los Angeles": {
        "Conservative": {
            'Food & Groceries': 13680,  # 5% lower than CA
            'Clothing': 3420,
            'Transportation': 9500,
            'Entertainment & Activities': 4560,
            'Personal Care': 2280,
            'Parent Retirement Help': 11400,
            'Other Expenses': 5700
        },
        "Average": {
            'Food & Groceries': 17100,
            'Clothing': 4560,
            'Transportation': 12350,
            'Entertainment & Activities': 6840,
            'Personal Care': 3420,
            'Parent Retirement Help': 17100,
            'Other Expenses': 7980
        },
        "High-end": {
            'Food & Groceries': 22800,
            'Clothing': 6840,
            'Transportation': 17100,
            'Entertainment & Activities': 11400,
            'Personal Care': 5700,
            'Parent Retirement Help': 28500,
            'Other Expenses': 11400
        }
    },
    "Portland": {
        "Conservative": {
            'Food & Groceries': 12240,  # 15% lower than CA
            'Clothing': 3060,
            'Transportation': 8500,
            'Entertainment & Activities': 4080,
            'Personal Care': 2040,
            'Parent Retirement Help': 10200,
            'Other Expenses': 5100
        },
        "Average": {
            'Food & Groceries': 15300,
            'Clothing': 4080,
            'Transportation': 11050,
            'Entertainment & Activities': 6120,
            'Personal Care': 3060,
            'Parent Retirement Help': 15300,
            'Other Expenses': 7140
        },
        "High-end": {
            'Food & Groceries': 20400,
            'Clothing': 6120,
            'Transportation': 15300,
            'Entertainment & Activities': 10200,
            'Personal Care': 5100,
            'Parent Retirement Help': 25500,
            'Other Expenses': 10200
        }
    },
    # International Cities (in USD equivalent for simplicity)
    # Note: For Canadian cities, multiply by ~0.75 for CAD
    # For European cities (EUR), multiply by ~0.92 for EUR
    # For Australian cities (AUD), multiply by ~1.52 for AUD
    "Toronto": {
        "Conservative": {
            'Food & Groceries': 12960,  # 10% lower than CA
            'Clothing': 3240,
            'Transportation': 9000,
            'Entertainment & Activities': 4320,
            'Personal Care': 2160,
            'Parent Retirement Help': 10800,
            'Other Expenses': 5400
        },
        "Average": {
            'Food & Groceries': 16200,
            'Clothing': 4320,
            'Transportation': 11700,
            'Entertainment & Activities': 6480,
            'Personal Care': 3240,
            'Parent Retirement Help': 16200,
            'Other Expenses': 7560
        },
        "High-end": {
            'Food & Groceries': 21600,
            'Clothing': 6480,
            'Transportation': 16200,
            'Entertainment & Activities': 10800,
            'Personal Care': 5400,
            'Parent Retirement Help': 27000,
            'Other Expenses': 10800
        }
    },
    "Vancouver": {
        "Conservative": {
            'Food & Groceries': 13680,  # 5% lower than CA
            'Clothing': 3420,
            'Transportation': 9500,
            'Entertainment & Activities': 4560,
            'Personal Care': 2280,
            'Parent Retirement Help': 11400,
            'Other Expenses': 5700
        },
        "Average": {
            'Food & Groceries': 17100,
            'Clothing': 4560,
            'Transportation': 12350,
            'Entertainment & Activities': 6840,
            'Personal Care': 3420,
            'Parent Retirement Help': 17100,
            'Other Expenses': 7980
        },
        "High-end": {
            'Food & Groceries': 22800,
            'Clothing': 6840,
            'Transportation': 17100,
            'Entertainment & Activities': 11400,
            'Personal Care': 5700,
            'Parent Retirement Help': 28500,
            'Other Expenses': 11400
        }
    },
    "Paris": {
        "Conservative": {
            'Food & Groceries': 10800,  # 25% lower than CA
            'Clothing': 2700,
            'Transportation': 7500,
            'Entertainment & Activities': 3600,
            'Personal Care': 1800,
            'Parent Retirement Help': 9000,
            'Other Expenses': 4500
        },
        "Average": {
            'Food & Groceries': 13500,
            'Clothing': 3600,
            'Transportation': 9750,
            'Entertainment & Activities': 5400,
            'Personal Care': 2700,
            'Parent Retirement Help': 13500,
            'Other Expenses': 6300
        },
        "High-end": {
            'Food & Groceries': 18000,
            'Clothing': 5400,
            'Transportation': 13500,
            'Entertainment & Activities': 9000,
            'Personal Care': 4500,
            'Parent Retirement Help': 22500,
            'Other Expenses': 9000
        }
    },
    "Toulouse": {
        "Conservative": {
            'Food & Groceries': 9360,  # 35% lower than CA
            'Clothing': 2340,
            'Transportation': 6500,
            'Entertainment & Activities': 3120,
            'Personal Care': 1560,
            'Parent Retirement Help': 7800,
            'Other Expenses': 3900
        },
        "Average": {
            'Food & Groceries': 11700,
            'Clothing': 3120,
            'Transportation': 8450,
            'Entertainment & Activities': 4680,
            'Personal Care': 2340,
            'Parent Retirement Help': 11700,
            'Other Expenses': 5460
        },
        "High-end": {
            'Food & Groceries': 15600,
            'Clothing': 4680,
            'Transportation': 11700,
            'Entertainment & Activities': 7800,
            'Personal Care': 3900,
            'Parent Retirement Help': 19500,
            'Other Expenses': 7800
        }
    },
    "Berlin": {
        "Conservative": {
            'Food & Groceries': 10080,  # 30% lower than CA
            'Clothing': 2520,
            'Transportation': 7000,
            'Entertainment & Activities': 3360,
            'Personal Care': 1680,
            'Parent Retirement Help': 8400,
            'Other Expenses': 4200
        },
        "Average": {
            'Food & Groceries': 12600,
            'Clothing': 3360,
            'Transportation': 9100,
            'Entertainment & Activities': 5040,
            'Personal Care': 2520,
            'Parent Retirement Help': 12600,
            'Other Expenses': 5880
        },
        "High-end": {
            'Food & Groceries': 16800,
            'Clothing': 5040,
            'Transportation': 12600,
            'Entertainment & Activities': 8400,
            'Personal Care': 4200,
            'Parent Retirement Help': 21000,
            'Other Expenses': 8400
        }
    },
    "Munich": {
        "Conservative": {
            'Food & Groceries': 12960,  # 10% lower than CA
            'Clothing': 3240,
            'Transportation': 9000,
            'Entertainment & Activities': 4320,
            'Personal Care': 2160,
            'Parent Retirement Help': 10800,
            'Other Expenses': 5400
        },
        "Average": {
            'Food & Groceries': 16200,
            'Clothing': 4320,
            'Transportation': 11700,
            'Entertainment & Activities': 6480,
            'Personal Care': 3240,
            'Parent Retirement Help': 16200,
            'Other Expenses': 7560
        },
        "High-end": {
            'Food & Groceries': 21600,
            'Clothing': 6480,
            'Transportation': 16200,
            'Entertainment & Activities': 10800,
            'Personal Care': 5400,
            'Parent Retirement Help': 27000,
            'Other Expenses': 10800
        }
    },
    "Sydney": {
        "Conservative": {
            'Food & Groceries': 15840,  # 10% higher than CA
            'Clothing': 3960,
            'Transportation': 11000,
            'Entertainment & Activities': 5280,
            'Personal Care': 2640,
            'Parent Retirement Help': 13200,
            'Other Expenses': 6600
        },
        "Average": {
            'Food & Groceries': 19800,
            'Clothing': 5280,
            'Transportation': 14300,
            'Entertainment & Activities': 7920,
            'Personal Care': 3960,
            'Parent Retirement Help': 19800,
            'Other Expenses': 9240
        },
        "High-end": {
            'Food & Groceries': 26400,
            'Clothing': 7920,
            'Transportation': 19800,
            'Entertainment & Activities': 13200,
            'Personal Care': 6600,
            'Parent Retirement Help': 33000,
            'Other Expenses': 13200
        }
    },
    "Melbourne": {
        "Conservative": {
            'Food & Groceries': 13680,  # 5% lower than CA
            'Clothing': 3420,
            'Transportation': 9500,
            'Entertainment & Activities': 4560,
            'Personal Care': 2280,
            'Parent Retirement Help': 11400,
            'Other Expenses': 5700
        },
        "Average": {
            'Food & Groceries': 17100,
            'Clothing': 4560,
            'Transportation': 12350,
            'Entertainment & Activities': 6840,
            'Personal Care': 3420,
            'Parent Retirement Help': 17100,
            'Other Expenses': 7980
        },
        "High-end": {
            'Food & Groceries': 22800,
            'Clothing': 6840,
            'Transportation': 17100,
            'Entertainment & Activities': 11400,
            'Personal Care': 5700,
            'Parent Retirement Help': 28500,
            'Other Expenses': 11400
        }
    },
    "Brisbane": {
        "Conservative": {
            'Food & Groceries': 12240,  # 15% lower than CA
            'Clothing': 3060,
            'Transportation': 8500,
            'Entertainment & Activities': 4080,
            'Personal Care': 2040,
            'Parent Retirement Help': 10200,
            'Other Expenses': 5100
        },
        "Average": {
            'Food & Groceries': 15300,
            'Clothing': 4080,
            'Transportation': 11050,
            'Entertainment & Activities': 6120,
            'Personal Care': 3060,
            'Parent Retirement Help': 15300,
            'Other Expenses': 7140
        },
        "High-end": {
            'Food & Groceries': 20400,
            'Clothing': 6120,
            'Transportation': 15300,
            'Entertainment & Activities': 10200,
            'Personal Care': 5100,
            'Parent Retirement Help': 25500,
            'Other Expenses': 10200
        }
    }
}


# Data Classes
@dataclass
class MajorPurchase:
    name: str
    year: int
    amount: float
    financing_years: int = 0
    interest_rate: float = 0.0
    asset_type: str = "Expense"  # NEW: "Expense", "Real Estate", "Vehicle", "Investment"
    appreciation_rate: float = 0.0  # NEW: Annual appreciation rate


@dataclass
class RecurringExpense:
    name: str
    category: str
    amount: float
    frequency_years: int
    start_year: int
    end_year: Optional[int] = None
    inflation_adjust: bool = True
    parent: str = "Both"
    financing_years: int = 0
    interest_rate: float = 0.0


@dataclass
class EconomicScenario:
    name: str
    investment_return: float
    inflation_rate: float
    expense_growth_rate: float
    healthcare_inflation_rate: float


@dataclass
class HouseTimelineEntry:
    year: int
    status: str
    rental_income: float = 0.0


@dataclass
class House:
    name: str
    purchase_year: int
    purchase_price: float
    current_value: float
    mortgage_balance: float
    mortgage_rate: float
    mortgage_years_left: int
    property_tax_rate: float
    home_insurance: float
    maintenance_rate: float
    upkeep_costs: float
    owner: str = "Shared"
    timeline: List[HouseTimelineEntry] = None

    def __post_init__(self):
        if self.timeline is None:
            self.timeline = [HouseTimelineEntry(self.purchase_year, "Own_Live", 0.0)]

    def get_status_for_year(self, year: int) -> tuple:
        """Get status and rental income for a specific year"""
        if not self.timeline:
            return "Own_Live", 0.0

        sorted_timeline = sorted(self.timeline, key=lambda x: x.year)

        current_status = "Own_Live"
        current_rental = 0.0

        for entry in sorted_timeline:
            if entry.year <= year:
                current_status = entry.status
                current_rental = entry.rental_income
            else:
                break

        return current_status, current_rental


@dataclass
class StateTimelineEntry:
    year: int
    state: str
    spending_strategy: str = "Average"


# NEW: Portfolio Allocation dataclass
@dataclass
class PortfolioAllocation:
    stocks: float = 60.0
    bonds: float = 30.0
    cash: float = 5.0
    real_estate: float = 5.0
    other: float = 0.0

    def total(self) -> float:
        return self.stocks + self.bonds + self.cash + self.real_estate + self.other

    def is_valid(self) -> bool:
        return abs(self.total() - 100.0) < 0.01


# NEW: Healthcare & Insurance dataclasses
@dataclass
class HealthInsurance:
    name: str
    type: str  # "Employer", "Marketplace", "Medicare", "Medicaid"
    monthly_premium: float
    annual_deductible: float
    annual_out_of_pocket_max: float
    copay_primary: float
    copay_specialist: float
    covered_by: str  # "Parent 1", "Parent 2", "Both", "Family"
    start_age: int = 0
    end_age: int = 999

@dataclass
class LongTermCareInsurance:
    name: str
    monthly_premium: float
    daily_benefit: float
    benefit_period_days: int
    elimination_period_days: int
    covered_person: str  # "Parent 1", "Parent 2"
    start_age: int = 55
    inflation_protection: float = 0.03

@dataclass
class HealthExpense:
    category: str  # "Routine Care", "Prescription", "Emergency", "Dental", "Vision", "Mental Health"
    annual_amount: float
    covered_by_insurance: bool
    start_age: int
    end_age: int
    affected_person: str  # "Parent 1", "Parent 2", "Both"


# NEW: Debt Management dataclasses
@dataclass
class Debt:
    name: str
    debt_type: str  # "Student Loan", "Credit Card", "Auto Loan", "Personal Loan", "Medical Debt"
    principal: float
    interest_rate: float
    monthly_payment: float
    minimum_payment: float
    start_date: str
    owner: str  # "Parent 1", "Parent 2", "Shared"
    interest_type: str = "Fixed"  # "Fixed", "Variable"
    income_based_repayment: bool = False
    forgiveness_eligible: bool = False
    forgiveness_years: int = 0


# NEW: Education Funding dataclasses
@dataclass
class Plan529:
    name: str
    beneficiary: str  # Child name or "TBD"
    current_balance: float
    monthly_contribution: float
    state: str  # For state tax deduction calculation
    investment_return: float = 0.07
    age_based_allocation: bool = True
    contribution_end_age: int = 18

@dataclass
class EducationGoal:
    beneficiary: str
    institution_type: str  # "Public In-State", "Public Out-of-State", "Private", "Community College"
    estimated_annual_cost: float
    years_of_college: int = 4
    start_year: int = 2043
    scholarship_amount: float = 0.0
    grants_amount: float = 0.0
    student_loans_allowed: bool = False
    max_parent_contribution: float = 0.0


# NEW: Tax Optimization dataclasses
@dataclass
class TaxStrategy:
    name: str
    strategy_type: str  # "Roth Conversion", "Tax Loss Harvesting", "Charitable Giving", "HSA Max"
    annual_amount: float
    start_year: int
    end_year: int
    estimated_tax_savings: float = 0.0
    notes: str = ""

@dataclass
class RetirementWithdrawal:
    year: int
    account_type: str  # "401k", "IRA", "Roth IRA", "Taxable", "HSA"
    amount: float
    tax_rate: float
    purpose: str = "Living Expenses"


# Currency formatting function with automatic scaling
def format_currency(value, force_full=False, context="general"):
    """
    Currency formatting with automatic scaling

    Args:
        value: The monetary value to format
        force_full: If True, always show full amount regardless of size
        context: Context for formatting ("general", "input", "detailed")

    Returns:
        Formatted currency string
    """
    if pd.isna(value) or value is None:
        return "$0"

    if context == "input" or force_full:
        return f"${value:,.0f}"

    abs_value = abs(value)

    if abs_value < 1000:
        return f"${value:,.0f}"

    if context == "detailed" and abs_value < 100000:
        return f"${value:,.0f}"

    if abs_value >= 1000000:
        scaled = value / 1000000
        if scaled == int(scaled):
            return f"${scaled:.0f}M"
        else:
            return f"${scaled:.1f}M"
    elif abs_value >= 1000:
        scaled = value / 1000
        if scaled == int(scaled):
            return f"${scaled:.0f}k"
        else:
            return f"${scaled:.0f}k"
    else:
        return f"${value:,.0f}"


# Initialize session state
def initialize_session_state():
    """Initialize all session state variables"""
    if 'initialized' not in st.session_state:
        st.session_state.current_year = 2025

        st.session_state.parent1_name = "Filipp"
        st.session_state.parent1_emoji = "ðŸ‘¨"
        st.session_state.parent2_name = "Erin"
        st.session_state.parent2_emoji = "ðŸ‘©"

        st.session_state.marriage_year = "N/A"

        st.session_state.state_timeline = [
            StateTimelineEntry(2025, "Seattle", "Average")
        ]

        # NEW: Portfolio allocation
        st.session_state.portfolio_allocation = PortfolioAllocation()

        # Parent X data
        st.session_state.parentX_age = 35
        st.session_state.parentX_net_worth = 85000.0
        st.session_state.parentX_income = 95000.0
        st.session_state.parentX_raise = 3.5
        st.session_state.parentX_retirement_age = 65
        st.session_state.parentX_ss_benefit = 2500.0
        st.session_state.parentX_job_changes = pd.DataFrame({
            'Year': [2027, 2032],
            'New Income': [105000, 120000]
        })

        # Parent Y data
        st.session_state.parentY_age = 33
        st.session_state.parentY_net_worth = 75000.0
        st.session_state.parentY_income = 85000.0
        st.session_state.parentY_raise = 3.2
        st.session_state.parentY_retirement_age = 65
        st.session_state.parentY_ss_benefit = 2200.0
        st.session_state.parentY_job_changes = pd.DataFrame({
            'Year': [2028, 2033],
            'New Income': [92000, 105000]
        })

        # Dynamic expense categories
        st.session_state.expense_categories = [
            'Food & Groceries',
            'Clothing',
            'Transportation',
            'Entertainment & Activities',
            'Personal Care',
            'Parent Retirement Help',
            'Other Expenses'
        ]

        # Expense categories
        st.session_state.expenses = {
            'Food & Groceries': 16800.0,
            'Clothing': 4200.0,
            'Transportation': 12000.0,
            'Entertainment & Activities': 6000.0,
            'Personal Care': 3600.0,
            'Parent Retirement Help': 20000.0,
            'Other Expenses': 7200.0
        }

        # Children expenses table
        st.session_state.children_expenses = pd.DataFrame({
            'Age': list(range(31)),
            'Food': [
                1500 if i < 2 else 1800 if i < 5 else 2400 if i < 12 else 3000 if i < 19 else 1500 if i < 23 else 600 if i < 26 else 0
                for i in range(31)],
            'Clothing': [
                600 if i < 2 else 500 if i < 5 else 600 if i < 12 else 900 if i < 19 else 500 if i < 23 else 200 if i < 26 else 0
                for i in range(31)],
            'Healthcare': [
                800 if i < 1 else 500 if i < 5 else 400 if i < 19 else 300 if i < 23 else 200 if i < 26 else 0 for i in
                range(31)],
            'Activities/Sports': [
                100 if i < 3 else 300 if i < 6 else 800 if i < 12 else 1500 if i < 19 else 400 if i < 23 else 0 for i in
                range(31)],
            'Entertainment': [200 if i < 3 else 300 if i < 12 else 500 if i < 19 else 300 if i < 23 else 0 for i in
                              range(31)],
            'Transportation': [200 if i < 13 else 300 if i < 16 else 1000 if i < 19 else 400 if i < 23 else 0 for i in
                               range(31)],
            'School Supplies': [50 if i < 5 else 200 if i < 13 else 300 if i < 19 else 0 for i in range(31)],
            'Gifts/Celebrations': [300 if i < 19 else 400 if i < 30 else 0 for i in range(31)],
            'Miscellaneous': [200 if i < 19 else 300 if i < 23 else 200 if i < 26 else 100 if i < 30 else 0 for i in
                              range(31)],
            'Daycare': [20376 if i < 5 else 0 for i in range(31)],
            'Education': [25000 if 18 <= i <= 21 else 0 for i in range(31)]
        })

        # Children instances
        st.session_state.children_list = [
            {
                'name': 'Child 1',
                'birth_year': 2028,
                'use_template': True,
                'template_state': 'Seattle',
                'template_strategy': 'Average',
                'school_type': 'Public',
                'college_location': 'Seattle'
            },
            {
                'name': 'Child 2',
                'birth_year': 2030,
                'use_template': True,
                'template_state': 'Seattle',
                'template_strategy': 'Average',
                'school_type': 'Public',
                'college_location': 'Seattle'
            }
        ]
        st.session_state.children_today_dollars = True

        # Major purchases and recurring expenses
        st.session_state.major_purchases = []
        st.session_state.recurring_expenses = [
            RecurringExpense(
                name="Parent X Vehicle",
                category="Vehicle",
                amount=35000.0,
                frequency_years=10,
                start_year=2025,
                end_year=None,
                inflation_adjust=True,
                parent="ParentX",
                financing_years=5,
                interest_rate=0.045
            ),
            RecurringExpense(
                name="Parent Y Vehicle",
                category="Vehicle",
                amount=32000.0,
                frequency_years=10,
                start_year=2027,
                end_year=None,
                inflation_adjust=True,
                parent="ParentY",
                financing_years=5,
                interest_rate=0.045
            )
        ]

        # Economic scenarios
        st.session_state.economic_scenarios = {
            'Conservative': EconomicScenario('Conservative', 0.04, 0.03, 0.02, 0.05),
            'Moderate': EconomicScenario('Moderate', 0.06, 0.025, 0.02, 0.045),
            'Aggressive': EconomicScenario('Aggressive', 0.08, 0.02, 0.02, 0.04)
        }

        st.session_state.active_scenario = 'Moderate'

        # Houses
        st.session_state.houses = [
            House(
                name="Primary Home",
                purchase_year=2020,
                purchase_price=600000.0,
                current_value=650000.0,
                mortgage_balance=500000.0,
                mortgage_rate=0.067,
                mortgage_years_left=28,
                property_tax_rate=0.0092,
                home_insurance=1800.0,
                maintenance_rate=0.015,
                upkeep_costs=3000.0,
                owner="Shared",
                timeline=[HouseTimelineEntry(2020, "Own_Live", 0.0)]
            )
        ]

        # Tax settings
        st.session_state.state_tax_rate = 0.0
        st.session_state.pretax_401k = 0.0

        # Social Security insolvency settings
        st.session_state.ss_insolvency_enabled = True
        st.session_state.ss_shortfall_percentage = 30.0

        # Monte Carlo settings
        st.session_state.mc_start_year = 2025
        st.session_state.mc_years = 30
        st.session_state.mc_simulations = 1000
        st.session_state.mc_income_variability = 10.0
        st.session_state.mc_expense_variability = 5.0
        st.session_state.mc_return_variability = 15.0

        # NEW: Asymmetric variability settings
        st.session_state.mc_income_variability_positive = 10.0
        st.session_state.mc_income_variability_negative = 10.0
        st.session_state.mc_expense_variability_positive = 5.0
        st.session_state.mc_expense_variability_negative = 5.0
        st.session_state.mc_return_variability_positive = 15.0
        st.session_state.mc_return_variability_negative = 15.0

        # Historical simulation settings
        st.session_state.mc_use_historical = False
        st.session_state.mc_historical_start_year = 1924
        st.session_state.mc_show_historical_stats = False

        # NEW: Inflation normalization toggle
        st.session_state.mc_normalize_to_today_dollars = False

        # Display preferences
        st.session_state.inflation_adjusted_display = True
        st.session_state.default_inflation_rate = 0.025

        # NEW: Internal save/load system
        st.session_state.saved_scenarios = {}

        # NEW: Custom children templates
        st.session_state.custom_children_templates = {}

        # NEW: Custom family expense templates
        st.session_state.custom_family_templates = {}

        # NEW: Custom location display names (for user-created cities)
        st.session_state.custom_location_display_names = {}

        # NEW: Healthcare & Insurance
        st.session_state.health_insurances = []
        st.session_state.ltc_insurances = []
        st.session_state.health_expenses = []
        st.session_state.hsa_balance = 0.0
        st.session_state.hsa_contribution = 0.0
        st.session_state.medicare_part_b_premium = 174.70  # 2025 standard
        st.session_state.medicare_part_d_premium = 55.0    # Average estimate
        st.session_state.medigap_premium = 150.0           # Average estimate

        # NEW: Debt Management
        st.session_state.debts = []
        st.session_state.debt_payoff_strategy = "Avalanche"  # "Avalanche", "Snowball", "Minimum Only"
        st.session_state.extra_debt_payment = 0.0

        # NEW: Education Funding
        st.session_state.plan529_accounts = []
        st.session_state.education_goals = []
        st.session_state.coverdell_esa = 0.0
        st.session_state.utma_ugma_balance = 0.0

        # NEW: Tax Optimization
        st.session_state.tax_strategies = []
        st.session_state.retirement_withdrawals = []
        st.session_state.roth_conversion_amount = 0.0
        st.session_state.charitable_contributions = 0.0
        st.session_state.qcd_enabled = False  # Qualified Charitable Distribution
        st.session_state.tax_bracket = 0.22    # Federal marginal tax bracket

        # Tab visibility settings
        st.session_state.show_portfolio_allocation = False  # Off by default
        st.session_state.show_healthcare = False  # Off by default
        st.session_state.show_debt = False  # Off by default
        st.session_state.show_education = False  # Off by default
        st.session_state.show_tax = False  # Off by default
        st.session_state.show_export = True  # On by default

        st.session_state.initialized = True


def get_state_for_year(year: int) -> tuple:
    """Get the state and spending strategy for a given year"""
    if not st.session_state.state_timeline:
        return "Seattle", "Average"

    sorted_timeline = sorted(st.session_state.state_timeline, key=lambda x: x.year)

    current_state = "Seattle"
    current_strategy = "Average"

    for entry in sorted_timeline:
        if entry.year <= year:
            current_state = entry.state
            current_strategy = entry.spending_strategy
        else:
            break

    return current_state, current_strategy


def get_location_display_name(location: str) -> str:
    """Get full display name for a location including country and state"""
    # Check custom display names first, then built-in ones
    if hasattr(st.session_state, 'custom_location_display_names'):
        custom_name = st.session_state.custom_location_display_names.get(location)
        if custom_name:
            return custom_name
    return LOCATION_DISPLAY_NAMES.get(location, location)


def get_state_based_family_expenses(year: int) -> dict:
    """Get family expenses based on the state for a given year"""
    state, strategy = get_state_for_year(year)

    if state in FAMILY_EXPENSE_TEMPLATES and strategy in FAMILY_EXPENSE_TEMPLATES[state]:
        return FAMILY_EXPENSE_TEMPLATES[state][strategy].copy()
    else:
        return st.session_state.expenses.copy()


def get_state_based_children_expenses(year: int, child_age: int) -> dict:
    """Get children expenses for a specific age based on the state for a given year"""
    state, strategy = get_state_for_year(year)

    if (state in CHILDREN_EXPENSE_TEMPLATES and
            strategy in CHILDREN_EXPENSE_TEMPLATES[state] and
            0 <= child_age < len(CHILDREN_EXPENSE_TEMPLATES[state][strategy]['Food'])):

        template = CHILDREN_EXPENSE_TEMPLATES[state][strategy]
        child_expenses = {}

        for category, values in template.items():
            if child_age < len(values):
                child_expenses[category] = values[child_age]
            else:
                child_expenses[category] = 0

        return child_expenses
    else:
        if 0 <= child_age < len(st.session_state.children_expenses):
            row = st.session_state.children_expenses.iloc[child_age]
            return {col: row[col] for col in row.index if col != 'Age'}
        else:
            return {}


def get_child_expenses(child: dict, year: int, current_year: int) -> dict:
    """
    Get expenses for a specific child in a specific year, accounting for:
    - School type (public/private)
    - College location (where they attend college)
    - Living arrangement (at home vs at college)

    Args:
        child: Child dictionary with keys: name, birth_year, template_state, template_strategy,
               school_type, college_location
        year: The year to calculate expenses for
        current_year: The current year (for age calculation)

    Returns:
        dict: Expense categories and amounts for this child in this year
    """
    child_age = year - child['birth_year']

    # Child expenses only apply from age 0-25
    if child_age < 0 or child_age > 30:
        return {}

    # Determine which location template to use
    # Ages 18-21: Use college location (living at college)
    # Other ages: Use family's template location
    if 18 <= child_age <= 21:
        location = child.get('college_location', 'Seattle')
        lives_at_college = True
    else:
        location = child.get('template_state', 'Seattle')
        lives_at_college = False

    strategy = child.get('template_strategy', 'Average')
    school_type = child.get('school_type', 'Public')

    # Get base expenses from template
    if (location in CHILDREN_EXPENSE_TEMPLATES and
            strategy in CHILDREN_EXPENSE_TEMPLATES[location] and
            0 <= child_age < len(CHILDREN_EXPENSE_TEMPLATES[location][strategy]['Food'])):

        template = CHILDREN_EXPENSE_TEMPLATES[location][strategy]
        child_expenses = {}

        for category, values in template.items():
            if child_age < len(values):
                child_expenses[category] = values[child_age]
            else:
                child_expenses[category] = 0
    else:
        # Fallback to default template
        if 0 <= child_age < len(st.session_state.children_expenses):
            row = st.session_state.children_expenses.iloc[child_age]
            child_expenses = {col: row[col] for col in row.index if col != 'Age'}
        else:
            child_expenses = {}

    # Adjust for private school (ages 5-17, K-12 education)
    if school_type == 'Private' and 5 <= child_age <= 17:
        # Add private school tuition based on location
        private_school_costs = {
            'Seattle': 20000,  # Average private school in Seattle
            'Sacramento': 18000,
            'Houston': 15000,
            'New York': 35000,
            'San Francisco': 32000,
            'Los Angeles': 25000,
            'Portland': 17000
        }
        additional_tuition = private_school_costs.get(child.get('template_state', 'Seattle'), 20000)
        child_expenses['Education'] = child_expenses.get('Education', 0) + additional_tuition

    # Adjust expenses for living at college (ages 18-21)
    if lives_at_college:
        # College students living on campus have different expense patterns
        # Room & board is included in Education costs
        # Reduce home-based expenses (food, transportation, etc.)
        child_expenses['Food'] = child_expenses.get('Food', 0) * 0.3  # Occasional meals at home
        child_expenses['Transportation'] = child_expenses.get('Transportation', 0) * 0.4  # Less frequent trips home
        child_expenses['Entertainment'] = child_expenses.get('Entertainment', 0) * 0.5  # Less at-home entertainment

        # Education costs now include tuition + room & board
        college_type = child.get('college_type', 'Public')

        # Base tuition costs (public vs private)
        if college_type == 'Public':
            # Public college tuition by location
            public_tuition = {
                'Seattle': 12000,      # UW in-state
                'Sacramento': 10000,   # UC in-state
                'Houston': 11000,      # UT in-state
                'New York': 13000,     # SUNY/CUNY in-state
                'San Francisco': 10000, # UC in-state
                'Los Angeles': 10000,  # UC in-state
                'Portland': 12000      # Oregon in-state
            }
            tuition = public_tuition.get(location, 12000)
        else:  # Private college
            # Private college tuition by location (2-3x public costs)
            private_tuition = {
                'Seattle': 55000,      # Seattle University, etc.
                'Sacramento': 50000,
                'Houston': 48000,
                'New York': 60000,     # NYU, Columbia, etc.
                'San Francisco': 58000, # Stanford area schools
                'Los Angeles': 56000,  # USC, etc.
                'Portland': 52000
            }
            tuition = private_tuition.get(location, 55000)

        # Room & board costs (~$15k-25k depending on location)
        room_board_costs = {
            'Seattle': 18000,
            'Sacramento': 15000,
            'Houston': 12000,
            'New York': 25000,
            'San Francisco': 24000,
            'Los Angeles': 20000,
            'Portland': 16000
        }
        room_board = room_board_costs.get(location, 18000)

        # Total college costs = tuition + room & board
        child_expenses['Education'] = child_expenses.get('Education', 0) + tuition + room_board

    return child_expenses


def get_income_for_year(base_income: float, raise_rate: float, job_changes_df: pd.DataFrame,
                        current_year: int, target_year: int) -> float:
    """
    Calculate income for a specific year considering job changes and raises.

    Args:
        base_income: Starting income (current year)
        raise_rate: Annual raise percentage
        job_changes_df: DataFrame with 'Year' and 'New Income' columns
        current_year: The current year (base year)
        target_year: The year to calculate income for

    Returns:
        float: Income for the target year
    """
    # Find the most recent job change that applies to target_year
    applicable_job_changes = job_changes_df[job_changes_df['Year'] <= target_year]

    if len(applicable_job_changes) > 0:
        # Get the most recent job change
        most_recent = applicable_job_changes.sort_values('Year').iloc[-1]
        last_change_year = most_recent['Year']
        last_change_income = most_recent['New Income']

        # Apply raises from the last job change to target year
        years_since_change = target_year - last_change_year
        income = last_change_income * (1 + raise_rate / 100) ** years_since_change
    else:
        # No job changes, apply raises from current year
        years_from_now = target_year - current_year
        income = base_income * (1 + raise_rate / 100) ** years_from_now

    return income


def get_historical_return_stats():
    """Calculate statistics from historical returns"""
    returns = np.array(HISTORICAL_STOCK_RETURNS)

    stats = {
        'mean': np.mean(returns),
        'median': np.median(returns),
        'std': np.std(returns),
        'min': np.min(returns),
        'max': np.max(returns),
        'positive_years': np.sum(returns > 0),
        'negative_years': np.sum(returns < 0),
        'total_years': len(returns),
        'positive_percentage': (np.sum(returns > 0) / len(returns)) * 100
    }

    return stats


def calculate_federal_income_tax(taxable_income, filing_status="married_jointly", year=2024):
    """Calculate federal income tax based on tax brackets"""

    if filing_status == "married_jointly":
        brackets = [
            (0, 23200, 0.10),
            (23200, 94300, 0.12),
            (94300, 201050, 0.22),
            (201050, 383900, 0.24),
            (383900, 487450, 0.32),
            (487450, 731200, 0.35),
            (731200, float('inf'), 0.37)
        ]
    else:  # single
        brackets = [
            (0, 11600, 0.10),
            (11600, 47150, 0.12),
            (47150, 100525, 0.22),
            (100525, 191950, 0.24),
            (191950, 243725, 0.32),
            (243725, 609350, 0.35),
            (609350, float('inf'), 0.37)
        ]

    tax = 0
    for i, (lower, upper, rate) in enumerate(brackets):
        if taxable_income <= lower:
            break

        taxable_in_bracket = min(taxable_income, upper) - lower
        tax += taxable_in_bracket * rate

        if taxable_income <= upper:
            break

    return tax


def calculate_annual_taxes(gross_income, pretax_deductions=0, state_tax_rate=0.0, filing_status="married_jointly"):
    """Calculate total annual taxes including federal, state, and FICA"""

    standard_deduction = 29200 if filing_status == "married_jointly" else 14600

    adjusted_gross_income = max(0, gross_income - pretax_deductions)

    taxable_income = max(0, adjusted_gross_income - standard_deduction)

    federal_tax = calculate_federal_income_tax(taxable_income, filing_status)

    state_tax = adjusted_gross_income * state_tax_rate

    ss_wage_base = 160200
    medicare_threshold = 250000 if filing_status == "married_jointly" else 200000

    ss_tax = min(gross_income, ss_wage_base) * 0.062
    medicare_tax = gross_income * 0.0145
    additional_medicare = max(0, gross_income - medicare_threshold) * 0.009

    fica_tax = ss_tax + medicare_tax + additional_medicare

    total_tax = federal_tax + state_tax + fica_tax

    return {
        'federal_tax': federal_tax,
        'state_tax': state_tax,
        'fica_tax': fica_tax,
        'total_tax': total_tax,
        'effective_rate': (total_tax / gross_income * 100) if gross_income > 0 else 0,
        'after_tax_income': gross_income - total_tax
    }


def calculate_monthly_house_payment(house):
    """Calculate total monthly payment for a house (PITI)"""
    if house.mortgage_years_left > 0:
        monthly_rate = house.mortgage_rate / 12
        num_payments = house.mortgage_years_left * 12

        if monthly_rate > 0:
            monthly_payment = house.mortgage_balance * (
                    monthly_rate * (1 + monthly_rate) ** num_payments
            ) / ((1 + monthly_rate) ** num_payments - 1)
        else:
            monthly_payment = house.mortgage_balance / num_payments
    else:
        monthly_payment = 0

    monthly_property_tax = (house.current_value * house.property_tax_rate) / 12

    monthly_insurance = house.home_insurance / 12

    return monthly_payment + monthly_property_tax + monthly_insurance


def main():
    """Main application function"""
    initialize_session_state()

    st.title("ðŸ’° Financial Planning Suite V16")

    # Build tab list dynamically based on visibility settings
    tab_configs = [
        ("âš™ï¸ Settings", parent_settings_tab, True),  # Always shown
        (f"{st.session_state.parent1_emoji} {st.session_state.parent1_name}", parent_x_tab, True),
        (f"{st.session_state.parent2_emoji} {st.session_state.parent2_name}", parent_y_tab, True),
        ("ðŸ’¸ Family Expenses", family_expenses_tab, True),
        ("ðŸ‘¶ Children", children_tab, True),
        ("ðŸ  House Portfolio", house_tab, True),
        ("ðŸ’¼ Portfolio Allocation", portfolio_allocation_tab, st.session_state.get('show_portfolio_allocation', False)),
        ("ðŸ“ˆ Economy", economy_tab, True),
        ("ðŸ–¼ï¸ Retirement", retirement_tab, True),
        ("ðŸ¥ Healthcare & Insurance", healthcare_insurance_tab, st.session_state.get('show_healthcare', False)),
        ("ðŸ’³ Debt Management", debt_management_tab, st.session_state.get('show_debt', False)),
        ("ðŸŽ“ Education Funding", education_funding_tab, st.session_state.get('show_education', False)),
        ("ðŸ’¼ Tax Optimization", tax_optimization_tab, st.session_state.get('show_tax', False)),
        ("ðŸ—“ï¸ Timeline", timeline_tab, True),
        ("ðŸ“Š Analysis", combined_simulation_tab, True),
        ("ðŸ’° Lifetime Cashflow", lifetime_cashflow_tab, True),
        ("ðŸ“„ Export Reports", report_export_tab, st.session_state.get('show_export', True)),
        ("ðŸ’¾ Save/Load", save_load_tab, True)
    ]

    # Filter to only enabled tabs
    enabled_tabs = [(name, func) for name, func, enabled in tab_configs if enabled]
    tab_names = [name for name, func in enabled_tabs]
    tab_functions = [func for name, func in enabled_tabs]

    # Create tabs
    tabs = st.tabs(tab_names)

    # Render each enabled tab
    for idx, (tab, func) in enumerate(zip(tabs, tab_functions)):
        with tab:
            func()

    # Display sidebar
    display_sidebar()


# Tab implementations
def parent_settings_tab():
    """Settings and Instructions tab"""
    st.header("âš™ï¸ Settings and Instructions")

    st.subheader("ðŸ“… Current Year Setting")
    st.session_state.current_year = st.number_input(
        "Current Year",
        min_value=2020,
        max_value=2030,
        value=int(st.session_state.current_year),
        step=1
    )

    st.subheader("ðŸ’ Marriage Information")
    marriage_options = ["N/A"] + list(range(1970, st.session_state.current_year + 1))

    if st.session_state.marriage_year == "N/A":
        marriage_index = 0
    else:
        try:
            marriage_index = marriage_options.index(int(st.session_state.marriage_year))
        except (ValueError, TypeError):
            marriage_index = 0

    selected_marriage = st.selectbox(
        "Marriage Year",
        options=marriage_options,
        index=marriage_index
    )

    st.session_state.marriage_year = selected_marriage

    col1, col2 = st.columns(2)

    with col1:
        st.subheader("ðŸ”§ Customize Parent 1")
        st.session_state.parent1_name = st.text_input(
            "Parent 1 Name",
            value=st.session_state.parent1_name
        )

        emoji_options = ["ðŸ‘¨", "ðŸ‘©", "ðŸ§‘", "ðŸ‘¤", "ðŸ‘¼", "ðŸƒ", "â­", "ðŸŽ¯"]
        current_emoji_idx = emoji_options.index(
            st.session_state.parent1_emoji) if st.session_state.parent1_emoji in emoji_options else 0

        st.session_state.parent1_emoji = st.selectbox(
            "Parent 1 Emoji",
            emoji_options,
            index=current_emoji_idx
        )

    with col2:
        st.subheader("ðŸ”§ Customize Parent 2")
        st.session_state.parent2_name = st.text_input(
            "Parent 2 Name",
            value=st.session_state.parent2_name
        )

        current_emoji_idx = emoji_options.index(
            st.session_state.parent2_emoji) if st.session_state.parent2_emoji in emoji_options else 1

        st.session_state.parent2_emoji = st.selectbox(
            "Parent 2 Emoji",
            emoji_options,
            index=current_emoji_idx
        )

    st.info("ðŸ’¡ Changes to parent names and emojis will be reflected in all tabs after you navigate to them.")

    # Tab Visibility Settings
    st.markdown("---")
    st.subheader("ðŸ‘ï¸ Tab Visibility Settings")
    st.markdown("Choose which advanced features to show. Disabled tabs are hidden to simplify the interface.")

    col1, col2 = st.columns(2)

    with col1:
        st.session_state.show_portfolio_allocation = st.checkbox(
            "ðŸ’¼ Portfolio Allocation",
            value=st.session_state.get('show_portfolio_allocation', False),
            help="Configure asset allocation (stocks, bonds, cash, real estate)"
        )

        st.session_state.show_healthcare = st.checkbox(
            "ðŸ¥ Healthcare & Insurance",
            value=st.session_state.get('show_healthcare', False),
            help="Plan Medicare, HSA, long-term care, and health insurance"
        )

        st.session_state.show_debt = st.checkbox(
            "ðŸ’³ Debt Management",
            value=st.session_state.get('show_debt', False),
            help="Track student loans, credit cards, and payoff strategies"
        )

    with col2:
        st.session_state.show_education = st.checkbox(
            "ðŸŽ“ Education Funding",
            value=st.session_state.get('show_education', False),
            help="Plan 529 accounts, college costs, and scholarships"
        )

        st.session_state.show_tax = st.checkbox(
            "ðŸ’¼ Tax Optimization",
            value=st.session_state.get('show_tax', False),
            help="Optimize Roth conversions, QCDs, and withdrawal sequencing"
        )

        st.session_state.show_export = st.checkbox(
            "ðŸ“„ Export Reports",
            value=st.session_state.get('show_export', True),
            help="Export financial data to Excel, CSV, or JSON"
        )

    st.info("ðŸ’¡ Changes take effect immediately. Disabled tabs are hidden from the navigation.")

    # Instructions Section
    st.markdown("---")
    st.header("ðŸ“– Application Instructions")

    st.markdown("""
    ### Welcome to Financial Planning Suite

    This application helps you plan and project your family's financial future through comprehensive
    modeling of income, expenses, investments, and major life events.

    #### Quick Start Guide

    1. **Settings**: Configure current year, parent names, and which tabs to show
    2. **Parent Tabs**: Enter age, net worth, income, retirement plans, and Social Security
    3. **Family Expenses**: Define annual expenses, taxes, major purchases
    4. **Children**: Add children and configure their education expenses
    5. **Houses**: Track property ownership, mortgages, and timelines
    6. **Economy**: Select economic scenario (Conservative/Moderate/Aggressive)
    7. **Timeline**: Review consolidated timeline and plan relocations
    8. **Analysis**: Run Monte Carlo simulations to project future outcomes
    9. **Save/Load**: Save scenarios for future reference

    #### Optional Advanced Features

    Enable in Settings â†’ Tab Visibility to access:
    - **Portfolio Allocation**: Define investment mix across asset classes
    - **Healthcare & Insurance**: Plan Medicare, HSA, and long-term care costs
    - **Debt Management**: Track loans and optimize payoff strategies
    - **Education Funding**: Manage 529 plans and college savings
    - **Tax Optimization**: Plan Roth conversions and withdrawal strategies
    - **Export Reports**: Generate Excel/CSV/JSON reports

    #### Key Capabilities

    - Location-based expense templates for major U.S. cities
    - Monte Carlo simulation with detailed percentile analysis
    - Historical market data (100+ years of S&P 500 returns)
    - Social Security insolvency modeling
    - Inflation adjustment and today's dollars view
    - Multiple scenario comparison
    """)


def parent_x_tab():
    """Parent X financial details tab"""
    st.header(f"{st.session_state.parent1_emoji} {st.session_state.parent1_name}'s Financial Details")

    col1, col2 = st.columns(2)

    with col1:
        st.subheader("Basic Information")
        st.session_state.parentX_age = st.number_input(
            "Current Age",
            min_value=18,
            max_value=100,
            value=int(st.session_state.parentX_age),
            step=1,
            key="parentX_age_input"
        )

        st.session_state.parentX_net_worth = st.number_input(
            "Current Net Worth ($)",
            min_value=-10000000.0,
            max_value=100000000.0,
            value=float(st.session_state.parentX_net_worth),
            step=1000.0,
            format="%.0f",
            key="parentX_net_worth_input"
        )
        st.caption(f"Formatted: {format_currency(st.session_state.parentX_net_worth, force_full=False)}")

        st.session_state.parentX_income = st.number_input(
            "Annual Income ($)",
            min_value=0.0,
            max_value=10000000.0,
            value=float(st.session_state.parentX_income),
            step=1000.0,
            format="%.0f",
            key="parentX_income_input"
        )
        st.caption(f"Formatted: {format_currency(st.session_state.parentX_income, force_full=False)}")

        st.session_state.parentX_raise = st.number_input(
            "Annual Raise (%)",
            min_value=0.0,
            max_value=20.0,
            value=float(st.session_state.parentX_raise),
            step=0.1,
            format="%.2f",
            key="parentX_raise_input"
        )

    with col2:
        st.subheader("Retirement Information")
        st.session_state.parentX_retirement_age = st.number_input(
            "Retirement Age",
            min_value=int(st.session_state.parentX_age),
            max_value=100,
            value=int(st.session_state.parentX_retirement_age),
            step=1,
            key="parentX_retirement_age_input"
        )

        st.session_state.parentX_ss_benefit = st.number_input(
            "Monthly Social Security Benefit ($)",
            min_value=0.0,
            max_value=10000.0,
            value=float(st.session_state.parentX_ss_benefit),
            step=50.0,
            format="%.0f",
            key="parentX_ss_benefit_input"
        )
        st.caption(f"Annual: {format_currency(st.session_state.parentX_ss_benefit * 12, force_full=False)}")

    st.subheader("Job Changes / Income Adjustments")
    st.markdown("Plan for promotions, career changes, or income adjustments")
    st.caption("ðŸ’¡ Tip: Click '+' to add rows, enter Year and New Income, changes save automatically")

    # Use data_editor and capture its output properly
    edited_job_changes = st.data_editor(
        st.session_state.parentX_job_changes,
        num_rows="dynamic",
        use_container_width=True,
        column_config={
            "Year": st.column_config.NumberColumn(
                "Year",
                help="Year when income changes",
                min_value=st.session_state.current_year,
                max_value=2100,
                step=1,
                format="%d"
            ),
            "New Income": st.column_config.NumberColumn(
                "New Income ($)",
                help="New annual income starting this year",
                min_value=0,
                max_value=10000000,
                step=1000,
                format="$%d"
            )
        },
        key="parentX_job_changes_editor"
    )

    # Update session state with the edited data
    st.session_state.parentX_job_changes = edited_job_changes


def parent_y_tab():
    """Parent Y financial details tab"""
    st.header(f"{st.session_state.parent2_emoji} {st.session_state.parent2_name}'s Financial Details")

    col1, col2 = st.columns(2)

    with col1:
        st.subheader("Basic Information")
        st.session_state.parentY_age = st.number_input(
            "Current Age",
            min_value=18,
            max_value=100,
            value=int(st.session_state.parentY_age),
            step=1,
            key="parentY_age_input"
        )

        st.session_state.parentY_net_worth = st.number_input(
            "Current Net Worth ($)",
            min_value=-10000000.0,
            max_value=100000000.0,
            value=float(st.session_state.parentY_net_worth),
            step=1000.0,
            format="%.0f",
            key="parentY_net_worth_input"
        )
        st.caption(f"Formatted: {format_currency(st.session_state.parentY_net_worth, force_full=False)}")

        st.session_state.parentY_income = st.number_input(
            "Annual Income ($)",
            min_value=0.0,
            max_value=10000000.0,
            value=float(st.session_state.parentY_income),
            step=1000.0,
            format="%.0f",
            key="parentY_income_input"
        )
        st.caption(f"Formatted: {format_currency(st.session_state.parentY_income, force_full=False)}")

        st.session_state.parentY_raise = st.number_input(
            "Annual Raise (%)",
            min_value=0.0,
            max_value=20.0,
            value=float(st.session_state.parentY_raise),
            step=0.1,
            format="%.2f",
            key="parentY_raise_input"
        )

    with col2:
        st.subheader("Retirement Information")
        st.session_state.parentY_retirement_age = st.number_input(
            "Retirement Age",
            min_value=int(st.session_state.parentY_age),
            max_value=100,
            value=int(st.session_state.parentY_retirement_age),
            step=1,
            key="parentY_retirement_age_input"
        )

        st.session_state.parentY_ss_benefit = st.number_input(
            "Monthly Social Security Benefit ($)",
            min_value=0.0,
            max_value=10000.0,
            value=float(st.session_state.parentY_ss_benefit),
            step=50.0,
            format="%.0f",
            key="parentY_ss_benefit_input"
        )
        st.caption(f"Annual: {format_currency(st.session_state.parentY_ss_benefit * 12, force_full=False)}")

    st.subheader("Job Changes / Income Adjustments")
    st.markdown("Plan for promotions, career changes, or income adjustments")
    st.caption("ðŸ’¡ Tip: Click '+' to add rows, enter Year and New Income, changes save automatically")

    # Use data_editor and capture its output properly
    edited_job_changes = st.data_editor(
        st.session_state.parentY_job_changes,
        num_rows="dynamic",
        use_container_width=True,
        column_config={
            "Year": st.column_config.NumberColumn(
                "Year",
                help="Year when income changes",
                min_value=st.session_state.current_year,
                max_value=2100,
                step=1,
                format="%d"
            ),
            "New Income": st.column_config.NumberColumn(
                "New Income ($)",
                help="New annual income starting this year",
                min_value=0,
                max_value=10000000,
                step=1000,
                format="$%d"
            )
        },
        key="parentY_job_changes_editor"
    )

    # Update session state with the edited data
    st.session_state.parentY_job_changes = edited_job_changes


def family_expenses_tab():
    """Family expenses tab with template browsing, modification, and custom city creation"""
    st.header("ðŸ’¸ Family Expenses")

    # Show inflation adjustment info
    st.info(f"â„¹ï¸ All expense templates are inflation-adjusted to **{EXPENSE_TEMPLATE_BASE_YEAR}** dollars")

    # Create tabs for different views
    expense_tab1, expense_tab2, expense_tab3 = st.tabs([
        "ðŸ“Š Browse Templates",
        "âœï¸ Edit Templates",
        "ðŸŒ Create Custom City"
    ])

    # TAB 1: Browse Templates
    with expense_tab1:
        st.subheader("ðŸ“Š Browse Expense Templates by Location")

        # Get all available locations (built-in + custom)
        all_templates = {**FAMILY_EXPENSE_TEMPLATES, **st.session_state.custom_family_templates}
        available_locations = sorted(all_templates.keys())

        if not available_locations:
            st.warning("No templates available. Please create a custom city in the 'Create Custom City' tab.")
            return

        # Create display options with full location names
        location_display_options = [get_location_display_name(loc) for loc in available_locations]

        col1, col2 = st.columns(2)

        with col1:
            selected_display = st.selectbox(
                "Select Location/City:",
                options=location_display_options,
                index=0,
                key="browse_location"
            )
            # Get the actual location key from the display name
            selected_location = available_locations[location_display_options.index(selected_display)]

        # Get available strategies for selected location
        available_strategies = list(all_templates[selected_location].keys())

        with col2:
            selected_strategy = st.selectbox(
                "Select Spending Strategy:",
                options=available_strategies,
                index=0,
                key="browse_strategy"
            )

        # Display template details
        template = all_templates[selected_location][selected_strategy]

        st.markdown("---")
        st.subheader(f"ðŸ“‹ {get_location_display_name(selected_location)} - {selected_strategy} Strategy")

        # Show template as visualization and table
        col_chart, col_table = st.columns([1, 1])

        with col_chart:
            # Create pie chart
            categories = list(template.keys())
            amounts = list(template.values())

            fig = go.Figure(data=[go.Pie(
                labels=categories,
                values=amounts,
                hole=0.4,
                textinfo='label+percent',
                marker=dict(colors=px.colors.qualitative.Set3)
            )])

            fig.update_layout(
                title=f"Expense Breakdown",
                height=400,
                showlegend=True
            )

            st.plotly_chart(fig, use_container_width=True)

        with col_table:
            # Create detailed table
            template_df = pd.DataFrame({
                'Category': categories,
                'Annual Amount': [f"${amt:,.0f}" for amt in amounts],
                'Monthly Amount': [f"${amt/12:,.0f}" for amt in amounts]
            })

            st.dataframe(template_df, hide_index=True, use_container_width=True)

            total = sum(amounts)
            st.metric("Total Annual Expenses", f"${total:,.0f}")
            st.caption(f"Monthly: ${total/12:,.0f}")

        # Quick load button
        st.markdown("---")
        col_load1, col_load2 = st.columns([3, 1])

        with col_load1:
            st.markdown(f"**Load this template into your current expenses?**")
            st.caption("This will replace your current expense values with this template.")

        with col_load2:
            if st.button("ðŸ“¥ Load Template", type="primary", key="load_template_btn"):
                for category, amount in template.items():
                    if category in st.session_state.expenses:
                        st.session_state.expenses[category] = amount
                st.success(f"âœ… Loaded {selected_strategy} template for {get_location_display_name(selected_location)}!")
                st.rerun()

    # TAB 2: Edit Templates
    with expense_tab2:
        st.subheader("âœï¸ Edit and Save Templates")

        st.markdown("""
        Modify expense templates and save them. You can:
        - Edit existing built-in templates (saved as custom versions)
        - Modify your custom templates
        - Create variations of existing templates
        """)

        # Select template to edit
        all_templates = {**FAMILY_EXPENSE_TEMPLATES, **st.session_state.custom_family_templates}
        available_locations = sorted(all_templates.keys())
        location_display_options = [get_location_display_name(loc) for loc in available_locations]

        col1, col2, col3 = st.columns(3)

        with col1:
            edit_display = st.selectbox(
                "Location to Edit:",
                options=location_display_options,
                key="edit_location"
            )
            edit_location = available_locations[location_display_options.index(edit_display)]

        available_strategies = list(all_templates[edit_location].keys())

        with col2:
            edit_strategy = st.selectbox(
                "Strategy to Edit:",
                options=available_strategies,
                key="edit_strategy"
            )

        with col3:
            save_as_new = st.checkbox("Save as new strategy", value=False, key="save_as_new")

        # Load template for editing
        current_template = all_templates[edit_location][edit_strategy].copy()

        st.markdown("---")
        st.markdown(f"### Editing: {get_location_display_name(edit_location)} - {edit_strategy}")

        # Edit each category
        edited_template = {}

        for category, value in current_template.items():
            col_cat, col_val = st.columns([2, 1])

            with col_cat:
                st.markdown(f"**{category}**")

            with col_val:
                new_value = st.number_input(
                    f"Amount for {category}",
                    min_value=0.0,
                    max_value=1000000.0,
                    value=float(value),
                    step=100.0,
                    key=f"edit_{category}",
                    label_visibility="collapsed"
                )
                edited_template[category] = new_value

        # Show total
        total_edited = sum(edited_template.values())
        st.metric("Total Annual Expenses", f"${total_edited:,.0f}")

        # Save options
        st.markdown("---")
        st.subheader("ðŸ’¾ Save Changes")

        if save_as_new:
            new_strategy_name = st.text_input(
                "New Strategy Name:",
                value=f"{edit_strategy} (Modified)",
                key="new_strategy_name"
            )
        else:
            new_strategy_name = edit_strategy

        col_save1, col_save2 = st.columns([3, 1])

        with col_save1:
            if save_as_new:
                st.info(f"Will save as: **{get_location_display_name(edit_location)} - {new_strategy_name}**")
            else:
                st.warning(f"âš ï¸ Will overwrite: **{get_location_display_name(edit_location)} - {edit_strategy}** (saved as custom template)")

        with col_save2:
            if st.button("ðŸ’¾ Save Template", type="primary", key="save_edited_template"):
                # Initialize location if needed
                if edit_location not in st.session_state.custom_family_templates:
                    st.session_state.custom_family_templates[edit_location] = {}

                # Save the template
                st.session_state.custom_family_templates[edit_location][new_strategy_name] = edited_template.copy()

                st.success(f"âœ… Saved template: {get_location_display_name(edit_location)} - {new_strategy_name}")
                st.rerun()

    # TAB 3: Create Custom City
    with expense_tab3:
        st.subheader("ðŸŒ Create Custom City/Location Template")

        st.markdown("""
        Create a brand new location template from scratch or copy an existing one as a starting point.
        """)

        # Option to copy from existing or start fresh
        creation_mode = st.radio(
            "Creation Mode:",
            options=["Start from scratch", "Copy from existing template"],
            horizontal=True,
            key="creation_mode"
        )

        # New city name
        new_city_name = st.text_input(
            "New City/Location Name:",
            value="",
            placeholder="e.g., Miami, FL, USA or London, UK",
            key="new_city_name",
            help="Include city, state (for USA), and country for clarity"
        )

        new_strategy_name_city = st.text_input(
            "Strategy Name:",
            value="Average",
            key="new_strategy_name_city"
        )

        if creation_mode == "Copy from existing template":
            # Select template to copy
            all_templates = {**FAMILY_EXPENSE_TEMPLATES, **st.session_state.custom_family_templates}
            available_locations = sorted(all_templates.keys())
            location_display_options = [get_location_display_name(loc) for loc in available_locations]

            col1, col2 = st.columns(2)

            with col1:
                copy_display = st.selectbox(
                    "Copy from Location:",
                    options=location_display_options,
                    key="copy_location"
                )
                copy_location = available_locations[location_display_options.index(copy_display)]

            available_strategies = list(all_templates[copy_location].keys())

            with col2:
                copy_strategy = st.selectbox(
                    "Copy from Strategy:",
                    options=available_strategies,
                    key="copy_strategy"
                )

            # Load template to use as base
            base_template = all_templates[copy_location][copy_strategy].copy()
        else:
            # Start with default categories and zero values
            base_template = {
                'Food & Groceries': 0.0,
                'Clothing': 0.0,
                'Transportation': 0.0,
                'Entertainment & Activities': 0.0,
                'Personal Care': 0.0,
                'Parent Retirement Help': 0.0,
                'Other Expenses': 0.0
            }

        st.markdown("---")
        st.subheader(f"ðŸ’µ Set Expense Values for {new_city_name if new_city_name else '(enter city name above)'}")

        # Edit template values
        new_template = {}

        for category, value in base_template.items():
            col_cat, col_val = st.columns([2, 1])

            with col_cat:
                st.markdown(f"**{category}**")

            with col_val:
                new_value = st.number_input(
                    f"Amount for {category}",
                    min_value=0.0,
                    max_value=1000000.0,
                    value=float(value),
                    step=100.0,
                    key=f"new_{category}",
                    label_visibility="collapsed"
                )
                new_template[category] = new_value

        # Show total
        total_new = sum(new_template.values())
        st.metric("Total Annual Expenses", f"${total_new:,.0f}")

        # Create button
        st.markdown("---")
        col_create1, col_create2 = st.columns([3, 1])

        with col_create1:
            if new_city_name:
                st.info(f"Will create: **{new_city_name} - {new_strategy_name_city}**")
            else:
                st.warning("âš ï¸ Please enter a city name above")

        with col_create2:
            if st.button("ðŸŒ Create City", type="primary", key="create_city_btn", disabled=not new_city_name):
                # Initialize location
                if new_city_name not in st.session_state.custom_family_templates:
                    st.session_state.custom_family_templates[new_city_name] = {}

                # Save the template
                st.session_state.custom_family_templates[new_city_name][new_strategy_name_city] = new_template.copy()

                st.success(f"âœ… Created new city: {new_city_name} - {new_strategy_name_city}!")
                st.balloons()
                st.rerun()

    # Show current expenses section at bottom (always visible)
    st.markdown("---")
    st.subheader("ðŸ’³ Your Current Annual Family Expenses")

    current_state, current_strategy = get_state_for_year(st.session_state.current_year)
    st.info(f"ðŸ“ Current State from Timeline: **{current_state}** | Strategy: **{current_strategy}**")

    for category in st.session_state.expense_categories:
        col1, col2 = st.columns([3, 1])
        with col1:
            amount = st.number_input(
                f"{category}",
                min_value=0.0,
                max_value=1000000.0,
                value=float(st.session_state.expenses.get(category, 0.0)),
                step=100.0,
                format="%.0f",
                key=f"expense_{category}"
            )
            st.session_state.expenses[category] = amount
        with col2:
            st.caption(format_currency(amount))

    total_expenses = sum(st.session_state.expenses.values())
    st.metric("Total Annual Family Expenses", format_currency(total_expenses))

    # Tax Settings
    st.subheader("ðŸ’¼ Tax Settings")
    col1, col2 = st.columns(2)

    with col1:
        st.session_state.state_tax_rate = st.number_input(
            "State Tax Rate (%)",
            min_value=0.0,
            max_value=15.0,
            value=float(st.session_state.state_tax_rate),
            step=0.1,
            format="%.2f"
        )

    with col2:
        st.session_state.pretax_401k = st.number_input(
            "Pre-tax 401k Contribution ($)",
            min_value=0.0,
            max_value=100000.0,
            value=float(st.session_state.pretax_401k),
            step=500.0,
            format="%.0f"
        )

    # Major Purchases
    st.subheader("ðŸ›’ Major Purchases")

    if st.button("âž• Add Major Purchase"):
        new_purchase = MajorPurchase(
            name="New Purchase",
            year=st.session_state.current_year,
            amount=50000.0,
            financing_years=0,
            interest_rate=0.0,
            asset_type="Expense",
            appreciation_rate=0.0
        )
        st.session_state.major_purchases.append(new_purchase)
        st.rerun()

    for idx, purchase in enumerate(st.session_state.major_purchases):
        with st.expander(f"ðŸ›ï¸ {purchase.name} - {format_currency(purchase.amount)} ({purchase.year})"):
            col1, col2, col3 = st.columns(3)

            with col1:
                purchase.name = st.text_input("Name", value=purchase.name, key=f"mp_name_{idx}")
                purchase.year = st.number_input("Year", min_value=2020, max_value=2100, value=purchase.year, key=f"mp_year_{idx}")
                purchase.amount = st.number_input("Amount ($)", min_value=0.0, value=float(purchase.amount), step=1000.0, key=f"mp_amount_{idx}")

            with col2:
                purchase.asset_type = st.selectbox(
                    "Asset Type",
                    ["Expense", "Real Estate", "Vehicle", "Investment"],
                    index=["Expense", "Real Estate", "Vehicle", "Investment"].index(purchase.asset_type) if purchase.asset_type in ["Expense", "Real Estate", "Vehicle", "Investment"] else 0,
                    key=f"mp_asset_type_{idx}"
                )
                purchase.appreciation_rate = st.number_input(
                    "Appreciation Rate (% per year)",
                    min_value=-20.0,
                    max_value=50.0,
                    value=float(purchase.appreciation_rate * 100),
                    step=0.5,
                    key=f"mp_appreciation_{idx}"
                ) / 100.0

            with col3:
                purchase.financing_years = st.number_input("Financing Years", min_value=0, max_value=30, value=purchase.financing_years, key=f"mp_financing_{idx}")
                purchase.interest_rate = st.number_input(
                    "Interest Rate (%)",
                    min_value=0.0,
                    max_value=20.0,
                    value=float(purchase.interest_rate * 100),
                    step=0.1,
                    key=f"mp_interest_{idx}"
                ) / 100.0

            if st.button(f"ðŸ—‘ï¸ Delete {purchase.name}", key=f"delete_mp_{idx}"):
                st.session_state.major_purchases.pop(idx)
                st.rerun()

    # Recurring Expenses
    st.subheader("ðŸ”„ Recurring Expenses")

    if st.button("âž• Add Recurring Expense"):
        new_recurring = RecurringExpense(
            name="New Recurring",
            category="Other",
            amount=10000.0,
            frequency_years=5,
            start_year=st.session_state.current_year,
            end_year=None,
            inflation_adjust=True,
            parent="Both",
            financing_years=0,
            interest_rate=0.0
        )
        st.session_state.recurring_expenses.append(new_recurring)
        st.rerun()

    for idx, recurring in enumerate(st.session_state.recurring_expenses):
        with st.expander(f"ðŸ” {recurring.name} - Every {recurring.frequency_years} years"):
            col1, col2, col3 = st.columns(3)

            with col1:
                recurring.name = st.text_input("Name", value=recurring.name, key=f"re_name_{idx}")
                recurring.category = st.text_input("Category", value=recurring.category, key=f"re_category_{idx}")
                recurring.amount = st.number_input("Amount ($)", min_value=0.0, value=float(recurring.amount), step=1000.0, key=f"re_amount_{idx}")

            with col2:
                recurring.frequency_years = st.number_input("Frequency (years)", min_value=1, max_value=50, value=recurring.frequency_years, key=f"re_freq_{idx}")
                recurring.start_year = st.number_input("Start Year", min_value=2020, max_value=2100, value=recurring.start_year, key=f"re_start_{idx}")
                end_year_value = recurring.end_year if recurring.end_year is not None else 2100
                end_year = st.number_input("End Year (or max for no end)", min_value=recurring.start_year, max_value=2100, value=end_year_value, key=f"re_end_{idx}")
                recurring.end_year = end_year if end_year < 2100 else None

            with col3:
                recurring.inflation_adjust = st.checkbox("Inflation Adjust", value=recurring.inflation_adjust, key=f"re_inflate_{idx}")
                owner_options = ["Both", st.session_state.parent1_name, st.session_state.parent2_name]
                # Map old values to new values for backwards compatibility
                if recurring.parent == "ParentX":
                    recurring.parent = st.session_state.parent1_name
                elif recurring.parent == "ParentY":
                    recurring.parent = st.session_state.parent2_name
                recurring.parent = st.selectbox("Owner", owner_options, index=owner_options.index(recurring.parent) if recurring.parent in owner_options else 0, key=f"re_parent_{idx}")
                recurring.financing_years = st.number_input("Financing Years", min_value=0, max_value=30, value=recurring.financing_years, key=f"re_financing_{idx}")
                recurring.interest_rate = st.number_input(
                    "Interest Rate (%)",
                    min_value=0.0,
                    max_value=20.0,
                    value=float(recurring.interest_rate * 100),
                    step=0.1,
                    key=f"re_interest_{idx}"
                ) / 100.0

            if st.button(f"ðŸ—‘ï¸ Delete {recurring.name}", key=f"delete_re_{idx}"):
                st.session_state.recurring_expenses.pop(idx)
                st.rerun()


def children_tab():
    """Children tab"""
    st.header("ðŸ‘¶ Children")

    st.subheader("Add a Child")
    col1, col2, col3 = st.columns(3)

    with col1:
        child_name = st.text_input("Child Name", key="new_child_name")
    with col2:
        child_birth_year = st.number_input(
            "Birth Year",
            min_value=1990,
            max_value=st.session_state.current_year + 20,
            value=st.session_state.current_year,
            key="new_child_birth_year"
        )
    with col3:
        st.write("")  # Spacing
        st.write("")  # Spacing
        if st.button("âž• Add Child"):
            # Check for duplicate names
            if any(child['name'] == child_name for child in st.session_state.children_list):
                st.error(f"A child named '{child_name}' already exists. Please use a different name.")
            elif child_name.strip() == "":
                st.error("Please enter a child name.")
            else:
                st.session_state.children_list.append({
                    'name': child_name,
                    'birth_year': child_birth_year,
                    'use_template': True,
                    'template_state': 'Seattle',
                    'template_strategy': 'Average',
                    'school_type': 'Public',  # K-12: Public or Private
                    'college_type': 'Public',  # College: Public or Private
                    'college_location': 'Seattle'  # Where they attend college
                })
                st.success(f"Added {child_name}")
                st.rerun()

    # Display existing children
    if st.session_state.children_list:
        st.subheader("Your Children")

        for idx, child in enumerate(st.session_state.children_list):
            current_age = st.session_state.current_year - child['birth_year']

            with st.expander(f"ðŸ‘¶ {child['name']} (Age {current_age}, Born {child['birth_year']})"):
                col1, col2, col3 = st.columns(3)

                with col1:
                    child['name'] = st.text_input("Name", value=child['name'], key=f"child_name_{idx}")
                    child['birth_year'] = st.number_input(
                        "Birth Year",
                        min_value=1990,
                        max_value=st.session_state.current_year + 20,
                        value=child['birth_year'],
                        key=f"child_birth_{idx}"
                    )

                with col2:
                    child['use_template'] = st.checkbox(
                        "Use State Template",
                        value=child.get('use_template', True),
                        key=f"child_template_{idx}"
                    )

                    if child['use_template']:
                        child['template_state'] = st.selectbox(
                            "Template Location",
                            AVAILABLE_LOCATIONS_CHILDREN,
                            index=AVAILABLE_LOCATIONS_CHILDREN.index(child.get('template_state', 'Seattle')) if child.get('template_state', 'Seattle') in AVAILABLE_LOCATIONS_CHILDREN else 1,
                            key=f"child_state_{idx}"
                        )
                        child['template_strategy'] = st.selectbox(
                            "Spending Level",
                            ["Conservative", "Average", "High-end"],
                            index=["Conservative", "Average", "High-end"].index(child.get('template_strategy', 'Average')),
                            key=f"child_strategy_{idx}"
                        )

                with col3:
                    st.write("")  # Spacing
                    st.write("")  # Spacing
                    if st.button(f"ðŸ—‘ï¸ Remove {child['name']}", key=f"remove_child_{idx}"):
                        st.session_state.children_list.pop(idx)
                        st.rerun()

                # Add new row for school type and college location
                st.markdown("---")
                col1, col2, col3 = st.columns(3)

                with col1:
                    child['school_type'] = st.selectbox(
                        "K-12 School Type",
                        ["Public", "Private"],
                        index=["Public", "Private"].index(child.get('school_type', 'Public')),
                        key=f"child_school_{idx}",
                        help="Private schools typically add $10k-30k/year to education costs"
                    )

                with col2:
                    child['college_type'] = st.selectbox(
                        "College Type",
                        ["Public", "Private"],
                        index=["Public", "Private"].index(child.get('college_type', 'Public')),
                        key=f"child_college_type_{idx}",
                        help="Private colleges typically cost 2-3x more than public colleges"
                    )

                with col3:
                    child['college_location'] = st.selectbox(
                        "College Location",
                        AVAILABLE_LOCATIONS_CHILDREN,
                        index=AVAILABLE_LOCATIONS_CHILDREN.index(child.get('college_location', 'Seattle')) if child.get('college_location', 'Seattle') in AVAILABLE_LOCATIONS_CHILDREN else 0,
                        key=f"child_college_{idx}",
                        help="Location where child will attend college (ages 18-21). Room & board included."
                    )
    else:
        st.info("No children added yet. Add children using the form above.")

    # Children expense templates preview
    st.subheader("ðŸ“Š Children Expense Templates Preview")

    preview_state = st.selectbox("Preview Location", AVAILABLE_LOCATIONS_CHILDREN, key="preview_state")
    preview_strategy = st.selectbox("Preview Strategy", ["Conservative", "Average", "High-end"], key="preview_strategy")

    if preview_state in CHILDREN_EXPENSE_TEMPLATES and preview_strategy in CHILDREN_EXPENSE_TEMPLATES[preview_state]:
        template = CHILDREN_EXPENSE_TEMPLATES[preview_state][preview_strategy]

        # Create a preview dataframe
        preview_df = pd.DataFrame({
            'Age': list(range(31)),
            **{category: values for category, values in template.items()}
        })

        st.dataframe(preview_df, use_container_width=True, height=400)

        # Show totals by age
        age_totals = preview_df.set_index('Age').sum(axis=1)

        fig = go.Figure()
        fig.add_trace(go.Bar(
            x=list(range(31)),
            y=age_totals.values,
            name="Total Annual Expenses"
        ))
        fig.update_layout(
            title=f"Total Annual Child Expenses by Age - {preview_state} {preview_strategy}",
            xaxis_title="Child Age",
            yaxis_title="Annual Expenses ($)",
            height=400
        )
        st.plotly_chart(fig, use_container_width=True)


def house_tab():
    """House portfolio tab"""
    st.header("ðŸ  House Portfolio")

    if st.button("âž• Add House"):
        new_house = House(
            name="New Property",
            purchase_year=st.session_state.current_year,
            purchase_price=500000.0,
            current_value=500000.0,
            mortgage_balance=400000.0,
            mortgage_rate=0.065,
            mortgage_years_left=30,
            property_tax_rate=0.01,
            home_insurance=1500.0,
            maintenance_rate=0.01,
            upkeep_costs=3000.0,
            owner="Shared",
            timeline=[HouseTimelineEntry(st.session_state.current_year, "Own_Live", 0.0)]
        )
        st.session_state.houses.append(new_house)
        st.rerun()

    for idx, house in enumerate(st.session_state.houses):
        monthly_payment = calculate_monthly_house_payment(house)
        annual_payment = monthly_payment * 12

        with st.expander(f"ðŸ¡ {house.name} - {format_currency(house.current_value)} (Monthly: {format_currency(monthly_payment)})"):
            col1, col2, col3 = st.columns(3)

            with col1:
                st.subheader("Basic Information")
                house.name = st.text_input("Property Name", value=house.name, key=f"house_name_{idx}")
                house.purchase_year = st.number_input("Purchase Year", min_value=1950, max_value=2100, value=house.purchase_year, key=f"house_pyear_{idx}")
                house.purchase_price = st.number_input("Purchase Price ($)", min_value=0.0, value=float(house.purchase_price), step=10000.0, key=f"house_pprice_{idx}")
                house.current_value = st.number_input("Current Value ($)", min_value=0.0, value=float(house.current_value), step=10000.0, key=f"house_cvalue_{idx}")
                st.caption(f"Formatted: {format_currency(house.current_value)}")

            with col2:
                st.subheader("Mortgage Information")
                house.mortgage_balance = st.number_input("Mortgage Balance ($)", min_value=0.0, value=float(house.mortgage_balance), step=10000.0, key=f"house_mbalance_{idx}")
                house.mortgage_rate = st.number_input(
                    "Mortgage Rate (%)",
                    min_value=0.0,
                    max_value=20.0,
                    value=float(house.mortgage_rate * 100),
                    step=0.1,
                    key=f"house_mrate_{idx}"
                ) / 100.0
                house.mortgage_years_left = st.number_input("Years Left", min_value=0, max_value=50, value=house.mortgage_years_left, key=f"house_myears_{idx}")

            with col3:
                st.subheader("Annual Costs")
                house.property_tax_rate = st.number_input(
                    "Property Tax Rate (%)",
                    min_value=0.0,
                    max_value=5.0,
                    value=float(house.property_tax_rate * 100),
                    step=0.01,
                    key=f"house_ptax_{idx}"
                ) / 100.0
                house.home_insurance = st.number_input("Home Insurance ($/year)", min_value=0.0, value=float(house.home_insurance), step=100.0, key=f"house_insurance_{idx}")
                house.maintenance_rate = st.number_input(
                    "Maintenance Rate (% of value)",
                    min_value=0.0,
                    max_value=10.0,
                    value=float(house.maintenance_rate * 100),
                    step=0.1,
                    key=f"house_maint_{idx}"
                ) / 100.0
                house.upkeep_costs = st.number_input("Additional Upkeep ($/year)", min_value=0.0, value=float(house.upkeep_costs), step=100.0, key=f"house_upkeep_{idx}")

            owner_options = ["Shared", st.session_state.parent1_name, st.session_state.parent2_name]
            # Map old values to new values for backwards compatibility
            if house.owner == "ParentX":
                house.owner = st.session_state.parent1_name
            elif house.owner == "ParentY":
                house.owner = st.session_state.parent2_name
            house.owner = st.selectbox(
                "Owner",
                owner_options,
                index=owner_options.index(house.owner) if house.owner in owner_options else 0,
                key=f"house_owner_{idx}"
            )

            # Timeline
            st.subheader("Property Timeline")
            st.markdown("Define how the property status changes over time")

            timeline_data = []
            for entry in house.timeline:
                timeline_data.append({
                    'Year': entry.year,
                    'Status': entry.status,
                    'Rental Income': entry.rental_income
                })

            timeline_df = pd.DataFrame(timeline_data)
            edited_timeline = st.data_editor(
                timeline_df,
                num_rows="dynamic",
                column_config={
                    "Status": st.column_config.SelectboxColumn(
                        "Status",
                        options=["Own_Live", "Own_Rent", "Sold"],
                        required=True
                    )
                },
                key=f"house_timeline_{idx}"
            )

            # Update timeline
            house.timeline = [
                HouseTimelineEntry(row['Year'], row['Status'], row['Rental Income'])
                for _, row in edited_timeline.iterrows()
            ]

            # Payment breakdown
            st.subheader("Payment Breakdown")
            col1, col2, col3 = st.columns(3)
            with col1:
                st.metric("Monthly Payment (PITI)", format_currency(monthly_payment))
            with col2:
                st.metric("Annual Payment", format_currency(annual_payment))
            with col3:
                annual_property_tax = house.current_value * house.property_tax_rate
                st.metric("Annual Property Tax", format_currency(annual_property_tax))

            if st.button(f"ðŸ—‘ï¸ Delete {house.name}", key=f"delete_house_{idx}"):
                st.session_state.houses.pop(idx)
                st.rerun()


def portfolio_allocation_tab():
    """NEW: Portfolio allocation tab"""
    st.header("ðŸ’¼ Portfolio Allocation")

    st.markdown("""
    Define how your investment portfolio is allocated across different asset classes.
    This helps track your diversification and risk profile.
    """)

    col1, col2 = st.columns([2, 1])

    with col1:
        st.subheader("Asset Allocation")

        allocation = st.session_state.portfolio_allocation

        allocation.stocks = st.slider(
            "ðŸ“ˆ Stocks (%)",
            min_value=0.0,
            max_value=100.0,
            value=float(allocation.stocks),
            step=0.5,
            key="alloc_stocks"
        )

        allocation.bonds = st.slider(
            "ðŸ“Š Bonds (%)",
            min_value=0.0,
            max_value=100.0,
            value=float(allocation.bonds),
            step=0.5,
            key="alloc_bonds"
        )

        allocation.cash = st.slider(
            "ðŸ’µ Cash (%)",
            min_value=0.0,
            max_value=100.0,
            value=float(allocation.cash),
            step=0.5,
            key="alloc_cash"
        )

        allocation.real_estate = st.slider(
            "ðŸ  Real Estate (%)",
            min_value=0.0,
            max_value=100.0,
            value=float(allocation.real_estate),
            step=0.5,
            key="alloc_real_estate"
        )

        allocation.other = st.slider(
            "ðŸ”§ Other (%)",
            min_value=0.0,
            max_value=100.0,
            value=float(allocation.other),
            step=0.5,
            key="alloc_other"
        )

    with col2:
        st.subheader("Allocation Summary")

        total_allocation = allocation.total()

        if allocation.is_valid():
            st.success(f"âœ… Total: {total_allocation:.1f}%")
        else:
            st.error(f"âŒ Total: {total_allocation:.1f}%")
            st.warning("Allocation should total 100%")

        # Pie chart
        fig = go.Figure(data=[go.Pie(
            labels=['Stocks', 'Bonds', 'Cash', 'Real Estate', 'Other'],
            values=[allocation.stocks, allocation.bonds, allocation.cash, allocation.real_estate, allocation.other],
            hole=.3
        )])
        fig.update_layout(title="Portfolio Allocation", height=400)
        st.plotly_chart(fig, use_container_width=True)

        # Breakdown table
        st.markdown("### Breakdown")
        breakdown_df = pd.DataFrame({
            'Asset Class': ['Stocks', 'Bonds', 'Cash', 'Real Estate', 'Other'],
            'Allocation %': [allocation.stocks, allocation.bonds, allocation.cash, allocation.real_estate, allocation.other]
        })
        st.dataframe(breakdown_df, use_container_width=True, hide_index=True)


def economy_tab():
    """Economy scenarios tab"""
    st.header("ðŸ“ˆ Economy & Market Scenarios")

    st.subheader("Economic Scenarios")

    scenario_names = list(st.session_state.economic_scenarios.keys())

    col1, col2 = st.columns([1, 2])

    with col1:
        st.session_state.active_scenario = st.selectbox(
            "Active Scenario",
            scenario_names,
            index=scenario_names.index(st.session_state.active_scenario) if st.session_state.active_scenario in scenario_names else 0
        )

    with col2:
        active = st.session_state.economic_scenarios[st.session_state.active_scenario]
        st.info(f"**{active.name}**: {active.investment_return*100:.1f}% return, {active.inflation_rate*100:.1f}% inflation")

    # Display all scenarios
    for scenario_name, scenario in st.session_state.economic_scenarios.items():
        with st.expander(f"ðŸ“Š {scenario_name} Scenario" + (" â­ (Active)" if scenario_name == st.session_state.active_scenario else "")):
            col1, col2, col3, col4 = st.columns(4)

            with col1:
                new_inv_return = st.number_input(
                    "Investment Return (%)",
                    min_value=-20.0,
                    max_value=50.0,
                    value=float(scenario.investment_return * 100),
                    step=0.5,
                    key=f"scenario_{scenario_name}_return"
                )
                scenario.investment_return = new_inv_return / 100.0

            with col2:
                new_inflation = st.number_input(
                    "Inflation Rate (%)",
                    min_value=-5.0,
                    max_value=20.0,
                    value=float(scenario.inflation_rate * 100),
                    step=0.1,
                    key=f"scenario_{scenario_name}_inflation"
                )
                scenario.inflation_rate = new_inflation / 100.0

            with col3:
                new_expense_growth = st.number_input(
                    "Expense Growth (%)",
                    min_value=-5.0,
                    max_value=20.0,
                    value=float(scenario.expense_growth_rate * 100),
                    step=0.1,
                    key=f"scenario_{scenario_name}_expense"
                )
                scenario.expense_growth_rate = new_expense_growth / 100.0

            with col4:
                new_healthcare_inflation = st.number_input(
                    "Healthcare Inflation (%)",
                    min_value=-5.0,
                    max_value=30.0,
                    value=float(scenario.healthcare_inflation_rate * 100),
                    step=0.5,
                    key=f"scenario_{scenario_name}_healthcare"
                )
                scenario.healthcare_inflation_rate = new_healthcare_inflation / 100.0

    # Historical Market Data
    st.subheader("ðŸ“œ Historical S&P 500 Returns")

    stats = get_historical_return_stats()

    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.metric("Mean Return", f"{stats['mean']*100:.2f}%")
    with col2:
        st.metric("Median Return", f"{stats['median']*100:.2f}%")
    with col3:
        st.metric("Std Deviation", f"{stats['std']*100:.2f}%")
    with col4:
        st.metric("Positive Years", f"{stats['positive_percentage']:.1f}%")

    # Historical returns chart
    fig = go.Figure()
    fig.add_trace(go.Bar(
        x=list(range(1924, 1924 + len(HISTORICAL_STOCK_RETURNS))),
        y=[r * 100 for r in HISTORICAL_STOCK_RETURNS],
        marker_color=['green' if r > 0 else 'red' for r in HISTORICAL_STOCK_RETURNS],
        name="Annual Return %"
    ))
    fig.update_layout(
        title="Historical S&P 500 Annual Returns (1924-2023)",
        xaxis_title="Year",
        yaxis_title="Return (%)",
        height=400
    )
    st.plotly_chart(fig, use_container_width=True)


def retirement_tab():
    """Retirement planning tab"""
    st.header("ðŸ–¼ï¸ Retirement Planning")

    # Calculate retirement years
    parentX_birth_year = st.session_state.current_year - st.session_state.parentX_age
    parentY_birth_year = st.session_state.current_year - st.session_state.parentY_age

    parentX_retirement_year = parentX_birth_year + st.session_state.parentX_retirement_age
    parentY_retirement_year = parentY_birth_year + st.session_state.parentY_retirement_age

    col1, col2 = st.columns(2)

    with col1:
        st.subheader(f"{st.session_state.parent1_emoji} {st.session_state.parent1_name}")
        st.metric("Retirement Year", parentX_retirement_year)
        st.metric("Years Until Retirement", max(0, parentX_retirement_year - st.session_state.current_year))
        st.metric("Monthly SS Benefit", format_currency(st.session_state.parentX_ss_benefit))
        st.metric("Annual SS Benefit", format_currency(st.session_state.parentX_ss_benefit * 12))

    with col2:
        st.subheader(f"{st.session_state.parent2_emoji} {st.session_state.parent2_name}")
        st.metric("Retirement Year", parentY_retirement_year)
        st.metric("Years Until Retirement", max(0, parentY_retirement_year - st.session_state.current_year))
        st.metric("Monthly SS Benefit", format_currency(st.session_state.parentY_ss_benefit))
        st.metric("Annual SS Benefit", format_currency(st.session_state.parentY_ss_benefit * 12))

    # Social Security Insolvency Settings
    st.subheader("ðŸ”´ Social Security Insolvency Modeling")

    col1, col2 = st.columns(2)

    with col1:
        st.session_state.ss_insolvency_enabled = st.checkbox(
            "Enable SS Insolvency Modeling",
            value=st.session_state.ss_insolvency_enabled,
            help="Model potential Social Security benefit shortfall"
        )

    with col2:
        st.session_state.ss_shortfall_percentage = st.number_input(
            "Benefit Shortfall (%)",
            min_value=0.0,
            max_value=100.0,
            value=float(st.session_state.ss_shortfall_percentage),
            step=1.0,
            help="Percentage reduction in benefits after insolvency (default 30%)",
            disabled=not st.session_state.ss_insolvency_enabled
        )

    if st.session_state.ss_insolvency_enabled:
        st.warning(f"âš ï¸ Modeling {st.session_state.ss_shortfall_percentage}% benefit reduction after 2034")

        # Show impact
        parentX_reduced = st.session_state.parentX_ss_benefit * (1 - st.session_state.ss_shortfall_percentage / 100)
        parentY_reduced = st.session_state.parentY_ss_benefit * (1 - st.session_state.ss_shortfall_percentage / 100)

        st.info(f"""
        **After insolvency:**
        - {st.session_state.parent1_name}: {format_currency(st.session_state.parentX_ss_benefit)}/mo â†’ {format_currency(parentX_reduced)}/mo
        - {st.session_state.parent2_name}: {format_currency(st.session_state.parentY_ss_benefit)}/mo â†’ {format_currency(parentY_reduced)}/mo
        """)


def timeline_tab():
    """Timeline and state relocation tab"""
    st.header("ðŸ—“ï¸ Timeline & State Planning")

    st.markdown("""
    Plan your relocations and spending strategy changes over time.
    Expenses will automatically adjust based on state and spending level.
    """)

    st.subheader("State & Spending Timeline")

    # Convert timeline to DataFrame
    timeline_data = []
    for entry in st.session_state.state_timeline:
        timeline_data.append({
            'Year': entry.year,
            'State': entry.state,
            'Spending Strategy': entry.spending_strategy
        })

    timeline_df = pd.DataFrame(timeline_data)

    edited_timeline = st.data_editor(
        timeline_df,
        num_rows="dynamic",
        column_config={
            "State": st.column_config.SelectboxColumn(
                "Location",
                options=AVAILABLE_LOCATIONS_FAMILY,
                required=True,
                help="Select your living location - expenses will adjust automatically"
            ),
            "Spending Strategy": st.column_config.SelectboxColumn(
                "Spending Strategy",
                options=["Conservative", "Average", "High-end"],
                required=True
            )
        },
        use_container_width=True
    )

    # Update state timeline
    st.session_state.state_timeline = [
        StateTimelineEntry(row['Year'], row['State'], row['Spending Strategy'])
        for _, row in edited_timeline.iterrows()
    ]

    # Visualization
    if len(edited_timeline) > 0:
        st.subheader("Timeline Visualization")

        # Calculate when both parents reach age 100
        parent1_100_year = (st.session_state.current_year - st.session_state.parentX_age) + 100
        parent2_100_year = (st.session_state.current_year - st.session_state.parentY_age) + 100
        end_year = max(parent1_100_year, parent2_100_year)

        # Create timeline data for all years from current to end
        all_years = list(range(st.session_state.current_year, end_year + 1))

        # Create a horizontal timeline showing state/spending for each year
        timeline_states = []
        timeline_spending = []

        for year in all_years:
            state, strategy = get_state_for_year(year)
            timeline_states.append(state)
            timeline_spending.append(strategy)

        # Create a Gantt-style timeline
        fig = go.Figure()

        # Group consecutive years with same state/strategy
        segments = []
        if timeline_states:
            current_state = timeline_states[0]
            current_strategy = timeline_spending[0]
            start_year = all_years[0]

            for i in range(1, len(all_years)):
                if timeline_states[i] != current_state or timeline_spending[i] != current_strategy:
                    # End of current segment
                    segments.append({
                        'state': current_state,
                        'strategy': current_strategy,
                        'start': start_year,
                        'end': all_years[i-1]
                    })
                    current_state = timeline_states[i]
                    current_strategy = timeline_spending[i]
                    start_year = all_years[i]

            # Add final segment
            segments.append({
                'state': current_state,
                'strategy': current_strategy,
                'start': start_year,
                'end': all_years[-1]
            })

        # Plot segments as horizontal bars
        for seg in segments:
            duration = seg['end'] - seg['start'] + 1
            fig.add_trace(go.Bar(
                x=[duration],
                y=['Timeline'],
                orientation='h',
                name=f"{seg['state']} - {seg['strategy']}",
                text=f"{seg['state']}<br>{seg['strategy']}<br>{seg['start']}-{seg['end']}",
                textposition='inside',
                hovertemplate=f"<b>{seg['state']}</b><br>{seg['strategy']}<br>Years: {seg['start']}-{seg['end']}<br>Duration: {duration} years<extra></extra>",
                base=seg['start']
            ))

        fig.update_layout(
            title=f"State & Spending Timeline (Until Both Parents Reach Age 100)",
            xaxis_title="Year",
            xaxis=dict(
                tickmode='linear',
                tick0=st.session_state.current_year,
                dtick=5,  # Show tick every 5 years
                range=[st.session_state.current_year, end_year]
            ),
            yaxis=dict(showticklabels=False),
            height=200,
            showlegend=True,
            barmode='stack',
            bargap=0
        )

        st.plotly_chart(fig, use_container_width=True)

        # Show key milestones
        st.markdown(f"**Timeline extends to {end_year}** ({st.session_state.parent1_name} age 100: {parent1_100_year}, {st.session_state.parent2_name} age 100: {parent2_100_year})")

        # Add world map visualization
        st.markdown("---")
        st.subheader("ðŸŒ World Map: Your Relocation Journey")

        # Get unique locations from timeline in chronological order
        timeline_locations = []
        seen_states = set()

        for entry in sorted(st.session_state.state_timeline, key=lambda x: x.year):
            if entry.state not in seen_states:
                timeline_locations.append({
                    'state': entry.state,
                    'year': entry.year,
                    'coords': LOCATION_COORDINATES.get(entry.state)
                })
                seen_states.add(entry.state)

        # Only show map if we have valid coordinates for at least 2 locations
        valid_locations = [loc for loc in timeline_locations if loc['coords'] is not None]

        if len(valid_locations) >= 2:
            # Create map figure
            map_fig = go.Figure()

            # Add flight path lines between consecutive locations
            for i in range(len(valid_locations) - 1):
                loc1 = valid_locations[i]
                loc2 = valid_locations[i + 1]

                # Add curved line (great circle route simulation)
                map_fig.add_trace(go.Scattergeo(
                    lon=[loc1['coords']['lon'], loc2['coords']['lon']],
                    lat=[loc1['coords']['lat'], loc2['coords']['lat']],
                    mode='lines',
                    line=dict(width=2, color='rgb(255, 100, 100)'),
                    opacity=0.6,
                    showlegend=False,
                    hoverinfo='skip'
                ))

            # Add location markers
            lats = [loc['coords']['lat'] for loc in valid_locations]
            lons = [loc['coords']['lon'] for loc in valid_locations]
            texts = [f"{get_location_display_name(loc['state'])}<br>Year: {loc['year']}" for loc in valid_locations]
            markers = [f"ðŸ“ {loc['state']}<br>{loc['year']}" for loc in valid_locations]

            map_fig.add_trace(go.Scattergeo(
                lon=lons,
                lat=lats,
                mode='markers+text',
                marker=dict(
                    size=15,
                    color='rgb(50, 120, 255)',
                    line=dict(width=3, color='white'),
                    symbol='circle'
                ),
                text=[f"{i+1}" for i in range(len(valid_locations))],  # Number each location
                textfont=dict(size=10, color='white', family='Arial Black'),
                textposition='middle center',
                hovertext=texts,
                hoverinfo='text',
                showlegend=False
            ))

            # Update map layout
            map_fig.update_layout(
                title=dict(
                    text='Your Life Journey: Where You\'ll Live',
                    font=dict(size=18)
                ),
                geo=dict(
                    projection_type='natural earth',
                    showland=True,
                    landcolor='rgb(243, 243, 243)',
                    coastlinecolor='rgb(204, 204, 204)',
                    countrycolor='rgb(204, 204, 204)',
                    showcountries=True,
                    showocean=True,
                    oceancolor='rgb(230, 245, 255)',
                    showlakes=True,
                    lakecolor='rgb(230, 245, 255)',
                    projection=dict(
                        rotation=dict(
                            lon=-60,  # Center roughly on Atlantic
                            lat=20
                        )
                    )
                ),
                height=600,
                margin=dict(l=0, r=0, t=50, b=0)
            )

            st.plotly_chart(map_fig, use_container_width=True)

            # Show location journey summary
            st.markdown("**ðŸ›« Your Relocation Journey:**")
            for i, loc in enumerate(valid_locations):
                if i == 0:
                    st.info(f"**{loc['year']}:** ðŸ  Start in {get_location_display_name(loc['state'])}")
                else:
                    prev_loc = valid_locations[i-1]
                    years_duration = loc['year'] - prev_loc['year']
                    st.success(f"**{loc['year']}:** âœˆï¸ Move to {get_location_display_name(loc['state'])} (after {years_duration} years in {get_location_display_name(prev_loc['state'])})")

        elif len(valid_locations) == 1:
            loc = valid_locations[0]
            st.info(f"ðŸ“ You're staying in **{get_location_display_name(loc['state'])}** throughout the timeline. Add more locations in the table above to see your relocation journey on the map!")
        else:
            st.warning("âš ï¸ No valid location coordinates found. Please ensure your timeline includes recognized locations.")

    # Show current and future states
    st.subheader("Timeline Summary")

    current_state, current_strategy = get_state_for_year(st.session_state.current_year)
    st.info(f"**Current ({st.session_state.current_year}):** {current_state} - {current_strategy}")

    # Show next 5 years
    st.markdown("**Upcoming Changes:**")
    for year in range(st.session_state.current_year + 1, st.session_state.current_year + 6):
        state, strategy = get_state_for_year(year)
        prev_state, prev_strategy = get_state_for_year(year - 1)

        if state != prev_state or strategy != prev_strategy:
            st.success(f"**{year}:** â†’ {state} - {strategy}")


def calculate_lifetime_cashflow():
    """
    Calculate detailed year-by-year cashflow for entire lifetime (current year to age 100).

    Returns:
        list: List of dictionaries with year-by-year financial data
    """
    # Calculate timeline end (when younger parent reaches 100)
    parent1_100_year = (st.session_state.current_year - st.session_state.parentX_age) + 100
    parent2_100_year = (st.session_state.current_year - st.session_state.parentY_age) + 100
    timeline_end = max(parent1_100_year, parent2_100_year)

    results = []
    cumulative_net_worth = st.session_state.parentX_net_worth + st.session_state.parentY_net_worth

    for year in range(st.session_state.current_year, timeline_end + 1):
        # Calculate ages
        parent1_age = st.session_state.parentX_age + (year - st.session_state.current_year)
        parent2_age = st.session_state.parentY_age + (year - st.session_state.current_year)

        # Calculate income
        parent1_working = parent1_age < st.session_state.parentX_retirement_age
        parent2_working = parent2_age < st.session_state.parentY_retirement_age

        parent1_income = 0
        parent2_income = 0
        ss_income = 0

        if parent1_working:
            parent1_income = get_income_for_year(
                st.session_state.parentX_income,
                st.session_state.parentX_raise,
                st.session_state.parentX_job_changes,
                st.session_state.current_year,
                year
            )
        else:
            parent1_ss = st.session_state.parentX_ss_benefit * 12
            if st.session_state.ss_insolvency_enabled and year >= 2034:
                parent1_ss *= (1 - st.session_state.ss_shortfall_percentage / 100)
            ss_income += parent1_ss

        if parent2_working:
            parent2_income = get_income_for_year(
                st.session_state.parentY_income,
                st.session_state.parentY_raise,
                st.session_state.parentY_job_changes,
                st.session_state.current_year,
                year
            )
        else:
            parent2_ss = st.session_state.parentY_ss_benefit * 12
            if st.session_state.ss_insolvency_enabled and year >= 2034:
                parent2_ss *= (1 - st.session_state.ss_shortfall_percentage / 100)
            ss_income += parent2_ss

        total_income = parent1_income + parent2_income + ss_income

        # Calculate expenses
        # Base family expenses (with inflation)
        years_from_now = year - st.session_state.current_year
        base_expenses = sum(st.session_state.expenses.values())
        base_expenses *= (1.03 ** years_from_now)  # 3% inflation

        # Children expenses
        children_expenses = 0
        children_in_college = []
        for child in st.session_state.children_list:
            child_exp = get_child_expenses(child, year, st.session_state.current_year)
            child_total = sum(child_exp.values())
            children_expenses += child_total

            # Track who's in college
            child_age = year - child['birth_year']
            if 18 <= child_age <= 21:
                children_in_college.append(child['name'])

        total_expenses = base_expenses + children_expenses

        # Calculate cashflow
        cashflow = total_income - total_expenses

        # Update net worth (simple model: cashflow + 7% investment return)
        investment_return = cumulative_net_worth * 0.07
        cumulative_net_worth += cashflow + investment_return

        # Track events
        events = []

        # Job changes
        for _, row in st.session_state.parentX_job_changes.iterrows():
            if int(row['Year']) == year:
                events.append(('job_change', st.session_state.parent1_name, row['New Income']))
        for _, row in st.session_state.parentY_job_changes.iterrows():
            if int(row['Year']) == year:
                events.append(('job_change', st.session_state.parent2_name, row['New Income']))

        # College events
        if children_in_college:
            events.append(('college', children_in_college))

        # Retirement events
        if parent1_age == st.session_state.parentX_retirement_age:
            events.append(('retirement', st.session_state.parent1_name))
        if parent2_age == st.session_state.parentY_retirement_age:
            events.append(('retirement', st.session_state.parent2_name))

        results.append({
            'year': year,
            'parent1_age': parent1_age,
            'parent2_age': parent2_age,
            'parent1_income': parent1_income,
            'parent2_income': parent2_income,
            'ss_income': ss_income,
            'total_income': total_income,
            'base_expenses': base_expenses,
            'children_expenses': children_expenses,
            'total_expenses': total_expenses,
            'cashflow': cashflow,
            'net_worth': cumulative_net_worth,
            'children_in_college': children_in_college,
            'events': events
        })

    return results


def lifetime_cashflow_tab():
    """Lifetime cashflow visualization tab"""
    st.header("ðŸ’° Lifetime Cashflow Visualization")

    st.markdown("""
    See how money flows through your entire life from now until age 100.
    This view helps you identify peak earning years, high expense periods, and retirement readiness.
    **Click on any year in the chart to see detailed income and expense breakdown.**
    """)

    # Initialize selected year in session state
    if 'selected_cashflow_year' not in st.session_state:
        st.session_state.selected_cashflow_year = None

    # Calculate lifetime data (no caching to ensure it updates when data changes)
    with st.spinner("Calculating lifetime cashflow..."):
        cashflow_data = calculate_lifetime_cashflow()

    if not cashflow_data:
        st.warning("No cashflow data available. Please configure your financial details first.")
        return

    # Create tabs for different views
    tab1, tab2, tab3 = st.tabs(["ðŸ“ˆ Timeline View", "ðŸ“Š Critical Years Table", "ðŸ“… Life Stages"])

    with tab1:
        st.subheader("Lifetime Income vs Expenses Timeline")

        # Prepare data for plotting
        years = [d['year'] for d in cashflow_data]
        income = [d['total_income'] for d in cashflow_data]
        expenses = [d['total_expenses'] for d in cashflow_data]
        cashflow = [d['cashflow'] for d in cashflow_data]

        # Create figure
        fig = go.Figure()

        # Add income line
        fig.add_trace(go.Scatter(
            x=years,
            y=income,
            mode='lines',
            name='Income',
            line=dict(color='green', width=2),
            hovertemplate='<b>Year %{x}</b><br>Income: $%{y:,.0f}<br>Click for details<extra></extra>'
        ))

        # Add expenses line
        fig.add_trace(go.Scatter(
            x=years,
            y=expenses,
            mode='lines',
            name='Expenses',
            line=dict(color='red', width=2),
            hovertemplate='<b>Year %{x}</b><br>Expenses: $%{y:,.0f}<br>Click for details<extra></extra>'
        ))

        # Add cashflow area (positive)
        cashflow_positive = [max(0, cf) for cf in cashflow]
        fig.add_trace(go.Scatter(
            x=years,
            y=cashflow_positive,
            mode='none',
            name='Positive Cashflow',
            fill='tozeroy',
            fillcolor='rgba(0, 255, 0, 0.1)',
            hovertemplate='<b>Year %{x}</b><br>Surplus: $%{y:,.0f}<extra></extra>'
        ))

        # Add cashflow area (negative)
        cashflow_negative = [min(0, cf) for cf in cashflow]
        fig.add_trace(go.Scatter(
            x=years,
            y=cashflow_negative,
            mode='none',
            name='Deficit',
            fill='tozeroy',
            fillcolor='rgba(255, 0, 0, 0.1)',
            hovertemplate='<b>Year %{x}</b><br>Deficit: $%{y:,.0f}<extra></extra>'
        ))

        # Add major event markers (only significant events to avoid clutter)
        major_events = []

        # Collect all major events
        for d in cashflow_data:
            for event_type, *event_data in d['events']:
                if event_type == 'job_change':
                    major_events.append({
                        'year': d['year'],
                        'type': 'job_change',
                        'label': f"ðŸ’¼ {event_data[0]}",
                        'value': d['total_income']
                    })
                elif event_type == 'retirement':
                    major_events.append({
                        'year': d['year'],
                        'type': 'retirement',
                        'label': f"ðŸ–ï¸ {event_data[0]}",
                        'value': d['total_income']
                    })

        # Add first and last college years only
        college_years_list = [d['year'] for d in cashflow_data if d['children_in_college']]
        if college_years_list:
            first_college = min(college_years_list)
            last_college = max(college_years_list)

            first_college_data = next(d for d in cashflow_data if d['year'] == first_college)
            major_events.append({
                'year': first_college,
                'type': 'college_start',
                'label': 'ðŸŽ“ College Starts',
                'value': first_college_data['total_expenses']
            })

            if last_college != first_college:
                last_college_data = next(d for d in cashflow_data if d['year'] == last_college)
                major_events.append({
                    'year': last_college,
                    'type': 'college_end',
                    'label': 'ðŸŽ“ College Ends',
                    'value': last_college_data['total_expenses']
                })

        # Add markers without text labels (use annotations instead)
        if major_events:
            event_years = [e['year'] for e in major_events]
            event_values = [e['value'] for e in major_events]
            event_labels = [e['label'] for e in major_events]

            fig.add_trace(go.Scatter(
                x=event_years,
                y=event_values,
                mode='markers',
                name='Major Events',
                marker=dict(size=15, color='blue', symbol='star', line=dict(width=2, color='white')),
                hovertemplate='<b>%{customdata}</b><br>Year: %{x}<extra></extra>',
                customdata=event_labels
            ))

        fig.update_layout(
            title="Lifetime Income, Expenses, and Cashflow (Click any year for details)",
            xaxis_title="Year",
            yaxis_title="Amount ($)",
            height=700,
            hovermode='x unified',
            showlegend=True,
            clickmode='event+select'
        )

        # Display chart and capture click events
        selected_points = st.plotly_chart(fig, use_container_width=True, on_select="rerun", key="cashflow_chart")

        # Handle year selection via manual input
        st.markdown("---")
        col_select1, col_select2 = st.columns([3, 1])
        with col_select1:
            selected_year = st.selectbox(
                "Select a year to see detailed breakdown:",
                options=years,
                index=0,
                key="year_selector"
            )
        with col_select2:
            st.markdown("<br>", unsafe_allow_html=True)
            if st.button("Show Details", type="primary"):
                st.session_state.selected_cashflow_year = selected_year

        # Show detailed breakdown if year is selected
        if st.session_state.selected_cashflow_year:
            year_data = next((d for d in cashflow_data if d['year'] == st.session_state.selected_cashflow_year), None)

            if year_data:
                st.markdown("---")
                st.subheader(f"ðŸ“Š Detailed Breakdown for {st.session_state.selected_cashflow_year}")

                col1, col2 = st.columns(2)

                with col1:
                    st.markdown("#### ðŸ’µ Income Breakdown")

                    income_breakdown = []
                    if year_data['parent1_income'] > 0:
                        income_breakdown.append({
                            'Source': f"{st.session_state.parent1_name} Salary",
                            'Amount': year_data['parent1_income']
                        })
                    if year_data['parent2_income'] > 0:
                        income_breakdown.append({
                            'Source': f"{st.session_state.parent2_name} Salary",
                            'Amount': year_data['parent2_income']
                        })
                    if year_data['ss_income'] > 0:
                        income_breakdown.append({
                            'Source': 'Social Security',
                            'Amount': year_data['ss_income']
                        })

                    if income_breakdown:
                        income_df = pd.DataFrame(income_breakdown)

                        # Create pie chart for income
                        income_fig = go.Figure(data=[go.Pie(
                            labels=income_df['Source'],
                            values=income_df['Amount'],
                            hole=0.3,
                            marker_colors=['#2ecc71', '#27ae60', '#16a085']
                        )])
                        income_fig.update_layout(height=300, showlegend=True)
                        st.plotly_chart(income_fig, use_container_width=True)

                        # Show table
                        income_df['Amount'] = income_df['Amount'].apply(lambda x: f"${x:,.0f}")
                        st.dataframe(income_df, hide_index=True, use_container_width=True)
                        st.metric("Total Income", f"${year_data['total_income']:,.0f}")
                    else:
                        st.info("No income for this year")

                with col2:
                    st.markdown("#### ðŸ’³ Expense Breakdown")

                    expense_breakdown = []
                    if year_data['base_expenses'] > 0:
                        expense_breakdown.append({
                            'Category': 'Family Living Expenses',
                            'Amount': year_data['base_expenses']
                        })
                    if year_data['children_expenses'] > 0:
                        expense_breakdown.append({
                            'Category': 'Children Expenses',
                            'Amount': year_data['children_expenses']
                        })

                    if expense_breakdown:
                        expense_df = pd.DataFrame(expense_breakdown)

                        # Create pie chart for expenses
                        expense_fig = go.Figure(data=[go.Pie(
                            labels=expense_df['Category'],
                            values=expense_df['Amount'],
                            hole=0.3,
                            marker_colors=['#e74c3c', '#c0392b']
                        )])
                        expense_fig.update_layout(height=300, showlegend=True)
                        st.plotly_chart(expense_fig, use_container_width=True)

                        # Show table
                        expense_df['Amount'] = expense_df['Amount'].apply(lambda x: f"${x:,.0f}")
                        st.dataframe(expense_df, hide_index=True, use_container_width=True)
                        st.metric("Total Expenses", f"${year_data['total_expenses']:,.0f}")
                    else:
                        st.info("No expenses for this year")

                # Show summary metrics
                st.markdown("#### ðŸ“ˆ Year Summary")
                sum_col1, sum_col2, sum_col3, sum_col4 = st.columns(4)

                with sum_col1:
                    st.metric("Ages", f"{year_data['parent1_age']} / {year_data['parent2_age']}")
                with sum_col2:
                    cashflow_val = year_data['cashflow']
                    cashflow_delta = "Surplus" if cashflow_val >= 0 else "Deficit"
                    st.metric("Cashflow", f"${abs(cashflow_val):,.0f}", cashflow_delta)
                with sum_col3:
                    st.metric("Net Worth", f"${year_data['net_worth']:,.0f}")
                with sum_col4:
                    if year_data['children_in_college']:
                        st.metric("In College", ", ".join(year_data['children_in_college']))
                    else:
                        st.metric("In College", "None")

        # Key insights
        st.markdown("---")
        st.subheader("ðŸ“Œ Key Insights")

        col1, col2, col3 = st.columns(3)

        # Find peak expense year
        peak_expense_data = max(cashflow_data, key=lambda x: x['total_expenses'])
        with col1:
            st.metric(
                "Peak Expense Year",
                f"{peak_expense_data['year']}",
                f"${peak_expense_data['total_expenses']:,.0f}"
            )

        # Find worst cashflow year
        worst_cashflow_data = min(cashflow_data, key=lambda x: x['cashflow'])
        with col2:
            st.metric(
                "Worst Cashflow Year",
                f"{worst_cashflow_data['year']}",
                f"${worst_cashflow_data['cashflow']:,.0f}"
            )

        # Count deficit years
        deficit_years = sum(1 for d in cashflow_data if d['cashflow'] < 0)
        with col3:
            st.metric(
                "Deficit Years",
                f"{deficit_years} years",
                "âš ï¸" if deficit_years > 5 else "âœ…"
            )

    with tab2:
        st.subheader("Critical Years - Detailed Breakdown")

        # Create DataFrame for table
        table_data = []
        for d in cashflow_data:
            # Format children status
            if d['children_in_college']:
                children_status = ", ".join(d['children_in_college']) + " (college)"
            else:
                child_ages = []
                for child in st.session_state.children_list:
                    age = d['year'] - child['birth_year']
                    if 0 <= age <= 21:
                        child_ages.append(f"{child['name']} ({age})")
                children_status = ", ".join(child_ages) if child_ages else "None"

            # Format events
            event_notes = []
            for event_type, *event_data in d['events']:
                if event_type == 'job_change':
                    event_notes.append(f"ðŸ’¼ {event_data[0]} â†’ ${event_data[1]:,.0f}")
                elif event_type == 'college':
                    event_notes.append(f"ðŸŽ“ College")
                elif event_type == 'retirement':
                    event_notes.append(f"ðŸ–ï¸ {event_data[0]} retires")
            event_str = "; ".join(event_notes) if event_notes else ""

            table_data.append({
                'Year': d['year'],
                'Ages': f"{d['parent1_age']}/{d['parent2_age']}",
                'Income': d['total_income'],
                'Expenses': d['total_expenses'],
                'Cashflow': d['cashflow'],
                'Net Worth': d['net_worth'],
                'Children': children_status,
                'Events': event_str
            })

        df = pd.DataFrame(table_data)

        # Add filtering
        st.markdown("**Filter by:**")
        col1, col2, col3 = st.columns(3)

        with col1:
            show_deficit_only = st.checkbox("Show deficit years only")
        with col2:
            show_college_only = st.checkbox("Show college years only")
        with col3:
            show_events_only = st.checkbox("Show event years only")

        # Apply filters
        filtered_df = df.copy()
        if show_deficit_only:
            filtered_df = filtered_df[filtered_df['Cashflow'] < 0]
        if show_college_only:
            filtered_df = filtered_df[filtered_df['Children'].str.contains('college', na=False)]
        if show_events_only:
            filtered_df = filtered_df[filtered_df['Events'] != '']

        # Format currency columns for display
        display_df = filtered_df.copy()
        display_df['Income'] = display_df['Income'].apply(lambda x: f"${x:,.0f}")
        display_df['Expenses'] = display_df['Expenses'].apply(lambda x: f"${x:,.0f}")
        display_df['Cashflow'] = display_df['Cashflow'].apply(lambda x: f"${x:,.0f}")
        display_df['Net Worth'] = display_df['Net Worth'].apply(lambda x: f"${x:,.0f}")

        st.dataframe(
            display_df,
            use_container_width=True,
            height=600,
            hide_index=True
        )

        st.download_button(
            label="ðŸ“¥ Download as CSV",
            data=filtered_df.to_csv(index=False),
            file_name=f"lifetime_cashflow_{st.session_state.current_year}.csv",
            mime="text/csv"
        )

    with tab3:
        st.subheader("Life Stage Summary")

        # Define life stages
        parent1_retirement_year = st.session_state.current_year + (st.session_state.parentX_retirement_age - st.session_state.parentX_age)
        parent2_retirement_year = st.session_state.current_year + (st.session_state.parentY_retirement_age - st.session_state.parentY_age)
        retirement_year = min(parent1_retirement_year, parent2_retirement_year)

        # Find first and last college years
        college_years = [d['year'] for d in cashflow_data if d['children_in_college']]
        if college_years:
            first_college_year = min(college_years)
            last_college_year = max(college_years)
        else:
            first_college_year = None
            last_college_year = None

        # Phase 1: Pre-college working years
        if first_college_year:
            phase1_data = [d for d in cashflow_data if d['year'] < first_college_year]
        else:
            phase1_data = [d for d in cashflow_data if d['year'] < retirement_year]

        if phase1_data:
            st.markdown("### ðŸ  Phase 1: Building Wealth (Pre-College)")
            col1, col2 = st.columns(2)

            with col1:
                st.markdown(f"**Duration**: {len(phase1_data)} years ({phase1_data[0]['year']} - {phase1_data[-1]['year']})")
                st.markdown(f"**Your Ages**: {phase1_data[0]['parent1_age']}-{phase1_data[-1]['parent1_age']} / {phase1_data[0]['parent2_age']}-{phase1_data[-1]['parent2_age']}")

                avg_income = sum(d['total_income'] for d in phase1_data) / len(phase1_data)
                avg_expenses = sum(d['total_expenses'] for d in phase1_data) / len(phase1_data)
                avg_savings = avg_income - avg_expenses

                st.metric("Average Annual Income", f"${avg_income:,.0f}")
                st.metric("Average Annual Expenses", f"${avg_expenses:,.0f}")
                st.metric("Average Annual Savings", f"${avg_savings:,.0f}")

            with col2:
                start_nw = phase1_data[0]['net_worth']
                end_nw = phase1_data[-1]['net_worth']
                growth = end_nw - start_nw

                st.metric("Starting Net Worth", f"${start_nw:,.0f}")
                st.metric("Ending Net Worth", f"${end_nw:,.0f}")
                st.metric("Net Worth Growth", f"${growth:,.0f}", f"+{growth/start_nw*100:.0f}%")

        # Phase 2: College years
        if college_years:
            phase2_data = [d for d in cashflow_data if first_college_year <= d['year'] <= last_college_year]

            st.markdown("---")
            st.markdown("### ðŸŽ“ Phase 2: College Years")
            col1, col2 = st.columns(2)

            with col1:
                st.markdown(f"**Duration**: {len(phase2_data)} years ({phase2_data[0]['year']} - {phase2_data[-1]['year']})")
                st.markdown(f"**Your Ages**: {phase2_data[0]['parent1_age']}-{phase2_data[-1]['parent1_age']} / {phase2_data[0]['parent2_age']}-{phase2_data[-1]['parent2_age']}")

                avg_income = sum(d['total_income'] for d in phase2_data) / len(phase2_data)
                avg_expenses = sum(d['total_expenses'] for d in phase2_data) / len(phase2_data)
                avg_savings = avg_income - avg_expenses

                st.metric("Average Annual Income", f"${avg_income:,.0f}")
                st.metric("Average Annual Expenses", f"${avg_expenses:,.0f}")
                st.metric("Average Annual Savings", f"${avg_savings:,.0f}")

                # Peak expense year
                peak = max(phase2_data, key=lambda x: x['total_expenses'])
                st.warning(f"**Peak**: {peak['year']} with ${peak['total_expenses']:,.0f} expenses")

            with col2:
                start_nw = phase2_data[0]['net_worth']
                end_nw = phase2_data[-1]['net_worth']
                growth = end_nw - start_nw

                st.metric("Starting Net Worth", f"${start_nw:,.0f}")
                st.metric("Ending Net Worth", f"${end_nw:,.0f}")
                st.metric("Net Worth Growth", f"${growth:,.0f}")

        # Phase 3: Empty nest (if applicable)
        if last_college_year and last_college_year < retirement_year:
            phase3_data = [d for d in cashflow_data if last_college_year < d['year'] < retirement_year]

            if phase3_data:
                st.markdown("---")
                st.markdown("### ðŸš€ Phase 3: Empty Nest - Maximum Acceleration")
                col1, col2 = st.columns(2)

                with col1:
                    st.markdown(f"**Duration**: {len(phase3_data)} years ({phase3_data[0]['year']} - {phase3_data[-1]['year']})")
                    st.markdown(f"**Your Ages**: {phase3_data[0]['parent1_age']}-{phase3_data[-1]['parent1_age']} / {phase3_data[0]['parent2_age']}-{phase3_data[-1]['parent2_age']}")

                    avg_income = sum(d['total_income'] for d in phase3_data) / len(phase3_data)
                    avg_expenses = sum(d['total_expenses'] for d in phase3_data) / len(phase3_data)
                    avg_savings = avg_income - avg_expenses

                    st.metric("Average Annual Income", f"${avg_income:,.0f}")
                    st.metric("Average Annual Expenses", f"${avg_expenses:,.0f}")
                    st.metric("Average Annual Savings", f"${avg_savings:,.0f}", "ðŸš€ Peak Savings!")

                with col2:
                    start_nw = phase3_data[0]['net_worth']
                    end_nw = phase3_data[-1]['net_worth']
                    growth = end_nw - start_nw

                    st.metric("Starting Net Worth", f"${start_nw:,.0f}")
                    st.metric("Ending Net Worth", f"${end_nw:,.0f}")
                    st.metric("Net Worth Growth", f"${growth:,.0f}")

                    st.info("ðŸ’¡ **This is your critical wealth-building phase!** Maximize savings and investments.")

        # Phase 4: Retirement
        phase4_data = [d for d in cashflow_data if d['year'] >= retirement_year]

        if phase4_data:
            st.markdown("---")
            st.markdown("### ðŸ–ï¸ Phase 4: Retirement")
            col1, col2 = st.columns(2)

            with col1:
                st.markdown(f"**Duration**: {len(phase4_data)} years ({phase4_data[0]['year']} - {phase4_data[-1]['year']})")
                st.markdown(f"**Your Ages**: {phase4_data[0]['parent1_age']}-{phase4_data[-1]['parent1_age']} / {phase4_data[0]['parent2_age']}-{phase4_data[-1]['parent2_age']}")

                avg_income = sum(d['total_income'] for d in phase4_data) / len(phase4_data)
                avg_expenses = sum(d['total_expenses'] for d in phase4_data) / len(phase4_data)
                avg_cashflow = avg_income - avg_expenses

                st.metric("Average Annual Income", f"${avg_income:,.0f}", "SS Benefits")
                st.metric("Average Annual Expenses", f"${avg_expenses:,.0f}")
                st.metric("Average Annual Cashflow", f"${avg_cashflow:,.0f}")

            with col2:
                start_nw = phase4_data[0]['net_worth']
                end_nw = phase4_data[-1]['net_worth']
                change = end_nw - start_nw

                st.metric("Retirement Net Worth", f"${start_nw:,.0f}")
                st.metric("Age 100 Net Worth", f"${end_nw:,.0f}")
                st.metric("Net Worth Change", f"${change:,.0f}")

                # Withdrawal rate
                if start_nw > 0:
                    avg_annual_deficit = abs(avg_cashflow) if avg_cashflow < 0 else 0
                    withdrawal_rate = (avg_annual_deficit / start_nw) * 100
                    st.metric("Effective Withdrawal Rate", f"{withdrawal_rate:.1f}%")

                    if withdrawal_rate > 4:
                        st.warning("âš ï¸ Withdrawal rate exceeds 4% rule. Consider working longer or reducing expenses.")
                    elif withdrawal_rate < 0:
                        st.success("âœ… No withdrawals needed! Living on SS + investment returns.")
                    else:
                        st.info(f"âœ… Withdrawal rate within safe limits (4% rule).")


def combined_simulation_tab():
    """Combined simulation and analysis tab"""
    st.header("ðŸ“Š Financial Analysis & Monte Carlo Simulation")

    st.markdown("Run comprehensive financial projections with Monte Carlo simulations")

    # Ensure Monte Carlo variables are initialized (defensive programming for old sessions)
    if 'mc_start_year' not in st.session_state:
        st.session_state.mc_start_year = 2025
    if 'mc_years' not in st.session_state:
        st.session_state.mc_years = 30
    if 'mc_simulations' not in st.session_state:
        st.session_state.mc_simulations = 1000
    if 'mc_use_historical' not in st.session_state:
        st.session_state.mc_use_historical = False
    if 'mc_normalize_to_today_dollars' not in st.session_state:
        st.session_state.mc_normalize_to_today_dollars = False
    if 'mc_income_variability_positive' not in st.session_state:
        st.session_state.mc_income_variability_positive = 10.0
    if 'mc_income_variability_negative' not in st.session_state:
        st.session_state.mc_income_variability_negative = 10.0
    if 'mc_expense_variability_positive' not in st.session_state:
        st.session_state.mc_expense_variability_positive = 5.0
    if 'mc_expense_variability_negative' not in st.session_state:
        st.session_state.mc_expense_variability_negative = 5.0
    if 'mc_return_variability_positive' not in st.session_state:
        st.session_state.mc_return_variability_positive = 15.0
    if 'mc_return_variability_negative' not in st.session_state:
        st.session_state.mc_return_variability_negative = 15.0

    # Simulation Settings
    st.subheader("âš™ï¸ Simulation Settings")

    col1, col2, col3 = st.columns(3)

    with col1:
        st.session_state.mc_start_year = st.number_input(
            "Start Year",
            min_value=st.session_state.current_year,
            max_value=2100,
            value=int(st.session_state.mc_start_year),
            key="mc_start"
        )

        st.number_input(
            "Projection Years",
            min_value=1,
            max_value=80,
            value=int(st.session_state.mc_years),
            key="mc_years"
        )

    with col2:
        st.session_state.mc_simulations = st.number_input(
            "Number of Simulations",
            min_value=100,
            max_value=10000,
            value=int(st.session_state.mc_simulations),
            step=100,
            key="mc_sims"
        )

        st.session_state.mc_use_historical = st.checkbox(
            "Use Historical Returns",
            value=st.session_state.mc_use_historical,
            help="Use actual historical S&P 500 returns instead of random generation"
        )

    with col3:
        st.session_state.mc_normalize_to_today_dollars = st.checkbox(
            "Normalize to Today's Dollars",
            value=st.session_state.mc_normalize_to_today_dollars,
            help="Adjust all future values to today's purchasing power"
        )

    # Variability Settings
    st.subheader("ðŸ“Š Variability Settings (for Traditional Simulations)")

    use_asymmetric = st.checkbox("Use Asymmetric Variability", value=True, help="Set different positive and negative variability ranges")

    if use_asymmetric:
        col1, col2, col3 = st.columns(3)

        with col1:
            st.markdown("**Income Variability**")
            st.session_state.mc_income_variability_positive = st.number_input(
                "Positive (%)",
                min_value=0.0,
                max_value=100.0,
                value=float(st.session_state.mc_income_variability_positive),
                step=1.0,
                key="income_var_pos"
            )
            st.session_state.mc_income_variability_negative = st.number_input(
                "Negative (%)",
                min_value=0.0,
                max_value=100.0,
                value=float(st.session_state.mc_income_variability_negative),
                step=1.0,
                key="income_var_neg"
            )

        with col2:
            st.markdown("**Expense Variability**")
            st.session_state.mc_expense_variability_positive = st.number_input(
                "Positive (%)",
                min_value=0.0,
                max_value=100.0,
                value=float(st.session_state.mc_expense_variability_positive),
                step=1.0,
                key="expense_var_pos"
            )
            st.session_state.mc_expense_variability_negative = st.number_input(
                "Negative (%)",
                min_value=0.0,
                max_value=100.0,
                value=float(st.session_state.mc_expense_variability_negative),
                step=1.0,
                key="expense_var_neg"
            )

        with col3:
            st.markdown("**Return Variability**")
            st.session_state.mc_return_variability_positive = st.number_input(
                "Positive (%)",
                min_value=0.0,
                max_value=100.0,
                value=float(st.session_state.mc_return_variability_positive),
                step=1.0,
                key="return_var_pos"
            )
            st.session_state.mc_return_variability_negative = st.number_input(
                "Negative (%)",
                min_value=0.0,
                max_value=100.0,
                value=float(st.session_state.mc_return_variability_negative),
                step=1.0,
                key="return_var_neg"
            )
    else:
        col1, col2, col3 = st.columns(3)
        with col1:
            st.session_state.mc_income_variability = st.slider("Income Variability (%)", 0.0, 100.0, 10.0)
        with col2:
            st.session_state.mc_expense_variability = st.slider("Expense Variability (%)", 0.0, 100.0, 5.0)
        with col3:
            st.session_state.mc_return_variability = st.slider("Return Variability (%)", 0.0, 100.0, 15.0)

    # Run Simulation Button
    if st.button("â–¶ï¸ Run Monte Carlo Simulation", type="primary"):
        with st.spinner("Running Monte Carlo simulation... This may take a minute."):
            st.info("ðŸŽ² Monte Carlo simulation is running with simplified calculations for web stability")

            # Simplified Monte Carlo for web
            scenario = st.session_state.economic_scenarios[st.session_state.active_scenario]

            num_sims = min(st.session_state.mc_simulations, 1000)  # Cap at 1000 for web performance
            results = []
            income_results = []
            expense_results = []
            cashflow_results = []

            # Starting values
            initial_net_worth = st.session_state.parentX_net_worth + st.session_state.parentY_net_worth

            # Run simulations
            progress_bar = st.progress(0)
            for sim in range(num_sims):
                sim_results = []
                sim_income = []
                sim_expenses = []
                sim_cashflow = []
                net_worth = initial_net_worth

                for year_offset in range(st.session_state.mc_years):
                    year = st.session_state.mc_start_year + year_offset

                    # Calculate income
                    parentX_working = (year - (st.session_state.current_year - st.session_state.parentX_age)) < st.session_state.parentX_retirement_age
                    parentY_working = (year - (st.session_state.current_year - st.session_state.parentY_age)) < st.session_state.parentY_retirement_age

                    income = 0
                    if parentX_working:
                        # Use job changes if available
                        parentX_year_income = get_income_for_year(
                            st.session_state.parentX_income,
                            st.session_state.parentX_raise,
                            st.session_state.parentX_job_changes,
                            st.session_state.current_year,
                            year
                        )
                        income += parentX_year_income
                    else:
                        ss_benefit = st.session_state.parentX_ss_benefit * 12
                        if st.session_state.ss_insolvency_enabled and year >= 2034:
                            ss_benefit *= (1 - st.session_state.ss_shortfall_percentage / 100)
                        income += ss_benefit

                    if parentY_working:
                        # Use job changes if available
                        parentY_year_income = get_income_for_year(
                            st.session_state.parentY_income,
                            st.session_state.parentY_raise,
                            st.session_state.parentY_job_changes,
                            st.session_state.current_year,
                            year
                        )
                        income += parentY_year_income
                    else:
                        ss_benefit = st.session_state.parentY_ss_benefit * 12
                        if st.session_state.ss_insolvency_enabled and year >= 2034:
                            ss_benefit *= (1 - st.session_state.ss_shortfall_percentage / 100)
                        income += ss_benefit

                    # Add variability to income
                    if use_asymmetric:
                        if np.random.random() > 0.5:
                            income *= (1 + np.random.uniform(0, st.session_state.mc_income_variability_positive / 100))
                        else:
                            income *= (1 - np.random.uniform(0, st.session_state.mc_income_variability_negative / 100))
                    else:
                        income *= (1 + np.random.uniform(-st.session_state.mc_income_variability / 100, st.session_state.mc_income_variability / 100))

                    # Calculate expenses
                    # Base family expenses
                    base_expenses = sum(st.session_state.expenses.values())
                    base_expenses *= (1 + scenario.expense_growth_rate) ** year_offset

                    # Add dynamic children expenses for this year
                    children_expenses = 0
                    for child in st.session_state.children_list:
                        child_exp = get_child_expenses(child, year, st.session_state.current_year)
                        children_expenses += sum(child_exp.values())

                    # Total expenses
                    expenses = base_expenses + children_expenses

                    # Add variability to expenses
                    if use_asymmetric:
                        if np.random.random() > 0.5:
                            expenses *= (1 + np.random.uniform(0, st.session_state.mc_expense_variability_positive / 100))
                        else:
                            expenses *= (1 - np.random.uniform(0, st.session_state.mc_expense_variability_negative / 100))
                    else:
                        expenses *= (1 + np.random.uniform(-st.session_state.mc_expense_variability / 100, st.session_state.mc_expense_variability / 100))

                    # Calculate investment returns
                    if st.session_state.mc_use_historical:
                        # Use random sampling from historical returns instead of sequential
                        return_rate = np.random.choice(HISTORICAL_STOCK_RETURNS)
                    else:
                        if use_asymmetric:
                            if np.random.random() > 0.5:
                                return_rate = scenario.investment_return + np.random.uniform(0, st.session_state.mc_return_variability_positive / 100)
                            else:
                                return_rate = scenario.investment_return - np.random.uniform(0, st.session_state.mc_return_variability_negative / 100)
                        else:
                            return_rate = scenario.investment_return + np.random.uniform(-st.session_state.mc_return_variability / 100, st.session_state.mc_return_variability / 100)

                    investment_return = net_worth * return_rate

                    # Update net worth
                    net_worth = net_worth + income - expenses + investment_return

                    # Normalize to today's dollars if requested
                    display_net_worth = net_worth
                    display_income = income
                    display_expenses = expenses
                    if st.session_state.mc_normalize_to_today_dollars:
                        display_net_worth = net_worth / ((1 + scenario.inflation_rate) ** year_offset)
                        display_income = income / ((1 + scenario.inflation_rate) ** year_offset)
                        display_expenses = expenses / ((1 + scenario.inflation_rate) ** year_offset)

                    cashflow = display_income - display_expenses
                    sim_results.append(display_net_worth)
                    sim_income.append(display_income)
                    sim_expenses.append(display_expenses)
                    sim_cashflow.append(cashflow)

                results.append(sim_results)
                income_results.append(sim_income)
                expense_results.append(sim_expenses)
                cashflow_results.append(sim_cashflow)
                progress_bar.progress((sim + 1) / num_sims)

            # Calculate percentiles
            results_array = np.array(results)
            income_array = np.array(income_results)
            expense_array = np.array(expense_results)
            cashflow_array = np.array(cashflow_results)

            percentiles = {
                '10th': np.percentile(results_array, 10, axis=0),
                '25th': np.percentile(results_array, 25, axis=0),
                '50th': np.percentile(results_array, 50, axis=0),
                '75th': np.percentile(results_array, 75, axis=0),
                '90th': np.percentile(results_array, 90, axis=0),
            }

            # Calculate 50th percentile for income, expenses, and cashflow
            income_50th = np.percentile(income_array, 50, axis=0)
            expense_50th = np.percentile(expense_array, 50, axis=0)
            cashflow_50th = np.percentile(cashflow_array, 50, axis=0)

            years = list(range(st.session_state.mc_start_year, st.session_state.mc_start_year + st.session_state.mc_years))

            # Plot results
            st.subheader("ðŸ“ˆ Monte Carlo Results")

            fig = go.Figure()

            fig.add_trace(go.Scatter(
                x=years, y=percentiles['90th'],
                mode='lines',
                name='90th Percentile',
                line=dict(color='rgba(0,176,246,0.2)'),
                fillcolor='rgba(0,176,246,0.1)',
            ))

            fig.add_trace(go.Scatter(
                x=years, y=percentiles['75th'],
                mode='lines',
                name='75th Percentile',
                line=dict(color='rgba(0,176,246,0.4)'),
                fillcolor='rgba(0,176,246,0.2)',
                fill='tonexty'
            ))

            fig.add_trace(go.Scatter(
                x=years, y=percentiles['50th'],
                mode='lines',
                name='50th Percentile (Median)',
                line=dict(color='rgba(0,176,246,1)', width=3),
                fillcolor='rgba(0,176,246,0.3)',
                fill='tonexty'
            ))

            fig.add_trace(go.Scatter(
                x=years, y=percentiles['25th'],
                mode='lines',
                name='25th Percentile',
                line=dict(color='rgba(231,107,243,0.4)'),
                fillcolor='rgba(231,107,243,0.2)',
                fill='tonexty'
            ))

            fig.add_trace(go.Scatter(
                x=years, y=percentiles['10th'],
                mode='lines',
                name='10th Percentile',
                line=dict(color='rgba(231,107,243,0.2)'),
                fillcolor='rgba(231,107,243,0.1)',
                fill='tonexty'
            ))

            fig.update_layout(
                title=f"Monte Carlo Simulation Results ({num_sims} simulations)",
                xaxis_title="Year",
                yaxis_title="Net Worth ($)" + (" - Today's Dollars" if st.session_state.mc_normalize_to_today_dollars else ""),
                height=500,
                hovermode='x unified'
            )

            st.plotly_chart(fig, use_container_width=True)

            # Results table
            st.subheader("ðŸ“Š Detailed Percentile Breakdown")

            # Show results for key years
            key_years_idx = [0, st.session_state.mc_years // 4, st.session_state.mc_years // 2,
                            3 * st.session_state.mc_years // 4, st.session_state.mc_years - 1]

            breakdown_data = []
            for idx in key_years_idx:
                if idx < len(years):
                    breakdown_data.append({
                        'Year': years[idx],
                        '10th %ile': format_currency(percentiles['10th'][idx]),
                        '25th %ile': format_currency(percentiles['25th'][idx]),
                        'Median': format_currency(percentiles['50th'][idx]),
                        '75th %ile': format_currency(percentiles['75th'][idx]),
                        '90th %ile': format_currency(percentiles['90th'][idx]),
                    })

            breakdown_df = pd.DataFrame(breakdown_data)
            st.dataframe(breakdown_df, use_container_width=True, hide_index=True)

            # Success rate
            final_values = results_array[:, -1]
            success_rate = (np.sum(final_values > 0) / len(final_values)) * 100

            col1, col2, col3 = st.columns(3)
            with col1:
                st.metric("Success Rate", f"{success_rate:.1f}%", help="Percentage of simulations ending with positive net worth")
            with col2:
                st.metric("Final Median Net Worth", format_currency(percentiles['50th'][-1]))
            with col3:
                st.metric("Final 10th Percentile", format_currency(percentiles['10th'][-1]))

            # 50th Percentile Cashflow Breakdown
            st.subheader("ðŸ“Š 50th Percentile Cashflow Breakdown")
            st.markdown("This shows the median (50th percentile) income, expenses, and cashflow projections across all simulations.")

            # Create dataframe for 50th percentile breakdown
            cashflow_breakdown_data = []
            for idx in key_years_idx:
                if idx < len(years):
                    cashflow_breakdown_data.append({
                        'Year': years[idx],
                        'Income': format_currency(income_50th[idx]),
                        'Expenses': format_currency(expense_50th[idx]),
                        'Cashflow': format_currency(cashflow_50th[idx]),
                    })

            cashflow_breakdown_df = pd.DataFrame(cashflow_breakdown_data)
            st.dataframe(cashflow_breakdown_df, use_container_width=True, hide_index=True)

            # Plot 50th percentile income, expenses, and cashflow
            fig_cashflow = go.Figure()

            fig_cashflow.add_trace(go.Scatter(
                x=years, y=income_50th,
                mode='lines',
                name='Income (50th %ile)',
                line=dict(color='green', width=2)
            ))

            fig_cashflow.add_trace(go.Scatter(
                x=years, y=expense_50th,
                mode='lines',
                name='Expenses (50th %ile)',
                line=dict(color='red', width=2)
            ))

            fig_cashflow.add_trace(go.Scatter(
                x=years, y=cashflow_50th,
                mode='lines',
                name='Cashflow (50th %ile)',
                line=dict(color='blue', width=2),
                fill='tozeroy'
            ))

            fig_cashflow.update_layout(
                title="50th Percentile Income, Expenses, and Cashflow Over Time",
                xaxis_title="Year",
                yaxis_title="Amount ($)" + (" - Today's Dollars" if st.session_state.mc_normalize_to_today_dollars else ""),
                height=400,
                hovermode='x unified'
            )

            st.plotly_chart(fig_cashflow, use_container_width=True)


def save_load_tab():
    """Save and load scenarios tab"""
    st.header("ðŸ’¾ Save & Load Scenarios")

    st.markdown("Save and load complete financial planning scenarios")

    # Internal scenario library
    st.subheader("ðŸ“š Internal Scenario Library")

    col1, col2 = st.columns([2, 1])

    with col1:
        scenario_name = st.text_input(
            "Scenario Name",
            value="My Scenario",
            key="save_scenario_name"
        )

    with col2:
        st.write("")  # Spacing
        st.write("")  # Spacing
        if st.button("ðŸ’¾ Save to Library", use_container_width=True):
            # Save all session state to internal library
            scenario_data = {
                'current_year': st.session_state.current_year,
                'parent1_name': st.session_state.parent1_name,
                'parent1_emoji': st.session_state.parent1_emoji,
                'parent2_name': st.session_state.parent2_name,
                'parent2_emoji': st.session_state.parent2_emoji,
                'marriage_year': st.session_state.marriage_year,
                'parentX_age': st.session_state.parentX_age,
                'parentX_net_worth': st.session_state.parentX_net_worth,
                'parentX_income': st.session_state.parentX_income,
                'parentX_raise': st.session_state.parentX_raise,
                'parentX_retirement_age': st.session_state.parentX_retirement_age,
                'parentX_ss_benefit': st.session_state.parentX_ss_benefit,
                'parentY_age': st.session_state.parentY_age,
                'parentY_net_worth': st.session_state.parentY_net_worth,
                'parentY_income': st.session_state.parentY_income,
                'parentY_raise': st.session_state.parentY_raise,
                'parentY_retirement_age': st.session_state.parentY_retirement_age,
                'parentY_ss_benefit': st.session_state.parentY_ss_benefit,
                'expenses': st.session_state.expenses,
                'children_list': st.session_state.children_list,
                'houses': [asdict(h) for h in st.session_state.houses],
                'portfolio_allocation': asdict(st.session_state.portfolio_allocation),
                'major_purchases': [asdict(mp) for mp in st.session_state.major_purchases],
                'recurring_expenses': [asdict(re) for re in st.session_state.recurring_expenses],
                'state_timeline': [asdict(st) for st in st.session_state.state_timeline],
                'active_scenario': st.session_state.active_scenario,
                'ss_insolvency_enabled': st.session_state.ss_insolvency_enabled,
                'ss_shortfall_percentage': st.session_state.ss_shortfall_percentage,
            }

            st.session_state.saved_scenarios[scenario_name] = scenario_data
            st.success(f"âœ… Saved scenario '{scenario_name}' to library")

    # Display saved scenarios
    if st.session_state.saved_scenarios:
        st.markdown("**Saved Scenarios:**")

        for name in list(st.session_state.saved_scenarios.keys()):
            col1, col2, col3 = st.columns([3, 1, 1])

            with col1:
                st.text(f"ðŸ“‹ {name}")

            with col2:
                if st.button("ðŸ“¥ Load", key=f"load_{name}"):
                    scenario_data = st.session_state.saved_scenarios[name]

                    # Restore session state
                    for key, value in scenario_data.items():
                        if key == 'houses':
                            st.session_state.houses = [House(**h) for h in value]
                        elif key == 'portfolio_allocation':
                            st.session_state.portfolio_allocation = PortfolioAllocation(**value)
                        elif key == 'major_purchases':
                            st.session_state.major_purchases = [MajorPurchase(**mp) for mp in value]
                        elif key == 'recurring_expenses':
                            st.session_state.recurring_expenses = [RecurringExpense(**re) for re in value]
                        elif key == 'state_timeline':
                            st.session_state.state_timeline = [StateTimelineEntry(**st_entry) for st_entry in value]
                        else:
                            st.session_state[key] = value

                    st.success(f"âœ… Loaded scenario '{name}'")
                    st.rerun()

            with col3:
                if st.button("ðŸ—‘ï¸ Delete", key=f"delete_{name}"):
                    del st.session_state.saved_scenarios[name]
                    st.success(f"ðŸ—‘ï¸ Deleted scenario '{name}'")
                    st.rerun()
    else:
        st.info("No scenarios saved yet. Save your first scenario above!")

    st.divider()

    # File export/import
    st.subheader("ðŸ“ Export/Import Files")

    col1, col2 = st.columns(2)

    with col1:
        st.markdown("**Export to JSON File**")

        if st.button("ðŸ’¾ Export Current Scenario"):
            export_data = {
                'current_year': st.session_state.current_year,
                'parent1_name': st.session_state.parent1_name,
                'parent1_emoji': st.session_state.parent1_emoji,
                'parent2_name': st.session_state.parent2_name,
                'parent2_emoji': st.session_state.parent2_emoji,
                'marriage_year': st.session_state.marriage_year,
                'parentX_age': st.session_state.parentX_age,
                'parentX_net_worth': st.session_state.parentX_net_worth,
                'parentX_income': st.session_state.parentX_income,
                'parentX_raise': st.session_state.parentX_raise,
                'parentX_retirement_age': st.session_state.parentX_retirement_age,
                'parentX_ss_benefit': st.session_state.parentX_ss_benefit,
                'parentY_age': st.session_state.parentY_age,
                'parentY_net_worth': st.session_state.parentY_net_worth,
                'parentY_income': st.session_state.parentY_income,
                'parentY_raise': st.session_state.parentY_raise,
                'parentY_retirement_age': st.session_state.parentY_retirement_age,
                'parentY_ss_benefit': st.session_state.parentY_ss_benefit,
                'expenses': st.session_state.expenses,
                'children_list': st.session_state.children_list,
                'houses': [asdict(h) for h in st.session_state.houses],
                'portfolio_allocation': asdict(st.session_state.portfolio_allocation),
                'major_purchases': [asdict(mp) for mp in st.session_state.major_purchases],
                'recurring_expenses': [asdict(re) for re in st.session_state.recurring_expenses],
                'state_timeline': [asdict(st_entry) for st_entry in st.session_state.state_timeline],
                'active_scenario': st.session_state.active_scenario,
                'ss_insolvency_enabled': st.session_state.ss_insolvency_enabled,
                'ss_shortfall_percentage': st.session_state.ss_shortfall_percentage,
            }

            json_str = json.dumps(export_data, indent=2)

            st.download_button(
                label="ðŸ“¥ Download JSON",
                data=json_str,
                file_name=f"financial_plan_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json",
                mime="application/json"
            )

    with col2:
        st.markdown("**Import from JSON File**")

        uploaded_file = st.file_uploader("Choose a JSON file", type=['json'])

        if uploaded_file is not None:
            try:
                import_data = json.load(uploaded_file)

                # Restore session state
                for key, value in import_data.items():
                    if key == 'houses':
                        st.session_state.houses = [House(**h) for h in value]
                    elif key == 'portfolio_allocation':
                        st.session_state.portfolio_allocation = PortfolioAllocation(**value)
                    elif key == 'major_purchases':
                        st.session_state.major_purchases = [MajorPurchase(**mp) for mp in value]
                    elif key == 'recurring_expenses':
                        st.session_state.recurring_expenses = [RecurringExpense(**re) for re in value]
                    elif key == 'state_timeline':
                        st.session_state.state_timeline = [StateTimelineEntry(**st_entry) for st_entry in value]
                    else:
                        st.session_state[key] = value

                st.success("âœ… Successfully imported scenario!")
                st.rerun()

            except Exception as e:
                st.error(f"âŒ Error importing file: {str(e)}")


# NEW TAB 1: Healthcare & Insurance
def healthcare_insurance_tab():
    """Healthcare and Insurance Planning Tab"""
    st.header("ðŸ¥ Healthcare & Insurance Planning")

    st.markdown("""
    Plan for healthcare costs throughout retirement, including Medicare, insurance premiums,
    out-of-pocket expenses, and long-term care insurance.
    """)

    # Ensure healthcare variables are initialized (defensive programming for old sessions)
    if 'health_insurances' not in st.session_state:
        st.session_state.health_insurances = []
    if 'ltc_insurances' not in st.session_state:
        st.session_state.ltc_insurances = []
    if 'health_expenses' not in st.session_state:
        st.session_state.health_expenses = []
    if 'hsa_balance' not in st.session_state:
        st.session_state.hsa_balance = 0.0
    if 'hsa_contribution' not in st.session_state:
        st.session_state.hsa_contribution = 0.0
    if 'medicare_part_b_premium' not in st.session_state:
        st.session_state.medicare_part_b_premium = 174.70
    if 'medicare_part_d_premium' not in st.session_state:
        st.session_state.medicare_part_d_premium = 55.0
    if 'medigap_premium' not in st.session_state:
        st.session_state.medigap_premium = 150.0

    # HSA Account
    st.subheader("ðŸ’° Health Savings Account (HSA)")
    col1, col2 = st.columns(2)
    with col1:
        st.session_state.hsa_balance = st.number_input(
            "Current HSA Balance",
            min_value=0.0,
            value=float(st.session_state.hsa_balance),
            step=1000.0,
            format="%.2f"
        )
    with col2:
        st.session_state.hsa_contribution = st.number_input(
            "Annual HSA Contribution",
            min_value=0.0,
            max_value=8300.0,  # 2025 family limit
            value=float(st.session_state.hsa_contribution),
            step=100.0,
            format="%.2f"
        )

    st.info("ðŸ’¡ HSA Triple Tax Advantage: Tax-deductible contributions, tax-free growth, tax-free withdrawals for medical expenses")

    # Health Insurance Plans
    st.subheader("ðŸ¥ Health Insurance Plans")

    if st.button("âž• Add Health Insurance Plan"):
        new_insurance = HealthInsurance(
            name="New Health Plan",
            type="Employer",
            monthly_premium=500.0,
            annual_deductible=3000.0,
            annual_out_of_pocket_max=8000.0,
            copay_primary=25.0,
            copay_specialist=50.0,
            covered_by="Family",
            start_age=0,
            end_age=65
        )
        st.session_state.health_insurances.append(new_insurance)
        st.rerun()

    for idx, insurance in enumerate(st.session_state.health_insurances):
        with st.expander(f"ðŸ“‹ {insurance.name}"):
            col1, col2, col3 = st.columns([3, 3, 1])

            with col1:
                insurance.name = st.text_input(f"Plan Name##ins{idx}", value=insurance.name)
                insurance.type = st.selectbox(
                    f"Insurance Type##ins{idx}",
                    ["Employer", "Marketplace", "Medicare", "Medicaid"],
                    index=["Employer", "Marketplace", "Medicare", "Medicaid"].index(insurance.type) if insurance.type in ["Employer", "Marketplace", "Medicare", "Medicaid"] else 0
                )
                insurance.monthly_premium = st.number_input(
                    f"Monthly Premium##ins{idx}",
                    min_value=0.0,
                    value=float(insurance.monthly_premium),
                    step=50.0
                )

            with col2:
                insurance.annual_deductible = st.number_input(
                    f"Annual Deductible##ins{idx}",
                    min_value=0.0,
                    value=float(insurance.annual_deductible),
                    step=100.0
                )
                insurance.annual_out_of_pocket_max = st.number_input(
                    f"Out-of-Pocket Maximum##ins{idx}",
                    min_value=0.0,
                    value=float(insurance.annual_out_of_pocket_max),
                    step=500.0
                )
                insurance.covered_by = st.selectbox(
                    f"Covered By##ins{idx}",
                    ["Parent 1", "Parent 2", "Both", "Family"],
                    index=["Parent 1", "Parent 2", "Both", "Family"].index(insurance.covered_by) if insurance.covered_by in ["Parent 1", "Parent 2", "Both", "Family"] else 3
                )

            with col3:
                if st.button(f"ðŸ—‘ï¸ Delete##{idx}_insurance"):
                    st.session_state.health_insurances.pop(idx)
                    st.rerun()

            st.session_state.health_insurances[idx] = insurance

    # Medicare Settings
    st.subheader("ðŸ©º Medicare Planning (Age 65+)")
    col1, col2, col3 = st.columns(3)
    with col1:
        st.session_state.medicare_part_b_premium = st.number_input(
            "Medicare Part B Premium (Monthly)",
            min_value=0.0,
            value=float(st.session_state.medicare_part_b_premium),
            step=10.0,
            help="Standard 2025 premium: $174.70/month"
        )
    with col2:
        st.session_state.medicare_part_d_premium = st.number_input(
            "Medicare Part D Premium (Monthly)",
            min_value=0.0,
            value=float(st.session_state.medicare_part_d_premium),
            step=10.0,
            help="Average prescription drug plan premium"
        )
    with col3:
        st.session_state.medigap_premium = st.number_input(
            "Medigap Supplement Premium (Monthly)",
            min_value=0.0,
            value=float(st.session_state.medigap_premium),
            step=10.0,
            help="Optional supplemental coverage"
        )

    # Long-Term Care Insurance
    st.subheader("ðŸ¨ Long-Term Care Insurance")

    if st.button("âž• Add LTC Insurance Policy"):
        new_ltc = LongTermCareInsurance(
            name="LTC Policy",
            monthly_premium=300.0,
            daily_benefit=200.0,
            benefit_period_days=1095,  # 3 years
            elimination_period_days=90,
            covered_person="Parent 1",
            start_age=55,
            inflation_protection=0.03
        )
        st.session_state.ltc_insurances.append(new_ltc)
        st.rerun()

    for idx, ltc in enumerate(st.session_state.ltc_insurances):
        with st.expander(f"ðŸ¨ {ltc.name} - {ltc.covered_person}"):
            col1, col2, col3 = st.columns([3, 3, 1])

            with col1:
                ltc.name = st.text_input(f"Policy Name##ltc{idx}", value=ltc.name)
                ltc.covered_person = st.selectbox(
                    f"Covered Person##ltc{idx}",
                    ["Parent 1", "Parent 2"],
                    index=["Parent 1", "Parent 2"].index(ltc.covered_person) if ltc.covered_person in ["Parent 1", "Parent 2"] else 0
                )
                ltc.monthly_premium = st.number_input(
                    f"Monthly Premium##ltc{idx}",
                    min_value=0.0,
                    value=float(ltc.monthly_premium),
                    step=50.0
                )

            with col2:
                ltc.daily_benefit = st.number_input(
                    f"Daily Benefit##ltc{idx}",
                    min_value=0.0,
                    value=float(ltc.daily_benefit),
                    step=25.0,
                    help="Daily benefit amount for care"
                )
                ltc.benefit_period_days = st.number_input(
                    f"Benefit Period (days)##ltc{idx}",
                    min_value=0,
                    value=int(ltc.benefit_period_days),
                    step=365,
                    help="Total days of coverage (e.g., 1095 = 3 years)"
                )
                ltc.start_age = st.number_input(
                    f"Coverage Start Age##ltc{idx}",
                    min_value=30,
                    max_value=80,
                    value=int(ltc.start_age),
                    step=1
                )

            with col3:
                if st.button(f"ðŸ—‘ï¸ Delete##ltc{idx}"):
                    st.session_state.ltc_insurances.pop(idx)
                    st.rerun()

            st.session_state.ltc_insurances[idx] = ltc

    # Healthcare Cost Summary
    st.subheader("ðŸ“Š Healthcare Cost Projection")

    total_annual_premium = sum([ins.monthly_premium * 12 for ins in st.session_state.health_insurances])
    total_ltc_premium = sum([ltc.monthly_premium * 12 for ltc in st.session_state.ltc_insurances])

    col1, col2, col3 = st.columns(3)
    col1.metric("Annual Health Insurance", format_currency(total_annual_premium))
    col2.metric("Annual LTC Insurance", format_currency(total_ltc_premium))
    col3.metric("Total Insurance Cost", format_currency(total_annual_premium + total_ltc_premium))


# NEW TAB 2: Debt Management
def debt_management_tab():
    """Comprehensive Debt Management Tab"""
    st.header("ðŸ’³ Debt Management")

    st.markdown("""
    Manage all debts including student loans, credit cards, auto loans, and personal loans.
    Track payoff strategies and visualize debt-free timeline.
    """)

    # Ensure debt variables are initialized (defensive programming for old sessions)
    if 'debts' not in st.session_state:
        st.session_state.debts = []
    if 'debt_payoff_strategy' not in st.session_state:
        st.session_state.debt_payoff_strategy = "Avalanche"
    if 'extra_debt_payment' not in st.session_state:
        st.session_state.extra_debt_payment = 0.0

    # Debt Payoff Strategy
    st.subheader("ðŸ“Š Debt Payoff Strategy")
    col1, col2 = st.columns(2)
    with col1:
        # Map short form to full form for display
        strategy_options = ["Avalanche (Highest Interest First)", "Snowball (Smallest Balance First)", "Minimum Payments Only"]
        strategy_map = {"Avalanche": 0, "Snowball": 1, "Minimum Only": 2}
        # Handle both short and long forms
        if "Avalanche" in st.session_state.debt_payoff_strategy:
            current_index = 0
        elif "Snowball" in st.session_state.debt_payoff_strategy:
            current_index = 1
        else:
            current_index = 2

        st.session_state.debt_payoff_strategy = st.selectbox(
            "Payoff Strategy",
            strategy_options,
            index=current_index
        )
    with col2:
        st.session_state.extra_debt_payment = st.number_input(
            "Extra Monthly Payment (Applied to Strategy)",
            min_value=0.0,
            value=float(st.session_state.extra_debt_payment),
            step=100.0,
            help="Additional amount beyond minimum payments"
        )

    # Add New Debt
    st.subheader("âž• Add New Debt")

    if st.button("Add Debt"):
        new_debt = Debt(
            name="New Debt",
            debt_type="Student Loan",
            principal=25000.0,
            interest_rate=0.045,
            monthly_payment=250.0,
            minimum_payment=250.0,
            start_date=f"{st.session_state.current_year}-01-01",
            owner="Parent 1",
            interest_type="Fixed",
            income_based_repayment=False,
            forgiveness_eligible=False,
            forgiveness_years=0
        )
        st.session_state.debts.append(new_debt)
        st.rerun()

    # Display All Debts
    st.subheader("ðŸ“‹ Current Debts")

    if not st.session_state.debts:
        st.info("No debts added yet. Click 'Add Debt' to get started.")

    for idx, debt in enumerate(st.session_state.debts):
        with st.expander(f"ðŸ’° {debt.name} ({debt.debt_type}) - {format_currency(debt.principal)} @ {debt.interest_rate*100:.2f}%"):
            col1, col2, col3, col4 = st.columns([3, 3, 3, 1])

            with col1:
                debt.name = st.text_input(f"Debt Name##debt{idx}", value=debt.name)
                debt.debt_type = st.selectbox(
                    f"Debt Type##debt{idx}",
                    ["Student Loan", "Credit Card", "Auto Loan", "Personal Loan", "Medical Debt", "Mortgage", "Other"],
                    index=["Student Loan", "Credit Card", "Auto Loan", "Personal Loan", "Medical Debt", "Mortgage", "Other"].index(debt.debt_type) if debt.debt_type in ["Student Loan", "Credit Card", "Auto Loan", "Personal Loan", "Medical Debt", "Mortgage", "Other"] else 0
                )
                debt.owner = st.selectbox(
                    f"Owner##debt{idx}",
                    ["Parent 1", "Parent 2", "Shared"],
                    index=["Parent 1", "Parent 2", "Shared"].index(debt.owner) if debt.owner in ["Parent 1", "Parent 2", "Shared"] else 0
                )

            with col2:
                debt.principal = st.number_input(
                    f"Current Balance##debt{idx}",
                    min_value=0.0,
                    value=float(debt.principal),
                    step=1000.0
                )
                debt.interest_rate = st.number_input(
                    f"Interest Rate (%)##debt{idx}",
                    min_value=0.0,
                    max_value=100.0,
                    value=float(debt.interest_rate * 100),
                    step=0.1
                ) / 100
                debt.interest_type = st.selectbox(
                    f"Interest Type##debt{idx}",
                    ["Fixed", "Variable"],
                    index=["Fixed", "Variable"].index(debt.interest_type) if debt.interest_type in ["Fixed", "Variable"] else 0
                )

            with col3:
                debt.monthly_payment = st.number_input(
                    f"Monthly Payment##debt{idx}",
                    min_value=0.0,
                    value=float(debt.monthly_payment),
                    step=50.0
                )
                debt.minimum_payment = st.number_input(
                    f"Minimum Payment##debt{idx}",
                    min_value=0.0,
                    value=float(debt.minimum_payment),
                    step=25.0
                )

                # Student Loan Specific
                if debt.debt_type == "Student Loan":
                    debt.income_based_repayment = st.checkbox(
                        f"Income-Based Repayment##debt{idx}",
                        value=debt.income_based_repayment
                    )
                    debt.forgiveness_eligible = st.checkbox(
                        f"Forgiveness Eligible (PSLF/IDR)##debt{idx}",
                        value=debt.forgiveness_eligible
                    )
                    if debt.forgiveness_eligible:
                        debt.forgiveness_years = st.number_input(
                            f"Years Until Forgiveness##debt{idx}",
                            min_value=0,
                            max_value=25,
                            value=int(debt.forgiveness_years),
                            step=1
                        )

            with col4:
                if st.button(f"ðŸ—‘ï¸##debt{idx}"):
                    st.session_state.debts.pop(idx)
                    st.rerun()

            st.session_state.debts[idx] = debt

    # Debt Summary
    if st.session_state.debts:
        st.subheader("ðŸ“Š Debt Summary")

        total_debt = sum([d.principal for d in st.session_state.debts])
        total_monthly_payment = sum([d.monthly_payment for d in st.session_state.debts])
        weighted_avg_rate = sum([d.principal * d.interest_rate for d in st.session_state.debts]) / total_debt if total_debt > 0 else 0

        col1, col2, col3, col4 = st.columns(4)
        col1.metric("Total Debt", format_currency(total_debt))
        col2.metric("Total Monthly Payment", format_currency(total_monthly_payment))
        col3.metric("Weighted Avg. Interest Rate", f"{weighted_avg_rate*100:.2f}%")
        col4.metric("Monthly + Extra", format_currency(total_monthly_payment + st.session_state.extra_debt_payment))

        # Debt Breakdown Chart
        if st.session_state.debts:
            debt_df = pd.DataFrame([
                {"Debt": d.name, "Balance": d.principal, "Type": d.debt_type, "Rate": d.interest_rate*100}
                for d in st.session_state.debts
            ])

            fig = px.pie(debt_df, values='Balance', names='Debt', title='Debt Breakdown by Balance')
            st.plotly_chart(fig, use_container_width=True)


# NEW TAB 3: Education Funding
def education_funding_tab():
    """Education Funding and 529 Planning Tab"""
    st.header("ðŸŽ“ Education Funding Planner")

    st.markdown("""
    Plan for college expenses with 529 plans, Coverdell ESAs, and other education savings vehicles.
    Project costs and funding gaps for each child.
    """)

    # Ensure education variables are initialized (defensive programming for old sessions)
    if 'plan529_accounts' not in st.session_state:
        st.session_state.plan529_accounts = []
    if 'education_goals' not in st.session_state:
        st.session_state.education_goals = []
    if 'coverdell_esa' not in st.session_state:
        st.session_state.coverdell_esa = 0.0
    if 'utma_ugma_balance' not in st.session_state:
        st.session_state.utma_ugma_balance = 0.0

    # 529 Plan Management
    st.subheader("ðŸ’° 529 College Savings Plans")

    if st.button("âž• Add 529 Account"):
        new_529 = Plan529(
            name="529 Plan",
            beneficiary="Child 1",
            current_balance=5000.0,
            monthly_contribution=250.0,
            state="Seattle",
            investment_return=0.07,
            age_based_allocation=True,
            contribution_end_age=18
        )
        st.session_state.plan529_accounts.append(new_529)
        st.rerun()

    for idx, plan in enumerate(st.session_state.plan529_accounts):
        with st.expander(f"ðŸŽ“ {plan.name} - Beneficiary: {plan.beneficiary}"):
            col1, col2, col3 = st.columns([3, 3, 1])

            with col1:
                plan.name = st.text_input(f"Plan Name##529_{idx}", value=plan.name)
                plan.beneficiary = st.text_input(f"Beneficiary##529_{idx}", value=plan.beneficiary)
                plan.state = st.selectbox(
                    f"State (for tax deductions)##529_{idx}",
                    AVAILABLE_LOCATIONS_FAMILY[:7],  # US locations
                    index=AVAILABLE_LOCATIONS_FAMILY[:7].index(plan.state) if plan.state in AVAILABLE_LOCATIONS_FAMILY[:7] else 0
                )
                plan.age_based_allocation = st.checkbox(
                    f"Age-Based Asset Allocation##529_{idx}",
                    value=plan.age_based_allocation,
                    help="Automatically adjusts from aggressive to conservative as beneficiary ages"
                )

            with col2:
                plan.current_balance = st.number_input(
                    f"Current Balance##529_{idx}",
                    min_value=0.0,
                    value=float(plan.current_balance),
                    step=1000.0
                )
                plan.monthly_contribution = st.number_input(
                    f"Monthly Contribution##529_{idx}",
                    min_value=0.0,
                    value=float(plan.monthly_contribution),
                    step=50.0
                )
                plan.investment_return = st.number_input(
                    f"Expected Annual Return (%)##529_{idx}",
                    min_value=0.0,
                    max_value=20.0,
                    value=float(plan.investment_return * 100),
                    step=0.5
                ) / 100
                plan.contribution_end_age = st.number_input(
                    f"Stop Contributing at Age##529_{idx}",
                    min_value=0,
                    max_value=30,
                    value=int(plan.contribution_end_age),
                    step=1
                )

            with col3:
                if st.button(f"ðŸ—‘ï¸##529_{idx}"):
                    st.session_state.plan529_accounts.pop(idx)
                    st.rerun()

            st.session_state.plan529_accounts[idx] = plan

    # Education Goals
    st.subheader("ðŸŽ¯ Education Goals")

    if st.button("âž• Add Education Goal"):
        new_goal = EducationGoal(
            beneficiary="Child 1",
            institution_type="Public In-State",
            estimated_annual_cost=15000.0,
            years_of_college=4,
            start_year=st.session_state.current_year + 13,
            scholarship_amount=5000.0,
            grants_amount=2000.0,
            student_loans_allowed=False,
            max_parent_contribution=50000.0
        )
        st.session_state.education_goals.append(new_goal)
        st.rerun()

    for idx, goal in enumerate(st.session_state.education_goals):
        with st.expander(f"ðŸŽ“ {goal.beneficiary} - {goal.institution_type}"):
            col1, col2, col3 = st.columns([3, 3, 1])

            with col1:
                goal.beneficiary = st.text_input(f"Student Name##goal{idx}", value=goal.beneficiary)
                goal.institution_type = st.selectbox(
                    f"Institution Type##goal{idx}",
                    ["Public In-State", "Public Out-of-State", "Private", "Community College", "Trade School"],
                    index=["Public In-State", "Public Out-of-State", "Private", "Community College", "Trade School"].index(goal.institution_type) if goal.institution_type in ["Public In-State", "Public Out-of-State", "Private", "Community College", "Trade School"] else 0
                )
                goal.estimated_annual_cost = st.number_input(
                    f"Estimated Annual Cost (Today's Dollars)##goal{idx}",
                    min_value=0.0,
                    value=float(goal.estimated_annual_cost),
                    step=1000.0,
                    help="Total cost including tuition, room, board, books"
                )

            with col2:
                goal.years_of_college = st.number_input(
                    f"Years of College##goal{idx}",
                    min_value=1,
                    max_value=8,
                    value=int(goal.years_of_college),
                    step=1
                )
                goal.start_year = st.number_input(
                    f"College Start Year##goal{idx}",
                    min_value=st.session_state.current_year,
                    max_value=st.session_state.current_year + 50,
                    value=int(goal.start_year),
                    step=1
                )
                goal.scholarship_amount = st.number_input(
                    f"Expected Annual Scholarship##goal{idx}",
                    min_value=0.0,
                    value=float(goal.scholarship_amount),
                    step=500.0
                )
                goal.grants_amount = st.number_input(
                    f"Expected Annual Grants##goal{idx}",
                    min_value=0.0,
                    value=float(goal.grants_amount),
                    step=500.0
                )

            with col3:
                if st.button(f"ðŸ—‘ï¸##goal{idx}"):
                    st.session_state.education_goals.pop(idx)
                    st.rerun()

            goal.student_loans_allowed = st.checkbox(
                f"Student Loans Allowed##goal{idx}",
                value=goal.student_loans_allowed
            )
            goal.max_parent_contribution = st.number_input(
                f"Maximum Parent Contribution (Total)##goal{idx}",
                min_value=0.0,
                value=float(goal.max_parent_contribution),
                step=5000.0
            )

            st.session_state.education_goals[idx] = goal

    # Education Funding Summary
    if st.session_state.education_goals:
        st.subheader("ðŸ“Š Education Funding Summary")

        total_529_balance = sum([p.current_balance for p in st.session_state.plan529_accounts])
        total_education_need = sum([g.estimated_annual_cost * g.years_of_college for g in st.session_state.education_goals])
        total_scholarships_grants = sum([(g.scholarship_amount + g.grants_amount) * g.years_of_college for g in st.session_state.education_goals])

        net_need = total_education_need - total_scholarships_grants
        funding_gap = net_need - total_529_balance

        col1, col2, col3, col4 = st.columns(4)
        col1.metric("Total 529 Balance", format_currency(total_529_balance))
        col2.metric("Total Education Cost", format_currency(total_education_need))
        col3.metric("Scholarships & Grants", format_currency(total_scholarships_grants))
        col4.metric("Funding Gap", format_currency(funding_gap),
                   delta="Surplus" if funding_gap < 0 else "Deficit")


# NEW TAB 4: Tax Optimization
def tax_optimization_tab():
    """Tax Optimization Strategies Tab"""
    st.header("ðŸ’¼ Tax Optimization Strategies")

    st.markdown("""
    Implement tax-efficient strategies to minimize lifetime tax burden and maximize retirement income.
    Includes Roth conversions, tax-loss harvesting, charitable giving, and withdrawal sequencing.
    """)

    # Ensure tax variables are initialized (defensive programming for old sessions)
    if 'tax_strategies' not in st.session_state:
        st.session_state.tax_strategies = []
    if 'retirement_withdrawals' not in st.session_state:
        st.session_state.retirement_withdrawals = []
    if 'roth_conversion_amount' not in st.session_state:
        st.session_state.roth_conversion_amount = 0.0
    if 'charitable_contributions' not in st.session_state:
        st.session_state.charitable_contributions = 0.0
    if 'qcd_enabled' not in st.session_state:
        st.session_state.qcd_enabled = False
    if 'tax_bracket' not in st.session_state:
        st.session_state.tax_bracket = 0.22

    # Current Tax Situation
    st.subheader("ðŸ“Š Current Tax Situation")
    col1, col2, col3 = st.columns(3)
    with col1:
        tax_brackets = [0.10, 0.12, 0.22, 0.24, 0.32, 0.35, 0.37]
        try:
            bracket_index = tax_brackets.index(st.session_state.tax_bracket)
        except ValueError:
            # Default to 22% if current bracket is invalid
            bracket_index = 2

        st.session_state.tax_bracket = st.selectbox(
            "Federal Marginal Tax Bracket",
            tax_brackets,
            index=bracket_index,
            format_func=lambda x: f"{x*100:.0f}%"
        )
    with col2:
        st.session_state.state_tax_rate = st.number_input(
            "State Tax Rate (%)",
            min_value=0.0,
            max_value=15.0,
            value=float(st.session_state.state_tax_rate * 100),
            step=0.1
        ) / 100
    with col3:
        combined_rate = st.session_state.tax_bracket + st.session_state.state_tax_rate
        st.metric("Combined Marginal Rate", f"{combined_rate*100:.1f}%")

    # Tax Strategies
    st.subheader("ðŸ’¡ Tax Optimization Strategies")

    if st.button("âž• Add Tax Strategy"):
        new_strategy = TaxStrategy(
            name="New Strategy",
            strategy_type="Roth Conversion",
            annual_amount=10000.0,
            start_year=st.session_state.current_year,
            end_year=st.session_state.current_year + 10,
            estimated_tax_savings=0.0,
            notes=""
        )
        st.session_state.tax_strategies.append(new_strategy)
        st.rerun()

    for idx, strategy in enumerate(st.session_state.tax_strategies):
        with st.expander(f"ðŸ’¼ {strategy.name} ({strategy.strategy_type})"):
            col1, col2, col3 = st.columns([3, 3, 1])

            with col1:
                strategy.name = st.text_input(f"Strategy Name##tax{idx}", value=strategy.name)
                strategy.strategy_type = st.selectbox(
                    f"Strategy Type##tax{idx}",
                    ["Roth Conversion", "Tax Loss Harvesting", "Charitable Giving", "HSA Maximization",
                     "Qualified Charitable Distribution", "Tax Gain Harvesting", "Backdoor Roth"],
                    index=["Roth Conversion", "Tax Loss Harvesting", "Charitable Giving", "HSA Maximization",
                           "Qualified Charitable Distribution", "Tax Gain Harvesting", "Backdoor Roth"].index(strategy.strategy_type) if strategy.strategy_type in ["Roth Conversion", "Tax Loss Harvesting", "Charitable Giving", "HSA Maximization", "Qualified Charitable Distribution", "Tax Gain Harvesting", "Backdoor Roth"] else 0
                )
                strategy.annual_amount = st.number_input(
                    f"Annual Amount##tax{idx}",
                    min_value=0.0,
                    value=float(strategy.annual_amount),
                    step=1000.0,
                    help="Annual amount for this strategy"
                )

            with col2:
                strategy.start_year = st.number_input(
                    f"Start Year##tax{idx}",
                    min_value=st.session_state.current_year,
                    max_value=st.session_state.current_year + 50,
                    value=int(strategy.start_year),
                    step=1
                )
                strategy.end_year = st.number_input(
                    f"End Year##tax{idx}",
                    min_value=st.session_state.current_year,
                    max_value=st.session_state.current_year + 50,
                    value=int(strategy.end_year),
                    step=1
                )
                strategy.estimated_tax_savings = st.number_input(
                    f"Estimated Annual Tax Savings##tax{idx}",
                    min_value=0.0,
                    value=float(strategy.estimated_tax_savings),
                    step=100.0,
                    help="Estimated tax savings per year"
                )

            with col3:
                if st.button(f"ðŸ—‘ï¸##tax{idx}"):
                    st.session_state.tax_strategies.pop(idx)
                    st.rerun()

            strategy.notes = st.text_area(
                f"Notes##tax{idx}",
                value=strategy.notes,
                height=60,
                help="Additional notes about this strategy"
            )

            st.session_state.tax_strategies[idx] = strategy

    # Roth Conversion Ladder
    st.subheader("ðŸªœ Roth Conversion Ladder Planning")
    col1, col2 = st.columns(2)
    with col1:
        st.session_state.roth_conversion_amount = st.number_input(
            "Annual Roth Conversion Amount",
            min_value=0.0,
            value=float(st.session_state.roth_conversion_amount),
            step=1000.0,
            help="Amount to convert from Traditional IRA/401k to Roth IRA annually"
        )
    with col2:
        tax_on_conversion = st.session_state.roth_conversion_amount * st.session_state.tax_bracket
        st.metric("Estimated Tax on Conversion", format_currency(tax_on_conversion))

    st.info("ðŸ’¡ **Roth Conversion Strategy**: Convert traditional retirement accounts to Roth IRA in low-income years to minimize taxes and create tax-free retirement income.")

    # Charitable Giving
    st.subheader("â¤ï¸ Charitable Giving Strategies")
    col1, col2, col3 = st.columns(3)
    with col1:
        st.session_state.charitable_contributions = st.number_input(
            "Annual Charitable Contributions",
            min_value=0.0,
            value=float(st.session_state.charitable_contributions),
            step=500.0
        )
    with col2:
        st.session_state.qcd_enabled = st.checkbox(
            "Use QCD (Age 70Â½+)",
            value=st.session_state.qcd_enabled,
            help="Qualified Charitable Distribution from IRA (up to $105,000/year for 2025)"
        )
    with col3:
        if st.session_state.charitable_contributions > 0:
            tax_savings = st.session_state.charitable_contributions * st.session_state.tax_bracket
            st.metric("Estimated Tax Savings", format_currency(tax_savings))

    # Withdrawal Sequencing
    st.subheader("ðŸ’° Retirement Withdrawal Sequencing")

    st.markdown("""
    **Recommended Withdrawal Sequence** (Tax-Efficient):
    1. **RMDs (Required Minimum Distributions)** - Must take to avoid penalties
    2. **Taxable Accounts** - Long-term capital gains (lower rate)
    3. **Tax-Deferred (401k/IRA)** - Fill up to top of current tax bracket
    4. **Roth IRA** - Tax-free, save for last
    5. **HSA** - Tax-free for medical expenses, ultimate flexibility
    """)

    if st.button("âž• Add Planned Withdrawal"):
        new_withdrawal = RetirementWithdrawal(
            year=st.session_state.current_year,
            account_type="401k",
            amount=40000.0,
            tax_rate=0.22,
            purpose="Living Expenses"
        )
        st.session_state.retirement_withdrawals.append(new_withdrawal)
        st.rerun()

    for idx, withdrawal in enumerate(st.session_state.retirement_withdrawals):
        with st.expander(f"ðŸ’° Year {withdrawal.year} - {withdrawal.account_type}: {format_currency(withdrawal.amount)}"):
            col1, col2, col3 = st.columns([3, 3, 1])

            with col1:
                withdrawal.year = st.number_input(
                    f"Year##wd{idx}",
                    min_value=st.session_state.current_year,
                    max_value=st.session_state.current_year + 50,
                    value=int(withdrawal.year),
                    step=1
                )
                withdrawal.account_type = st.selectbox(
                    f"Account Type##wd{idx}",
                    ["401k", "Traditional IRA", "Roth IRA", "Taxable Brokerage", "HSA", "Pension"],
                    index=["401k", "Traditional IRA", "Roth IRA", "Taxable Brokerage", "HSA", "Pension"].index(withdrawal.account_type) if withdrawal.account_type in ["401k", "Traditional IRA", "Roth IRA", "Taxable Brokerage", "HSA", "Pension"] else 0
                )

            with col2:
                withdrawal.amount = st.number_input(
                    f"Withdrawal Amount##wd{idx}",
                    min_value=0.0,
                    value=float(withdrawal.amount),
                    step=1000.0
                )
                withdrawal.tax_rate = st.number_input(
                    f"Tax Rate (%)##wd{idx}",
                    min_value=0.0,
                    max_value=50.0,
                    value=float(withdrawal.tax_rate * 100),
                    step=1.0
                ) / 100

            with col3:
                if st.button(f"ðŸ—‘ï¸##wd{idx}"):
                    st.session_state.retirement_withdrawals.pop(idx)
                    st.rerun()

            withdrawal.purpose = st.text_input(f"Purpose##wd{idx}", value=withdrawal.purpose)

            after_tax_amount = withdrawal.amount * (1 - withdrawal.tax_rate)
            st.metric("After-Tax Amount", format_currency(after_tax_amount))

            st.session_state.retirement_withdrawals[idx] = withdrawal

    # Tax Savings Summary
    if st.session_state.tax_strategies:
        st.subheader("ðŸ“Š Tax Optimization Summary")

        total_annual_savings = sum([s.estimated_tax_savings for s in st.session_state.tax_strategies])
        total_strategies = len(st.session_state.tax_strategies)

        col1, col2 = st.columns(2)
        col1.metric("Active Tax Strategies", total_strategies)
        col2.metric("Estimated Annual Tax Savings", format_currency(total_annual_savings))


# NEW TAB 5: Report Export
def report_export_tab():
    """PDF/Excel Report Export Tab"""
    st.header("ðŸ“„ Export Financial Reports")

    st.markdown("""
    Generate comprehensive financial planning reports in PDF or Excel format.
    Share with financial advisors, partners, or keep for your records.
    """)

    # Report Configuration
    st.subheader("ðŸ“Š Report Configuration")

    col1, col2 = st.columns(2)
    with col1:
        report_name = st.text_input(
            "Report Name",
            value=f"Financial_Plan_{st.session_state.current_year}",
            help="Name for your exported report"
        )

        include_sections = st.multiselect(
            "Include Sections",
            ["Summary", "Income & Expenses", "Assets & Debts", "Children", "Healthcare",
             "Education", "Tax Strategies", "Monte Carlo Analysis", "Timeline"],
            default=["Summary", "Income & Expenses", "Assets & Debts", "Monte Carlo Analysis"]
        )

    with col2:
        report_format = st.selectbox(
            "Export Format",
            ["Excel (.xlsx)", "CSV (Multiple Files)", "JSON (Data Export)"],
            index=0
        )

        include_charts = st.checkbox(
            "Include Charts & Visualizations",
            value=True,
            help="Include Plotly charts as images (Excel only)"
        )

    # Generate Report Button
    st.subheader("ðŸ“¥ Generate Report")

    if st.button("ðŸš€ Generate Report", type="primary"):
        with st.spinner("Generating your financial report..."):
            try:
                # Prepare report data
                report_data = {
                    "metadata": {
                        "report_name": report_name,
                        "generated_date": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                        "current_year": st.session_state.current_year,
                        "planning_horizon": st.session_state.mc_years
                    },
                    "summary": {
                        "combined_net_worth": st.session_state.parentX_net_worth + st.session_state.parentY_net_worth,
                        "combined_income": st.session_state.parentX_income + st.session_state.parentY_income,
                        "total_expenses": sum(st.session_state.expenses.values()),
                        "num_children": len(st.session_state.children_list),
                        "num_houses": len(st.session_state.houses),
                        "total_debt": sum([d.principal for d in st.session_state.debts]),
                        "total_529_balance": sum([p.current_balance for p in st.session_state.plan529_accounts])
                    },
                    "parents": {
                        "parent1": {
                            "name": st.session_state.parent1_name,
                            "age": st.session_state.parentX_age,
                            "income": st.session_state.parentX_income,
                            "net_worth": st.session_state.parentX_net_worth,
                            "retirement_age": st.session_state.parentX_retirement_age,
                            "ss_benefit": st.session_state.parentX_ss_benefit
                        },
                        "parent2": {
                            "name": st.session_state.parent2_name,
                            "age": st.session_state.parentY_age,
                            "income": st.session_state.parentY_income,
                            "net_worth": st.session_state.parentY_net_worth,
                            "retirement_age": st.session_state.parentY_retirement_age,
                            "ss_benefit": st.session_state.parentY_ss_benefit
                        }
                    },
                    "expenses": st.session_state.expenses,
                    "children": [{"name": c["name"], "age": st.session_state.current_year - c["birth_year"], "birth_year": c["birth_year"]} for c in st.session_state.children_list],
                    "debts": [asdict(d) for d in st.session_state.debts],
                    "healthcare": {
                        "health_insurances": [asdict(h) for h in st.session_state.health_insurances],
                        "ltc_insurances": [asdict(l) for l in st.session_state.ltc_insurances],
                        "hsa_balance": st.session_state.hsa_balance
                    },
                    "education": {
                        "529_plans": [asdict(p) for p in st.session_state.plan529_accounts],
                        "goals": [asdict(g) for g in st.session_state.education_goals]
                    },
                    "tax_strategies": [asdict(t) for t in st.session_state.tax_strategies]
                }

                if report_format == "Excel (.xlsx)":
                    # Create Excel workbook
                    output = io.BytesIO()

                    with pd.ExcelWriter(output, engine='openpyxl') as writer:
                        # Summary Sheet
                        if "Summary" in include_sections:
                            summary_df = pd.DataFrame([report_data["summary"]]).T
                            summary_df.columns = ["Value"]
                            summary_df.to_excel(writer, sheet_name='Summary')

                        # Parents Sheet
                        if "Income & Expenses" in include_sections:
                            parents_df = pd.DataFrame(report_data["parents"]).T
                            parents_df.to_excel(writer, sheet_name='Parents')

                            expenses_df = pd.DataFrame([report_data["expenses"]]).T
                            expenses_df.columns = ["Annual Amount"]
                            expenses_df.to_excel(writer, sheet_name='Expenses')

                        # Debts Sheet
                        if "Assets & Debts" in include_sections and st.session_state.debts:
                            debts_df = pd.DataFrame(report_data["debts"])
                            debts_df.to_excel(writer, sheet_name='Debts', index=False)

                        # Children Sheet
                        if "Children" in include_sections and st.session_state.children_list:
                            children_df = pd.DataFrame(report_data["children"])
                            children_df.to_excel(writer, sheet_name='Children', index=False)

                        # Healthcare Sheet
                        if "Healthcare" in include_sections and st.session_state.health_insurances:
                            healthcare_df = pd.DataFrame(report_data["healthcare"]["health_insurances"])
                            healthcare_df.to_excel(writer, sheet_name='Healthcare', index=False)

                        # Education Sheet
                        if "Education" in include_sections and st.session_state.plan529_accounts:
                            education_df = pd.DataFrame(report_data["education"]["529_plans"])
                            education_df.to_excel(writer, sheet_name='Education_529', index=False)

                        # Tax Strategies Sheet
                        if "Tax Strategies" in include_sections and st.session_state.tax_strategies:
                            tax_df = pd.DataFrame(report_data["tax_strategies"])
                            tax_df.to_excel(writer, sheet_name='Tax_Strategies', index=False)

                    output.seek(0)

                    st.download_button(
                        label="ðŸ“¥ Download Excel Report",
                        data=output,
                        file_name=f"{report_name}.xlsx",
                        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                    )
                    st.success("âœ… Excel report generated successfully!")

                elif report_format == "JSON (Data Export)":
                    json_str = json.dumps(report_data, indent=2, default=str)

                    st.download_button(
                        label="ðŸ“¥ Download JSON Data",
                        data=json_str,
                        file_name=f"{report_name}.json",
                        mime="application/json"
                    )
                    st.success("âœ… JSON export generated successfully!")

                elif report_format == "CSV (Multiple Files)":
                    st.info("ðŸ“Š CSV export will generate multiple files. Download them separately:")

                    # Summary CSV
                    if "Summary" in include_sections:
                        summary_df = pd.DataFrame([report_data["summary"]]).T
                        summary_csv = summary_df.to_csv()
                        st.download_button(
                            "Download Summary.csv",
                            summary_csv,
                            f"{report_name}_summary.csv",
                            "text/csv"
                        )

                    # Debts CSV
                    if "Assets & Debts" in include_sections and st.session_state.debts:
                        debts_df = pd.DataFrame(report_data["debts"])
                        debts_csv = debts_df.to_csv(index=False)
                        st.download_button(
                            "Download Debts.csv",
                            debts_csv,
                            f"{report_name}_debts.csv",
                            "text/csv"
                        )

                    st.success("âœ… CSV files ready for download!")

            except Exception as e:
                st.error(f"âŒ Error generating report: {str(e)}")
                st.exception(e)

    # Report Preview
    st.subheader("ðŸ‘ï¸ Report Preview")

    with st.expander("View Summary Data"):
        col1, col2, col3 = st.columns(3)

        total_net_worth = st.session_state.parentX_net_worth + st.session_state.parentY_net_worth
        total_income = st.session_state.parentX_income + st.session_state.parentY_income
        total_expenses = sum(st.session_state.expenses.values())

        col1.metric("Combined Net Worth", format_currency(total_net_worth))
        col2.metric("Combined Annual Income", format_currency(total_income))
        col3.metric("Total Annual Expenses", format_currency(total_expenses))

        if st.session_state.debts:
            total_debt = sum([d.principal for d in st.session_state.debts])
            col1.metric("Total Debt", format_currency(total_debt))

        if st.session_state.plan529_accounts:
            total_529 = sum([p.current_balance for p in st.session_state.plan529_accounts])
            col2.metric("Total 529 Balance", format_currency(total_529))

        if st.session_state.children_list:
            col3.metric("Number of Children", len(st.session_state.children_list))


def display_sidebar():
    """Display sidebar with summary information"""
    with st.sidebar:
        st.title("ðŸ“Š Quick Summary")

        # Net Worth
        total_net_worth = st.session_state.parentX_net_worth + st.session_state.parentY_net_worth
        st.metric("Combined Net Worth", format_currency(total_net_worth))

        # Income
        total_income = st.session_state.parentX_income + st.session_state.parentY_income
        st.metric("Combined Annual Income", format_currency(total_income))

        # Expenses
        total_expenses = sum(st.session_state.expenses.values())
        st.metric("Annual Family Expenses", format_currency(total_expenses))

        # Children
        st.metric("Number of Children", len(st.session_state.children_list))

        # Houses
        st.metric("Number of Properties", len(st.session_state.houses))

        st.divider()

        # Portfolio Allocation
        st.subheader("Portfolio Mix")
        allocation = st.session_state.portfolio_allocation

        if allocation.is_valid():
            st.success("âœ… Balanced (100%)")
        else:
            st.error(f"âš ï¸ {allocation.total():.1f}%")

        st.write(f"ðŸ“ˆ Stocks: {allocation.stocks:.1f}%")
        st.write(f"ðŸ“Š Bonds: {allocation.bonds:.1f}%")
        st.write(f"ðŸ’µ Cash: {allocation.cash:.1f}%")
        st.write(f"ðŸ  RE: {allocation.real_estate:.1f}%")
        st.write(f"ðŸ”§ Other: {allocation.other:.1f}%")

        st.divider()

        # Active Scenario
        st.subheader("Active Scenario")
        st.info(st.session_state.active_scenario)

        # Current State
        current_state, current_strategy = get_state_for_year(st.session_state.current_year)
        st.subheader("Current Location")
        st.info(f"{current_state}\n{current_strategy}")


if __name__ == "__main__":
    main()
